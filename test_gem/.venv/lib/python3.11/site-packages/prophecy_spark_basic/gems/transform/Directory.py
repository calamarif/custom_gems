from prophecy.cb.server.base.ComponentBuilderBase import *
from prophecy.cb.ui.uispec import *
from pyspark.sql import *
from pyspark.sql.functions import *


class Directory(ComponentSpec):
    name: str = "Directory"
    category: str = "Custom"
    gemDescription: str = "Directory gem which give directory and file metadata"
    docUrl: str = "https://docs.prophecy.io/engineers/delta-table-operations/"

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class DirectoryProperties(ComponentProperties):
        path: str = ""
        includeSubDirs: bool = False
        filePattern: str = "*.*"

    def dialog(self) -> Dialog:
        return Dialog("Directory") \
            .addElement(
            StackLayout(gap=("1rem"), height=("100bh"), padding="3em")
            .addElement(TitleElement("Directory Tool Configuration"))
            .addElement(
                ColumnsLayout(gap="1em")
                .addColumn(
                    StackLayout(gap=("2rem"), height=("100bh"))
                    .addElement(Checkbox("Include Subdirectories (Recursively)")
                                .bindProperty("includeSubDirs"))
                    .addElement(TextBox("File Specification")
                                .bindPlaceholder("*.*")
                                .withHelpText("this filter is only applied on files")
                                .bindProperty("filePattern"))
                    , "2fr"
                )
                .addColumn(VerticalDivider(), width="content")
                .addColumn(TargetLocation("path"), "5fr")
            )
        )

    def validate(self, context: WorkflowContext, component: Component[DirectoryProperties]) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties
        if isBlank(props.path):
            diagnostics.append(
                Diagnostic("properties.path", "Directory path can not be empty", SeverityLevelEnum.Error))
        if isBlank(props.filePattern):
            diagnostics.append(
                Diagnostic("properties.filePattern", "File Pattern cannot be empty, Use '*.*' for global matching",
                           SeverityLevelEnum.Error))
        return diagnostics

    def onChange(self, context: WorkflowContext, oldState: Component[DirectoryProperties],
                 newState: Component[DirectoryProperties]) -> Component[DirectoryProperties]:
        return newState

    class DirectoryCode(ComponentCode):
        def __init__(self, newProps):
            self.props: Directory.DirectoryProperties = newProps

        def apply(self, spark: SparkSession) -> DataFrame:
            from prophecy.libs.utils import directory_listing
            df = directory_listing(spark, self.props.path, self.props.includeSubDirs, self.props.filePattern)
            return df
