from prophecy.cb.server.base.ComponentBuilderBase import *
from pyspark.sql import *
from pyspark.sql.functions import *

from prophecy.cb.server.base import WorkflowContext
from prophecy.cb.server.base.datatypes import SInt, SString
from prophecy.cb.ui.uispec import *

import dataclasses

class BulkColumnRename(ComponentSpec):
    name: str = "BulkColumnRename"
    category: str = "Transform"
    docUrl: str = "https://docs.prophecy.io/engineers/bulk-column-rename/"

    def optimizeCode(self) -> bool:
        # Return whether code optimization is enabled for this component
        return True

    @dataclass(frozen=True)
    class BulkColumnRenameProperties(ComponentProperties):
        # properties for the component with default values
        schema: Optional[StructType] = StructType([])
        columnNames: List[str] = field(default_factory=list)
        renameMethod: str = ""
        prefix: str = ""
        suffix: str = ""
        customExpression: SString = SString("")

    def dialog(self) -> Dialog:
        # Define the UI dialog structure for the component
        renameMethod = SelectBox("Select a method to rename columns").addOption("Add Prefix", "Add Prefix").addOption("Add Suffix", "Add Suffix").addOption("Custom Expression", "Custom Expression").bindProperty("renameMethod")
        dialog = Dialog("BulkColumnRename").addElement(ColumnsLayout(gap="1rem", height="100%").addColumn(Ports(), "content").addColumn(StackLayout(height="100%").addElement(renameMethod).addElement(SchemaColumnsDropdown("Select columns to rename").withMultipleSelection().bindSchema("schema").bindProperty("columnNames")).addElement(Condition().ifEqual(PropExpr("component.properties.renameMethod"), StringExpr("Add Prefix")).then(StackLayout().addElement(TextBox("Enter Prefix").bindPlaceholder("""Example: new_""").bindProperty("prefix")))).addElement(Condition().ifEqual(PropExpr("component.properties.renameMethod"), StringExpr("Add Suffix")).then(StackLayout().addElement(TextBox("Enter Suffix").bindPlaceholder("""Example: _new""").bindProperty("suffix")))).addElement(Condition().ifEqual(PropExpr("component.properties.renameMethod"), StringExpr("Custom Expression")).then(StackLayout().addElement(TextBox("Enter Custom Expression").bindPlaceholder("""Example: concat(column_name, 'xyz')""").bindProperty("customExpression"))))))

        return dialog

    def validate(self, context: WorkflowContext, component: Component[BulkColumnRenameProperties]):
        diagnostics = []

        if component.properties.renameMethod != "":
            if not component.properties.columnNames:
                diagnostics.append(Diagnostic(
                    "properties.columnNames",
                    "Columns cannot be empty",
                    SeverityLevelEnum.Error
                ))
            rename_method = component.properties.renameMethod
            if rename_method == "Add Prefix":
                if not component.properties.prefix:
                    diagnostics.append(Diagnostic(
                        "properties.prefix",
                        "Prefix cannot be empty",
                        SeverityLevelEnum.Error
                    ))
            elif rename_method == "Add Suffix":
                if not component.properties.suffix:
                    diagnostics.append(Diagnostic(
                        "properties.suffix",
                        "Suffix cannot be empty",
                        SeverityLevelEnum.Error
                    ))
            elif rename_method == "Custom Expression":
                if not component.properties.customExpression:
                    diagnostics.append(Diagnostic(
                        "properties.customExpression",
                        "Expression cannot be empty",
                        SeverityLevelEnum.Error
                    ))
            else:
                diagnostics.append(Diagnostic(
                    "properties.renameMethod",
                    "Invalid method to rename columns",
                    SeverityLevelEnum.Error
                ))
        else:
            diagnostics.append(Diagnostic(
                "properties.renameMethod",
                "Please select a method to rename columns.",
                SeverityLevelEnum.Error
            ))

        return diagnostics


    def onChange(self, context: WorkflowContext, oldState: Component[BulkColumnRenameProperties], newState: Component[BulkColumnRenameProperties]) -> Component[BulkColumnRenameProperties]:
        if len(newState.ports.inputs) == 1 and newState.ports.inputs[0].schema is not None and newState.ports.inputs[0].schema.fields is not None:
            newSchema = [field for field in newState.ports.inputs[0].schema.fields]
            newProperties = dataclasses.replace(newState.properties, schema=StructType(newSchema))
        else:
            newProperties = newState.properties
        return newState.bindProperties(newProperties)


    class BulkColumnRenameCode(ComponentCode):
        def __init__(self, newProps):
            self.props: BulkColumnRename.BulkColumnRenameProperties = newProps

        def apply(self, spark: SparkSession, in0: DataFrame) -> DataFrame:
            from pyspark.sql.functions import col, expr
            
            # Build the expression for renaming
            if self.props.renameMethod == "Add Prefix":
                expressionForRename = "concat('" + self.props.prefix + "', column_name)"
            elif self.props.renameMethod == "Add Suffix":
                expressionForRename = "concat(column_name, '" + self.props.suffix + "')"
            else:
                expressionForRename = self.props.customExpression
            
            # Create a mapping of old column names to new column names
            rename_mapping = {}
            for col_name in self.props.columnNames:
                if col_name in in0.columns:
                    # Evaluate the expression to get the new column name
                    temp_df = spark.createDataFrame([(col_name,)], ["column_name"])
                    new_name = temp_df.withColumn("new_name", expr(expressionForRename)).collect()[0]["new_name"]
                    rename_mapping[col_name] = new_name
            
            # Build expressions in the original column order from in0
            all_expressions = []
            
            for col_name in in0.columns:
                if col_name in rename_mapping:
                    # This column is being renamed
                    all_expressions.append(col(col_name).alias(rename_mapping[col_name]))
                else:
                    # This column remains unchanged
                    all_expressions.append(col(col_name))
            
            # Select all columns in original order
            return in0.select(*all_expressions)
