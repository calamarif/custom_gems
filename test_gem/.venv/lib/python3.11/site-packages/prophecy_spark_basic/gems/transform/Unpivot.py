from prophecy.cb.server.base.ComponentBuilderBase import *
from pyspark.sql import *
from pyspark.sql.functions import *

from prophecy.cb.server.base import WorkflowContext
from prophecy.cb.server.base.datatypes import SInt, SString
from prophecy.cb.ui.uispec import *


class Unpivot(ComponentSpec):
    name: str = "Unpivot"
    category: str = "Transform"
    docUrl: str = "https://docs.prophecy.io/engineers/unpivot/"

    def optimizeCode(self) -> bool:
        # Return whether code optimization is enabled for this component
        return True

    @dataclass(frozen=True)
    class UnpivotProperties(ComponentProperties):
        # properties for the component with default values
        columnsSelector: List[str] = field(default_factory=list)
        identifierColumns: List[str] = field(default_factory=list)
        columnsToUnpivot: List[str] = field(default_factory=list)
        variableColumnName: Optional[str] = None
        valueColumnName: Optional[str] = None
        selectColumnsIdentifier: str = "manual"
        selectColumnsToUnpivot: str = "manual"

    def dialog(self) -> Dialog:
        # Define the UI dialog structure for the component
        return Dialog("Unpivot")\
                .addElement(
                    ColumnsLayout(height=("100%"))
                        .addColumn(Ports(selectedFieldsProperty=("columnsSelector")), "content")
                        .addColumn(VerticalDivider(), width="content")
                        .addColumn(
                            StackLayout(gap=("1rem"), height=("100bh")) \
                            .addElement(
                                AlertBox(
                                    variant="info",
                                    _children=[
                                        Markdown(
                                            "Unpivot is supported on **Databricks runtime >=12.2** and **Spark Opensource >=3.4**"
                                        )
                                    ]
                                )
                            )
                            .addElement(TitleElement(title="Column(s) to use as identifiers"))
                            .addElement(
                                SelectBox("")
                                    .addOption("Select All", "selectall")
                                    .addOption("Select All (Not in unpivot) ", "notinunpivot")
                                    .addOption("Manual", "manual")
                                    .addOption("None", "none")
                                    .bindProperty("selectColumnsIdentifier")
                            )
                            .addElement(
                                Condition()
                                .ifEqual(PropExpr("component.properties.selectColumnsIdentifier"),StringExpr("manual"))
                                .then(
                                    SchemaColumnsDropdown("List of column(s)")
                                        .withMultipleSelection()
                                        .bindSchema("component.ports.inputs[0].schema")
                                        .bindProperty("identifierColumns")
                                        .showErrorsFor("identifierColumns")
                                )
                            )
                            .addElement(TitleElement(title="Column(s) to unpivot"))
                            .addElement(
                                SelectBox("")
                                    .addOption("Select All", "selectall")
                                    .addOption("Select All (Not in indentifier) ", "notinidentifier")
                                    .addOption("Manual", "manual")
                                    .bindProperty("selectColumnsToUnpivot")
                            )
                            .addElement(
                                Condition()
                                .ifEqual(PropExpr("component.properties.selectColumnsToUnpivot"),StringExpr("manual"))
                                .then(
                                    SchemaColumnsDropdown("List of column(s)")
                                        .withMultipleSelection()
                                        .bindSchema("component.ports.inputs[0].schema")
                                        .bindProperty("columnsToUnpivot")
                                        .showErrorsFor("columnsToUnpivot")
                                )
                            )
                            .addElement(TitleElement(title="Variable column name"))
                            .addElement(
                                    TextBox("").bindPlaceholder("Product").bindProperty("variableColumnName")
                                )
                            .addElement(TitleElement(title="Value column name"))
                            .addElement(
                                    TextBox("").bindPlaceholder("Sales").bindProperty("valueColumnName")
                                )
                        )
                )

    def validate(self, context: WorkflowContext, component: Component[UnpivotProperties]) -> List[Diagnostic]:
        # Validate the component's state
        diagnostics = []

        if component.properties.selectColumnsIdentifier == "notinunpivot" and component.properties.selectColumnsToUnpivot == "notinidentifier":
            diagnostics.append(Diagnostic(
                                f"properties.selectColumnsIdentifier",
                                "'Select All (Not in unpivot/indetifier)' can't be opted together for both Indentifiers & Unpivot column lists.",
                                SeverityLevelEnum.Error
                            ))

        if len(component.properties.columnsToUnpivot) == 0 and component.properties.selectColumnsToUnpivot == "manual":
            diagnostics.append(Diagnostic(
                                f"properties.columnsToUnpivot",
                                "List of columns to unpivot can't be empty.",
                                SeverityLevelEnum.Error
                            ))

        if component.properties.variableColumnName is None:
            diagnostics.append(Diagnostic(
                                f"properties.variableColumnName",
                                "Variable column name can't be empty.",
                                SeverityLevelEnum.Error
                            ))

        if component.properties.valueColumnName is None:
            diagnostics.append(Diagnostic(
                                f"properties.valueColumnName",
                                "Value column name can't be empty.",
                                SeverityLevelEnum.Error
                            ))

        return diagnostics

    def onChange(self, context: WorkflowContext, oldState: Component[UnpivotProperties], newState: Component[UnpivotProperties]) -> Component[
    UnpivotProperties]:
        # Handle changes in the component's state and return the new state
        return newState


    class UnpivotCode(ComponentCode):
        def __init__(self, newProps):
            self.props: Unpivot.UnpivotProperties = newProps

        def apply(self, spark: SparkSession, in0: DataFrame) -> DataFrame:
            if self.props.selectColumnsIdentifier == "none":
                identifier_columns = []
            elif self.props.selectColumnsIdentifier == "selectall":
                identifier_columns = in0.columns
            elif self.props.selectColumnsIdentifier == "notinunpivot":
                identifier_columns = [col for col in in0.columns if col not in self.props.columnsToUnpivot]
            else:
                identifier_columns = self.props.identifierColumns

            if self.props.selectColumnsToUnpivot == "selectall":
                columns_to_unpivot = in0.columns
            elif self.props.selectColumnsToUnpivot == "notinidentifier":
                columns_to_unpivot = [col for col in in0.columns if col not in self.props.identifierColumns]
            else:
                columns_to_unpivot = self.props.columnsToUnpivot           

            df = in0.unpivot(identifier_columns, columns_to_unpivot, self.props.variableColumnName, self.props.valueColumnName)
            return df
