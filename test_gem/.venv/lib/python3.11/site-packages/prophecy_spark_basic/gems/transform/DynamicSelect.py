from prophecy.cb.server.base.ComponentBuilderBase import *
from prophecy.cb.ui.uispec import *
from pyspark.sql import *
from pyspark.sql.functions import *
from prophecy.cb.server.base.datatypes import SInt, SString
import dataclasses


class DynamicSelect(ComponentSpec):
    name: str = "DynamicSelect"
    category: str = "Transform"
    gemDescription: str = "DynamicSelect gem which allows us to select column using type or expression"
    docUrl: str = "https://docs.prophecy.io/engineers/dynamic-select/"

    def optimizeCode(self) -> bool:
        return False  # TODO: this is failing with True

    @dataclass(frozen=True)
    class DynamicSelectProperties(ComponentProperties):
        selectUsing: str = "SELECT_FIELD_TYPES"
        # DATA TYPES
        boolTypeChecked: bool = False
        strTypeChecked: bool = False
        intTypeChecked: bool = False
        shortTypeChecked: bool = False
        byteTypeChecked: bool = False
        longTypeChecked: bool = False
        floatTypeChecked: bool = False
        doubleTypeChecked: bool = False
        decimalTypeChecked: bool = False
        binaryTypeChecked: bool = False
        dateTypeChecked: bool = False
        timestampTypeChecked: bool = False
        structTypeChecked: bool = False

        # custom expression
        customExpression: Optional[SString] = None

    def dialog(self) -> Dialog:
        return Dialog("DynamicSelect").addElement(
            ColumnsLayout(("1rem"), alignY=("end"))
            .addColumn(Ports(selectedFieldsProperty=("columnsSelector")), "content")
            .addColumn(VerticalDivider(), width="content")
            .addColumn(
                StackLayout(gap=("1rem"), width="50%", height=("100bh"))
                .addElement(TitleElement("Configuration"))
                .addElement(
                    SelectBox("")
                    .addOption("Select field types", "SELECT_FIELD_TYPES")
                    .addOption("Select via expression", "SELECT_EXPR")
                    .bindProperty("selectUsing")
                )
                .addElement(
                    Condition()
                    .ifEqual(
                        PropExpr("component.properties.selectUsing"),
                        StringExpr("SELECT_FIELD_TYPES"),
                    )
                    .then(
                        StackLayout(gap=("1rem"), width="50%", height=("100bh"))
                        .addElement(TitleElement("Select Field types"))
                        .addElement(Checkbox("Boolean", "boolTypeChecked"))
                        .addElement(Checkbox("String", "strTypeChecked"))
                        .addElement(Checkbox("Integer", "intTypeChecked"))
                        .addElement(Checkbox("Short", "shortTypeChecked"))
                        .addElement(Checkbox("Byte", "byteTypeChecked"))
                        .addElement(Checkbox("Long", "longTypeChecked"))
                        .addElement(Checkbox("Float", "floatTypeChecked"))
                        .addElement(Checkbox("Double", "doubleTypeChecked"))
                        .addElement(Checkbox("Decimal", "decimalTypeChecked"))
                        .addElement(Checkbox("Binary", "binaryTypeChecked"))
                        .addElement(Checkbox("Date", "dateTypeChecked"))
                        .addElement(Checkbox("Timestamp", "timestampTypeChecked"))
                        .addElement(Checkbox("Struct", "structTypeChecked"))
                    )
                    .otherwise(
                        StackLayout()
                        .addElement(
                            ExpressionBox("Enter Custom SQL Expression", language="sql", ignoreTitle=True)
                            .withSchemaSuggestions()
                            .bindPlaceholder(
                                """contains(column_name, 'user')""")
                            .bindProperty("customExpression")
                        )
                        .addElement(
                            AlertBox(
                                variant="success",
                                _children=[
                                    Markdown(
                                        "We can use following metadata columns in our expressions"
                                        "\n"
                                        "* **column_name** - Name of column, eg. name, country\n"
                                        "* **column_type** - Type of column, eg. string, int\n"
                                        "* **column_size** - Size of column in bytes, eg. int -> 4, boolean -> 1 (-1 "
                                        "for undefined)\n"
                                        "* **field_number** - Index of column in dataframe, eg. 0 for first column\n"
                                    )
                                ]
                            )
                        )
                    )
                )
            )

        )

    def validate(self, context: WorkflowContext, component: Component[DynamicSelectProperties]) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties

        if props.selectUsing != "SELECT_FIELD_TYPES" and props.customExpression is None:
            diagnostics.append(
                Diagnostic("properties.customExpression", "Custom column filter expression can not be empty",
                           SeverityLevelEnum.Error))

        return diagnostics

    def onChange(self, context: WorkflowContext, oldState: Component[DynamicSelectProperties],
                 newState: Component[DynamicSelectProperties]) -> Component[
        DynamicSelectProperties]:
        return newState

    class DynamicSelectCode(ComponentCode):
        def __init__(self, newProps):
            self.props: DynamicSelect.DynamicSelectProperties = newProps

        def apply(self, spark: SparkSession, in0: DataFrame) -> DataFrame:
            if self.props.selectUsing == "SELECT_FIELD_TYPES":
                desired_types = []
                type_mapping = {
                    'strTypeChecked': "string",
                    'intTypeChecked': "int",
                    'boolTypeChecked': "boolean",
                    'shortTypeChecked': "short",
                    'byteTypeChecked': "byte",
                    'longTypeChecked': "long",
                    'floatTypeChecked': "float",
                    'doubleTypeChecked': "double",
                    'decimalTypeChecked': "decimal",
                    'binaryTypeChecked': "binary",
                    'dateTypeChecked': "date",
                    'timestampTypeChecked': "timestamp",
                    'structTypeChecked': "struct"
                }
                for prop, type_name in type_mapping.items():
                    if getattr(self.props, prop):
                        desired_types.append(type_name)

                from prophecy.libs.utils import filter_columns_by_type
                return filter_columns_by_type(spark, in0, ",".join(desired_types))
            else:
                from prophecy.libs.utils import filter_columns_by_expr
                return filter_columns_by_expr(spark, in0, self.props.customExpression)
