from pyspark.sql import *

from prophecy.cb.server.base.ComponentBuilderBase import *
from prophecy.cb.ui.uispec import *
from prophecy.cb.util.StringUtils import isBlank
from prophecy.cb.server.base import WorkflowContext

class FileOperation(ComponentSpec):
    name: str = "FileOperation"
    category: str = "Custom"
    gemDescription: str = "Helps perform file operations like copy and move on different file systems"
    docUrl: str = "https://docs.prophecy.io/engineers/file-operation/"

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class FileOperationProperties(ComponentProperties):
        operation: str = "copy"
        source: str = ""
        destination: str = ""
        filesystem: str = "dbfs"
        recurse: bool = False
        fileRegex: Optional[str] = None
        ignoreEmptyFiles: Optional[bool] = False
        gcpJsonKeyPath: SecretValue = field(default_factory=list)

    def dialog(self) -> Dialog:
        fsSelectBox = (SelectBox("File System")
                       .addOption("Local", "local")
                       .addOption("DBFS", "dbfs")
                       .addOption("S3 - Boto3", "s3")
                       .addOption("GS - Google Storage", "gs")
                       .bindProperty("filesystem"))

        selectBox = Condition() \
            .ifEqual(PropExpr("component.properties.filesystem"), StringExpr("s3")) \
            .then(SelectBox("Operation")
                  .addOption("Copy", "copy")
                  .addOption("Move", "move")
                  .addOption("Sync", "sync")
                  .bindProperty("operation")) \
            .otherwise(
                Condition() \
                .ifEqual(PropExpr("component.properties.filesystem"), StringExpr("gs")) \
                            .then(SelectBox("Operation")
                  .addOption("Copy", "copy")
                  .addOption("Move", "move")
                  .addOption("Sync", "sync")
                  .bindProperty("operation")) \
                .otherwise(
                SelectBox("Operation")
                       .addOption("Copy", "copy")
                       .addOption("Move", "move")
                       .bindProperty("operation")
                )
            )
        return Dialog("FileOperation") \
            .addElement(ColumnsLayout(gap="1rem", height="100%")
                        .addColumn(StackLayout(height="100%")
                                   .addElement(fsSelectBox)
                                   .addElement(ColumnsLayout(gap="1rem", alignY="start")
                                               .addColumn(selectBox)
                                               .addColumn(Condition()
                                                          .ifEqual(PropExpr("component.properties.filesystem"),
                                                                   StringExpr("s3"))
                                                          .then(
                                                              TextBox("Filename Regex", placeholder="Eg: .*stderr.*\.txt").bindProperty("fileRegex")
                                                            )
                                                          .otherwise(
                                                              Condition()
                                                                .ifEqual(PropExpr("component.properties.filesystem"),
                                                                        StringExpr("gs"))
                                                                .then(
                                                                    TextBox("Filename Regex", placeholder="Eg: .*stderr.*\.txt").bindProperty("fileRegex")
                                                                    )
                                                                .otherwise(Checkbox("Recurse").bindProperty("recurse"))
                                                            )
                                                          )
                                               .addColumn(Condition()
                                                          .ifEqual(PropExpr("component.properties.filesystem"),
                                                                   StringExpr("s3"))
                                                          .then(Checkbox("Ignore empty files")
                                                                .bindProperty("ignoreEmptyFiles"))
                                                          .otherwise(
                                                              Condition()
                                                                .ifEqual(PropExpr("component.properties.filesystem"),
                                                                        StringExpr("gs"))
                                                                .then(Checkbox("Ignore empty files")
                                                                        .bindProperty("ignoreEmptyFiles"))
                                                          )
                                                    )
                                               )
                                    .addElement(
                                        Condition()
                                            .ifEqual(PropExpr("component.properties.filesystem"),
                                                    StringExpr("gs"))
                                            .then(SecretBox("GCP JSON Key File Path").bindPlaceholder("/dbfs/FileStore/data_engg/private_key_459e7f284776.json").bindProperty("gcpJsonKeyPath"))
                                    )
                                    .addElement(
                                        Condition()
                                            .ifEqual(PropExpr("component.properties.filesystem"),
                                                    StringExpr("gs"))
                                            .then(
                                                AlertBox(
                                                    variant="info",
                                                    _children=[
                                                        Markdown(
                                                            "This Gem has the following requirement(s): (1) Configure the [google-cloud-storage](https://pypi.org/project/google-cloud-storage/) PyPi dependency on the Spark cluster and (2) either provide the **\"GCP JSON Key File Path\"** in the pipeline settings, or set the following properties on the Spark cluster:\n"
                                                            "* **spark.hadoop.google.cloud.auth.service.account.enable**=**True**\n"
                                                            "* **spark.hadoop.google.cloud.auth.service.account.json.keyfile**=**<json_key_file_path>**"
                                                        )
                                                    ]
                                                )
                                            ).otherwise(
                                                Condition()
                                                .ifEqual(PropExpr("component.properties.filesystem"),
                                                        StringExpr("s3"))
                                                .then(
                                                    AlertBox(
                                                        variant="info",
                                                        _children=[
                                                            Markdown(
                                                                "This Gem has the following requirement(s): Configure the [boto3](https://pypi.org/project/boto3/) PyPi dependency on the Spark cluster"
                                                            )
                                                        ]
                                                    )                                                        
                                                )
                                            )
                                    )
                                    .addElement(
                                        Condition()
                                            .ifEqual(PropExpr("component.properties.filesystem"),
                                                    StringExpr("local"))
                                            .then(TextBox("Source Path", placeholder="Eg: /dbfs/Prophecy/test.csv")
                                                .bindProperty("source"))
                                            .otherwise(
                                                Condition()
                                                .ifEqual(PropExpr("component.properties.filesystem"),
                                                        StringExpr("s3"))
                                                .then(
                                                    TextBox("Source Path", placeholder="Eg: s3://Prophecy/test.csv")
                                                    .bindProperty("source"))
                                                .otherwise(
                                                        Condition()
                                                        .ifEqual(PropExpr("component.properties.filesystem"),
                                                                StringExpr("gs"))
                                                        .then(
                                                            TextBox("Source Path", placeholder="Eg: gs://Prophecy/test.csv")
                                                            .bindProperty("source"))
                                                        .otherwise(
                                                            TextBox("Source Path", placeholder="Eg: dbfs:/Prophecy/test.csv")
                                                            .bindProperty("source"))
                                                )
                                            )
                                    )
                                   .addElement(Condition()
                                               .ifEqual(PropExpr("component.properties.filesystem"),
                                                        StringExpr("local"))
                                               .then(TextBox("Destination Path",
                                                             placeholder="Eg: /dbfs/Prophecy/destination/test.csv")
                                                     .bindProperty("destination"))
                                               .otherwise(Condition()
                                                          .ifEqual(PropExpr("component.properties.filesystem"),
                                                                   StringExpr("s3"))
                                                          .then(TextBox("Destination Path",
                                                                        placeholder="Eg: s3://Prophecy/destination/test.csv")
                                                                .bindProperty("destination"))
                                                          .otherwise(
                                                                Condition()
                                                                .ifEqual(PropExpr("component.properties.filesystem"),
                                                                        StringExpr("gs"))
                                                                .then(TextBox("Destination Path",
                                                                                placeholder="Eg: gs://Prophecy/destination/test.csv")
                                                                        .bindProperty("destination"))
                                                                .otherwise(                                                              
                                                                    TextBox("Destination Path",
                                                                                    placeholder="Eg: dbfs:/Prophecy/destination/test.csv")
                                                                            .bindProperty("destination")
                                                                )
                                                            ))),
                                   "2fr")
                        )

    def validate(self, context: WorkflowContext, component: Component[FileOperationProperties]) -> List[Diagnostic]:
        diagnostics = []
        # if component.properties.filesystem == "gs" and not component.properties.gcpJsonKeyPath.parts:
        #     diagnostics.append(Diagnostic("properties.gcpJsonKeyPath", "GSP JSON key file path cannot be empty [Location]",
        #                                   SeverityLevelEnum.Error))
            
        if component.properties.source is None or component.properties.source == "":
            diagnostics.append(
                Diagnostic("properties.source", "Source path has to be specified",
                           SeverityLevelEnum.Error))
        if component.properties.destination is None or component.properties.destination == "":
            diagnostics.append(
                Diagnostic("properties.destination", "Destination path has to be specified",
                           SeverityLevelEnum.Error))
            
        # if isBlank(component.properties.source):
        #     diagnostics.append(
        #         Diagnostic("properties.source", "Source path has to be specified",
        #                    SeverityLevelEnum.Error))
        # if isBlank(component.properties.destination):
        #     diagnostics.append(
        #         Diagnostic("properties.destination", "Destination path has to be specified",
        #                    SeverityLevelEnum.Error))
        return diagnostics

    def onChange(self, context: WorkflowContext, oldState: Component[FileOperationProperties], newState: Component[FileOperationProperties]) -> \
            Component[FileOperationProperties]:
        return newState

    class FileOperationCode(ComponentCode):
        def __init__(self, newProps):
            self.props: FileOperation.FileOperationProperties = newProps

        def apply(self, spark: SparkSession):
            source = self.props.source
            dest = self.props.destination
            if not 'SColumnExpression' in locals():
                if self.props.filesystem == "local":
                    import os
                    import shutil
                    if self.props.operation == "move":
                        if self.props.recurse:
                            shutil.copytree(source,os.path.join(dest, os.path.basename(source)), dirs_exist_ok=True)
                            shutil.rmtree(source)
                            if(os.path.basename(source).strip() == ''):
                                os.makedirs(source)
                        else:
                            shutil.move(source, dest)
                    if self.props.operation == "copy":
                        if self.props.recurse:
                            shutil.copytree(source,os.path.join(dest, os.path.basename(source)), dirs_exist_ok=True)
                        else:
                            shutil.copy2(source, dest)
                elif self.props.filesystem == "dbfs":
                    from pyspark.dbutils import DBUtils
                    dbutils = DBUtils(spark)
                    if self.props.operation == "move":
                        dbutils.fs.mv(source, dest, recurse=self.props.recurse)
                    if self.props.operation == "copy":
                        dbutils.fs.cp(source, dest, recurse=self.props.recurse)
                elif self.props.filesystem == "s3":
                    import re
                    import boto3
                    from urllib.parse import urlparse
                    from botocore.exceptions import ClientError

                    mode = self.props.operation
                    fileRegex = self.props.fileRegex
                    ignoreEmptyFiles = self.props.ignoreEmptyFiles
                    src_url: SubstituteDisabled = urlparse(self.props.source)
                    dest_url: SubstituteDisabled = urlparse(self.props.destination)
                    src_bucket = src_url.netloc
                    src_prefix = src_url.path.lstrip('/')
                    dest_bucket = dest_url.netloc
                    dest_prefix = dest_url.path.lstrip('/')

                    s3 = boto3.client("s3")
                    for obj in s3.list_objects_v2(Bucket=src_bucket, Prefix=src_url.path.lstrip('/'))['Contents']:
                        new_dest_prefix = re.sub(src_prefix, dest_prefix, obj['Key'], 1)
                        src_details = s3.head_object(Bucket=src_bucket, Key=obj['Key'])
                        if mode in ['copy', 'move', 'sync'] and not obj['Key'].endswith("/"):
                            if mode == 'sync':
                                try:
                                    dest_details = s3.head_object(Bucket=dest_bucket, Key=new_dest_prefix)
                                except ClientError as e:
                                    if e.response['Error']['Code'] == "404":
                                        dest_details = None
                                    else:
                                        raise e
                            if (bool(ignoreEmptyFiles) and src_details['ContentLength'] == 0) or (
                                    bool(fileRegex) and fileRegex != "" and not bool(
                                    re.compile(fileRegex).match(obj['Key']))) or (
                                    mode == "sync" and bool(dest_details) and src_details['LastModified'] <=
                                    dest_details['LastModified']):
                                continue
                            s3.copy({'Bucket': src_bucket, 'Key': obj['Key']}, dest_bucket, new_dest_prefix)
                            if mode == "move":
                                s3.delete_object(Bucket=src_bucket, Key=obj['Key'])
                elif self.props.filesystem == "gs":
                    import re
                    from google.cloud import storage
                    from google.oauth2 import service_account
                    from google.api_core.exceptions import NotFound
                    from urllib.parse import urlparse
                    
                    mode = self.props.operation
                    fileRegex = self.props.fileRegex
                    ignoreEmptyFiles = self.props.ignoreEmptyFiles                    
                    src_url: SubstituteDisabled = urlparse(self.props.source)
                    dest_url: SubstituteDisabled = urlparse(self.props.destination)
                    src_bucket_name = src_url.netloc
                    src_prefix = src_url.path.lstrip('/')
                    dest_bucket_name = dest_url.netloc
                    dest_prefix = dest_url.path.lstrip('/')
                    
                    if self.props.gcpJsonKeyPath is not None or self.props.gcpJsonKeyPath != "":
                        spark.conf.set("spark.hadoop.google.cloud.auth.service.account.enable", "true")
                        spark.conf.set("spark.hadoop.google.cloud.auth.service.account.json.keyfile",f"{self.props.gcpJsonKeyPath}")
                    
                    credentials_file = spark.conf.get("spark.hadoop.google.cloud.auth.service.account.json.keyfile")
                    credentials = service_account.Credentials.from_service_account_file(credentials_file)
                    storage_client: SubstituteDisabled = storage.Client(credentials=credentials)
                    
                    src_bucket = storage_client.bucket(src_bucket_name)
                    dest_bucket = storage_client.bucket(dest_bucket_name)

                    blobs = storage_client.list_blobs(src_bucket_name, prefix=src_prefix)

                    for blob in blobs:
                        new_dest_prefix = re.sub(src_prefix, dest_prefix, blob.name, 1)
                        src_blob = src_bucket.get_blob(blob.name)

                        if mode in ['copy', 'move', 'sync'] and not blob.name.endswith("/"):
                            dest_blob = dest_bucket.blob(new_dest_prefix)

                            if mode == 'sync':
                                try:
                                    dest_blob.reload()
                                except NotFound:
                                    dest_blob = None

                            if (bool(ignoreEmptyFiles) and src_blob.size == 0) or (
                                bool(fileRegex) and fileRegex != "" and not re.match(fileRegex, blob.name)) or (
                                mode == "sync" and dest_blob and src_blob.updated <= dest_blob.updated):
                                continue

                            new_blob = dest_bucket.blob(new_dest_prefix)
                            new_blob.rewrite(src_blob)

                            if mode == "move":
                                src_blob.delete()