import dataclasses

from prophecy.cb.server.base.ComponentBuilderBase import *
from prophecy.cb.ui.uispec import *
from pyspark.sql import *


class DataCleansing(ComponentSpec):
    name: str = "DataCleansing"
    category: str = "Transform"
    gemDescription: str = "Helps perform data cleaning operations"
    docUrl: str = "https://docs.prophecy.io/engineers/data-cleansing/"

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class DataCleansingProperties(ComponentProperties):
        schema: Optional[StructType] = StructType([])
        null_operation: str = ""
        columnNames: List[str] = field(default_factory=list)

        # clean checks
        replaceNullTextFields: bool = False
        replaceNullTextWith: str = "NA"
        replaceNullForNumericFields: bool = False
        replaceNullNumericWith: int = 0
        trimWhiteSpace: bool = False
        removeTabsLineBreaksAndDuplicateWhitespace: bool = False
        allWhiteSpace: bool = False
        cleanLetters: bool = False
        cleanPunctuations: bool = False
        cleanNumbers: bool = False
        makeLowercase: bool = False
        makeUppercase: bool = False
        makeTitlecase: bool = False

    def dialog(self) -> Dialog:
        nullOpSelectBox = (SelectBox("")
                           .addOption("1. Keep all rows and columns", "keep_all")
                           .addOption("2. Remove rows with null in every column", "remove_row_null_all_cols")
                           .addOption("3. Remove columns with null in every row", "remove_col_null_all_rows")
                           .addOption("4. Remove both empty rows and columns (both 2 and 3)",
                                      "remove_empty_rows_cols")
                           .bindProperty("null_operation"))

        selectCol = (SchemaColumnsDropdown("Select columns you want to clean").withMultipleSelection()
                     .bindSchema("schema").bindProperty("columnNames").showErrorsFor("columnNames"))

        options = (StackLayout(gap="2em")
        .addElement(TitleElement("Clean data"))
        .addElement(
            AlertBox(
                variant="warning",
                _children=[
                    Markdown(
                        "Following operations are only applicable on string columns\n"
                        "Examples - \n"
                        "* **Trim whitespaces** - ' hello prophecy ' => 'hello prophecy'\n"
                        "* **Remove numbers** - 'hello 123 prophecy' => 'hello prophecy'\n"
                        "* **Make titlecase** - 'hello prophecy' => 'Hello Prophecy'\n"
                    )
                ]
            )
        )
        .addElement(
            ColumnsLayout(gap="1rem", height="100%")
            .addColumn(Checkbox("Trim whitespaces").bindProperty("trimWhiteSpace"), "1fr")
            .addColumn(Checkbox("Remove tabs, line breaks and duplicate whitespace").bindProperty(
                "removeTabsLineBreaksAndDuplicateWhitespace"), "2fr")
            .addColumn(Checkbox("Remove all whitespaces").bindProperty("allWhiteSpace"), "1fr")
        )
        .addElement(
            ColumnsLayout(gap="1rem", height="100%")
            .addColumn(Checkbox("Remove letters").bindProperty("cleanLetters"), "1fr")
            .addColumn(Checkbox("Remove punctuations").bindProperty("cleanPunctuations"), "2fr")
            .addColumn(Checkbox("Remove numbers").bindProperty("cleanNumbers"), "1fr")
        )
        .addElement(
            ColumnsLayout(gap="1rem", height="100%")
            .addColumn(Checkbox("Make lowercase").bindProperty("makeLowercase"), "1fr")
            .addColumn(Checkbox("Make uppercase").bindProperty("makeUppercase"), "2fr")
            .addColumn(Checkbox("Make titlecase").bindProperty("makeTitlecase"), "1fr")
        ))
        custom_schema_alert = AlertBox(
            variant="success",
            _children=[
                Markdown(
                    "The input schema of dataframe can change if a column is removed, please enable **custom schema**\n "
                    "Switch is available at bottom left in **output** tab\n"
                )
            ]
        )
        return Dialog("DataCleansing") \
            .addElement(
            ColumnsLayout(gap="1rem", height="100%")
            .addColumn(Ports(), "content")
            .addColumn(
                StackLayout()
                .addElement(TitleElement("Remove Null Data"))
                .addElement(nullOpSelectBox)
                .addElement(selectCol)
                .addElement(
                        Condition()
                        .ifEqual(
                            PropExpr("component.properties.null_operation"),
                            StringExpr("remove_col_null_all_rows"),
                        )
                        .then(
                            custom_schema_alert
                        )
                )
                .addElement(
                    Condition()
                    .ifEqual(
                        PropExpr("component.properties.null_operation"),
                        StringExpr("remove_empty_rows_cols"),
                    )
                    .then(
                        custom_schema_alert
                    )
                )
                .addElement(TitleElement("Replace Null values in Column"))
                .addElement(
                    Checkbox("Replace Null for String/Text fields").bindProperty("replaceNullTextFields")
                )
                .addElement(
                    Condition()
                    .ifEqual(
                        PropExpr("component.properties.replaceNullTextFields"),
                        BooleanExpr(True),
                    )
                    .then(
                        TextBox("Value to replace String/Text field", placeholder="NA")
                        .bindProperty("replaceNullTextWith"),
                    )
                )
                .addElement(
                    Checkbox("Replace Null for Numeric fields").bindProperty("replaceNullForNumericFields")
                )
                .addElement(
                    Condition()
                    .ifEqual(
                        PropExpr("component.properties.replaceNullForNumericFields"),
                        BooleanExpr(True),
                    )
                    .then(
                        NumberBox("Value to replace Numeric field", placeholder="0")
                        .bindProperty("replaceNullNumericWith"),
                    )
                )
                .addElement(options)
            )
        )

    def validate(self, context: WorkflowContext, component: Component[DataCleansingProperties]) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties
        if isBlank(props.null_operation):
            diagnostics.append(Diagnostic(
                "properties.null_operation",
                "Please select Remove Null Data Operation",
                SeverityLevelEnum.Error
            ))

        if props.columnNames is None or len(props.columnNames) == 0:
            diagnostics.append(Diagnostic(
                "properties.columnNames",
                "At least one column needs to be selected",
                SeverityLevelEnum.Error
            ))
        return diagnostics

    def onChange(self, context: WorkflowContext, oldState: Component[DataCleansingProperties],
                 newState: Component[DataCleansingProperties]) -> Component[DataCleansingProperties]:
        if (len(newState.ports.inputs) == 1 and newState.ports.inputs[0].schema is not None
                and newState.ports.inputs[0].schema.fields is not None):
            newSchema = [field for field in newState.ports.inputs[0].schema.fields]
            newProperties = dataclasses.replace(newState.properties, schema=StructType(newSchema))
        else:
            newProperties = newState.properties
        return newState.bindProperties(newProperties)

    class DataCleansingCode(ComponentCode):
        def __init__(self, newProps):
            self.props: DataCleansing.DataCleansingProperties = newProps

        def apply(self, spark: SparkSession, df: DataFrame) -> DataFrame:
            from pyspark.sql.functions import col, trim, regexp_replace, lower, upper, initcap
            from pyspark.sql.types import StringType, IntegerType, FloatType, DoubleType, LongType, ShortType

            # Extract all properties outside loops to avoid schema analysis issues
            null_operation = self.props.null_operation
            column_names = self.props.columnNames
            replace_null_text_fields = self.props.replaceNullTextFields
            replace_null_text_with = self.props.replaceNullTextWith
            replace_null_numeric_fields = self.props.replaceNullForNumericFields
            replace_null_numeric_with = self.props.replaceNullNumericWith
            trim_whitespace = self.props.trimWhiteSpace
            remove_tabs_linebreaks = self.props.removeTabsLineBreaksAndDuplicateWhitespace
            all_whitespace = self.props.allWhiteSpace
            clean_letters = self.props.cleanLetters
            clean_punctuations = self.props.cleanPunctuations
            clean_numbers = self.props.cleanNumbers
            make_lowercase = self.props.makeLowercase
            make_uppercase = self.props.makeUppercase
            make_titlecase = self.props.makeTitlecase

            # Step 1: Handle null_operation flag
            if null_operation == "remove_row_null_all_cols":
                # Remove rows where all columns are null
                df = df.na.drop(how="all")

            elif null_operation == "remove_col_null_all_rows":
                # Remove columns where all rows are null
                try:
                    non_empty_cols = [col_name for col_name in df.columns if
                                    df.filter(df[col_name].isNotNull()).count() > 0]
                    df = df.select(*non_empty_cols)
                except Exception as e:
                    print("Error while running Remove columns where all rows are null")

            elif null_operation == "remove_empty_rows_cols":
                # Remove rows where all columns are null
                df = df.na.drop(how="all")
                # Remove columns where all rows are null
                try:
                    non_empty_cols = [col_name for col_name in df.columns if
                                    df.filter(df[col_name].isNotNull()).count() > 0]
                    df = df.select(*non_empty_cols)
                except:
                    print("Error while running Remove columns where all rows are null")

            # Step 2: Apply data cleansing operations
            # Create a set of columns that will be processed for quick lookup
            cleansing_columns = set(column_names)
            
            # Build expressions in the original column order from df
            all_expressions = []
            
            for col_name in df.columns:
                if col_name in cleansing_columns:
                    # This column goes through cleansing operations
                    col_type = df.schema[col_name].dataType

                    # If the column is a string type, apply text-based operations
                    if isinstance(col_type, StringType):
                        col_expr = col(col_name)  # Initialize column expression
                        # Replace null text fields with the provided value
                        if replace_null_text_fields:
                            df = df.na.fill({col_name: replace_null_text_with})

                        # Trim whitespace
                        if trim_whitespace:
                            col_expr = trim(col_expr)

                        # Remove tabs, line breaks, and duplicate whitespaces
                        if remove_tabs_linebreaks:
                            col_expr = regexp_replace(col_expr, r'\s+', ' ')

                        # Remove all whitespace
                        if all_whitespace:
                            col_expr = regexp_replace(col_expr, r'\s+', '')

                        # Clean letters (remove letters from the string)
                        if clean_letters:
                            col_expr = regexp_replace(col_expr, r'[A-Za-z]', '')

                        # Clean punctuations (remove punctuation characters)
                        if clean_punctuations:
                            col_expr = regexp_replace(col_expr, r'[^\w\s]', '')

                        # Clean numbers (remove numbers)
                        if clean_numbers:
                            col_expr = regexp_replace(col_expr, r'\d+', '')

                        # Convert text to lowercase
                        if make_lowercase:
                            col_expr = lower(col_expr)

                        # Convert text to uppercase
                        if make_uppercase:
                            col_expr = upper(col_expr)

                        # Convert text to title case
                        if make_titlecase:
                            col_expr = initcap(col_expr)

                        # Add the transformed column to the list with alias
                        all_expressions.append(col_expr.alias(col_name))

                    elif isinstance(col_type, (IntegerType, FloatType, DoubleType, LongType, ShortType)):
                        col_expr = col(col_name)

                        # Replace null with the provided numeric value
                        if replace_null_numeric_fields:
                            df = df.na.fill({col_name: replace_null_numeric_with})
                        all_expressions.append(col_expr.alias(col_name))
                    else:
                        # If the column doesn't require transformation, add it as is
                        all_expressions.append(col(col_name))
                else:
                    # This column remains unchanged
                    all_expressions.append(col(col_name))
            
            df = df.select(*all_expressions)

            return df
