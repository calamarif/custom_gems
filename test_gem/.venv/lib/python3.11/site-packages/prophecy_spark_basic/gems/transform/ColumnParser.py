import dataclasses

from prophecy.cb.server.base.ComponentBuilderBase import *
from prophecy.cb.ui.uispec import *
from pyspark.sql import *
from pyspark.sql.functions import *


class ColumnParser(ComponentSpec):
    name: str = "ColumnParser"
    category: str = "Transform"
    gemDescription: str = "Column Parser gem which allows us to parse a JSON or XML column string"
    docUrl: str = "https://docs.prophecy.io/engineers/column-parser/"

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class ColumnParserProperties(ComponentProperties):
        columnToParse: str = ""
        parserType: str = "JSON"
        parsingMethod: str = "parseAuto"
        sampleRecord: Optional[str] = None
        schema: Optional[str] = None
        schemaInferCount: int = 40

    def dialog(self) -> Dialog:
        methodRadioGroup = RadioGroup("Parsing method") \
            .addOption("Parse automatically", "parseAuto", description=(
            "Parse automatically from sample (top 40) records in dataframe")) \
            .addOption("Parse from sample record", "parseFromSampleRecord", description=(
            "Provide a sample record to parse the schema from")) \
            .addOption("Parse from schema", "parseFromSchema",
                       description="Provide sample schema in SQL struct format to parse the data with") \
            .setOptionType("button") \
            .setVariant("medium") \
            .setButtonStyle("solid") \
            .bindProperty("parsingMethod")

        sampleRecordTextXML = TextArea("Sample XML record to parse schema from", 20).bindProperty(
            "sampleRecord").bindPlaceholder("""
<root>
  <person>
    <id>1</id>
    <name>
      <first>John</first>
      <last>Doe</last>
    </name>
    <address>
      <street>Main St</street>
      <city>Springfield</city>
      <zip>12345</zip>
    </address>
  </person>
</root>""")
        sampleRecordTextJSON = TextArea("Sample JSON record to parse schema from", 20).bindProperty(
            "sampleRecord").bindPlaceholder("""
{
  "root": {
    "person": {
      "id": 1,
      "name": {
        "first": "John",
        "last": "Doe"
      },
      "address": {
        "street": "Main St",
        "city": "Springfield",
        "zip": 12345
      }
    }
  }
}""")
        return Dialog("ColumnParser").addElement(
            ColumnsLayout(gap="1rem", height="100%")
            .addColumn(Ports(), "content")
            .addColumn(
                StackLayout(height="100%")
                .addElement(
                    ColumnsLayout("1rem")
                    .addColumn(
                        SchemaColumnsDropdown("Source Column Name")
                        .withSearchEnabled()
                        .bindSchema("component.ports.inputs[0].schema")
                        .bindProperty("columnToParse")
                        .showErrorsFor("columnToParse"),
                        "0.4fr"
                    )
                )
                .addElement(TitleElement("Parser Type"))
                .addElement(
                    ColumnsLayout("1rem")
                    .addColumn(
                        SelectBox("Select parser type")
                        .addOption("Json Parser", "JSON")
                        .addOption("XML Parser", "XML")
                        .bindProperty("parserType"),
                        "0.4fr"
                    )
                )
                .addElement(
                    ColumnsLayout("1rem")
                    .addColumn(
                        Condition()
                        .ifEqual(PropExpr("component.properties.parserType"), StringExpr("XML"))
                        .then(
                            AlertBox(
                                variant="warning",
                                _children=[
                                    Markdown(
                                        "XML Parser supported on Databricks runtime 14.1+ or Spark Opensource 4.0+)"
                                    )
                                ]
                            )
                        )
                    )
                )
                .addElement(methodRadioGroup)
                .addElement(
                    Condition()
                    .ifEqual(PropExpr("component.properties.parsingMethod"), StringExpr("parseFromSampleRecord"))
                    .then(
                        Condition().ifEqual(PropExpr("component.properties.parserType"), StringExpr("JSON"))
                        .then(
                            sampleRecordTextJSON
                        )
                        .otherwise(
                            sampleRecordTextXML
                        )

                    ))
                .addElement(
                    Condition()
                    .ifEqual(PropExpr("component.properties.parsingMethod"), StringExpr("parseFromSchema"))
                    .then(
                        TextArea("Schema struct to parse the column", 20).bindProperty("schema").bindPlaceholder("""
STRUCT<
  person: STRUCT<
    id: INT,
    name: STRUCT<
      first: STRING,
      last: STRING
    >,
    address: STRUCT<
      street: STRING,
      city: STRING,
      zip: STRING
    >
  >
>""")))
                .addElement(
                    Condition()
                    .ifEqual(PropExpr("component.properties.parsingMethod"), StringExpr("parseAuto"))
                    .then(
                        Condition().ifEqual(PropExpr("component.properties.parserType"), StringExpr("JSON"))
                        .then(
                            ColumnsLayout("1rem")
                            .addColumn(
                                NumberBox("Infer records", placeholder=40,
                                          helpText="Number of records used to infer schema", requiredMin=1)
                                .bindProperty("schemaInferCount"),
                                "0.4fr"
                            )
                        )
                    )),
                "1fr"
            )
        )

    def validate(self, context: WorkflowContext, component: Component[ColumnParserProperties]) -> List[Diagnostic]:
        return []

    def onChange(self, context: WorkflowContext, oldState: Component[ColumnParserProperties],
                 newState: Component[ColumnParserProperties]) -> Component[
        ColumnParserProperties]:
        updatedPorts = dataclasses.replace(newState.ports, inputs=newState.ports.inputs, isCustomOutputSchema=True,
                                           autoUpdateOnRun=True)
        return dataclasses.replace(newState, ports=updatedPorts)

    class ColumnParserCode(ComponentCode):
        def __init__(self, newProps):
            self.props: ColumnParser.ColumnParserProperties = newProps

        def apply(self, spark: SparkSession, in0: DataFrame) -> DataFrame:
            if self.props.parserType == "JSON":
                from prophecy.libs.utils import json_parse
                return json_parse(in0, self.props.columnToParse, self.props.parsingMethod, self.props.sampleRecord,
                                  self.props.schema, self.props.schemaInferCount)
            else:
                from prophecy.libs.utils import xml_parse
                return xml_parse(in0, self.props.columnToParse, self.props.parsingMethod, self.props.sampleRecord,
                                 self.props.schema)
