from pyspark.sql import SparkSession, DataFrame
from pyspark.sql.types import *

from prophecy.cb.server.base.ComponentBuilderBase import (
    ComponentCode,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.server.base.DatasetBuilderBase import (
    DatasetSpec,
    DatasetProperties,
    Component,
)
from prophecy.cb.ui.uispec import *
from prophecy.cb.server.base import WorkflowContext
import dataclasses
from prophecy.cb.migration import PropertyMigrationObj


class xlsx(DatasetSpec):
    name: str = "xlsx"
    datasetType: str = "File"
    docUrl: str = "https://docs.prophecy.io/engineers/xlsx/"

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class XLSXProperties(DatasetProperties):
        schema: Optional[StructType] = None
        description: Optional[str] = ""
        useSchema: bool = False
        path: str = ""
        columnNameOfCorruptRecord: Optional[str] = None
        columnNameOfRowNumber: Optional[str] = None
        dataAddress: str = "A1"
        dateFormat: Optional[str] = None
        excerptSize: Optional[str] = None
        fileExtension: Optional[str] = None
        header: bool = True
        ignoreAfterHeader: Optional[int] = None
        ignoreLeadingWhiteSpace: Optional[bool] = None
        ignoreTrailingWhiteSpace: Optional[bool] = None
        inferSchema: Optional[bool] = None
        keepUndefinedRows: Optional[bool] = None
        locale: Optional[str] = None
        nanValue: Optional[str] = None
        nullValue: Optional[str] = None
        parseMode: Optional[str] = None
        positiveInf: Optional[str] = None
        samplingRatio: Optional[str] = None
        timestampFormat: Optional[str] = None
        useNullForErrorCells: Optional[bool] = None
        usePlainNumberFormat: Optional[bool] = None
        workbookPassword: Optional[str] = None
        zoneId: Optional[str] = None
        tempFileThreshold: Optional[str] = None
        maxRowsInMemory: Optional[str] = None
        maxByteArraySize: Optional[str] = None
        writeMode: Optional[str] = None
        partitionColumns: Optional[List[str]] = None
        createSingleOutputFile: Optional[bool] = None
        libraryType: Optional[str] = "pandas"
        skipRows: Optional[str] = None
        sheetName: Optional[str] = None
        # trueValues: List[str] = field(default_factory=list)
        # falseValues: List[str] = field(default_factory=list)
        nRows: Optional[str] = None
        # naValues: List[str] = field(default_factory=list)
        keepDefaultNAValues: Optional[bool] = None
        naFilter: Optional[bool] = None
        charForThousands: Optional[str] = None
        charForDecimal: Optional[str] = None
        charForComment: Optional[str] = None
        skipFooter: Optional[str] = None
        naRep: Optional[str] = None
        floatFormat: Optional[str] = None
        index: Optional[bool] = False
        indexLable: Optional[str] = None
        startRow: Optional[str] = None
        startColumn: Optional[str] = None
        pandasExcelDataAddress: Optional[str] = None
        pandasWriteMode: Optional[str] = "overwrite"
        secretUrl: SecretValue = field(default_factory=list)
        credType: str = "clientSecrets"
        secretUsername: SecretValue = field(default_factory=list)
        secretPassword: SecretValue = field(default_factory=list)
        tenantId: SecretValue = field(default_factory=list)
        clientId: SecretValue = field(default_factory=list)
        clientSecretId: SecretValue = field(default_factory=list)
        sftpSecretUrl: SecretValue = field(default_factory=list)
        sftpSecretUsername: SecretValue = field(default_factory=list)
        sftpSecretPassword: SecretValue = field(default_factory=list)
        sftpSourcePath: Optional[str] = None
        pathSelection: Optional[str] = "fileLocation"
        targetPathSelection: Optional[str] = "fileLocation"
        sharepointSourcePath: Optional[str] = None

    def sourceDialog(self) -> DatasetDialog:

        sharepointDialog = (StackLayout(direction=("vertical"), gap=("1rem"))
                            .addElement(
            AlertBox(
                variant="info",
                _children=[
                    Markdown(
                        "This Gem has the following requirement(s): \n"
                        "(1) Configure the [Office365-REST-Python-Client](https://pypi.org/project/Office365-REST-Python-Client/) PyPi dependency on the Spark cluster\n"
                        "(2) If Credentials set to 'Client Secrets' then Configure the [msal](https://pypi.org/project/msal/) PyPi dependency on the Spark cluster"
                    )
                ]
            )
        )
                            .addElement(TitleElement(title="Sharepoint Details"))
                            .addElement(
            SecretBox("Sharepoint Relative URL")
                .bindPlaceholder("https://prophecy.sharepoint.com/sites/prophecypoc")
                .bindProperty("secretUrl")
        )
                            .addElement(
            StackLayout()
                .addElement(
                RadioGroup("Credentials")
                    .addOption("Username & Password", "userPwd")
                    .addOption("Client Secrets", "clientSecrets")
                    .bindProperty("credType")
            ).addElement(
                Condition()
                    .ifEqual(PropExpr("component.properties.credType"), StringExpr("userPwd"))
                    .then(
                    ColumnsLayout(gap="1rem")
                        .addColumn(SecretBox("Username").bindPlaceholder("username").bindProperty("secretUsername"))
                        .addColumn(
                        SecretBox("Password").isPassword().bindPlaceholder("password").bindProperty("secretPassword")
                    )
                )
                    .otherwise(
                    ColumnsLayout(gap="1rem")
                        .addColumn(SecretBox("Tenant ID").bindPlaceholder("").bindProperty("tenantId"))
                        .addColumn(SecretBox("Client ID").bindPlaceholder("").bindProperty("clientId"))
                        .addColumn(SecretBox("Client Secret ID").bindPlaceholder("").bindProperty("clientSecretId"))
                )
            )
        )
                            .addElement(TextBox("File location in Sharepoint Site")
                                        .bindPlaceholder("/landing-zn/customers.csv")
                                        .bindProperty("sharepointSourcePath")
                                        )
                            )

        sftpDialog = (StackLayout(direction=("vertical"), gap=("1rem"))
            .addElement(
            AlertBox(
                variant="info",
                _children=[
                    Markdown(
                        "This Gem has the following requirement(s): \n"
                        "(1) Configure the [paramiko](https://pypi.org/project/paramiko/) PyPi dependency on the Spark cluster"
                    )
                ]
            )
        )
            .addElement(TitleElement(title="SFTP Details"))
            .addElement(
            SecretBox("Host")
                .bindPlaceholder("104.197.67.53")
                .bindProperty("sftpSecretUrl")
        )
            .addElement(
            StackLayout()
                .addElement(
                ColumnsLayout(gap="1rem")
                    .addColumn(SecretBox("Username").bindPlaceholder("username").bindProperty("sftpSecretUsername"))
                    .addColumn(
                    SecretBox("Password").isPassword().bindPlaceholder("password").bindProperty("sftpSecretPassword"))
            )
        )
            .addElement(
            TextBox("File location in SFTP")
                .bindPlaceholder("/home/sftpuser/customers.csv")
                .bindProperty("sftpSourcePath")
        )
        )

        locationSelection = (SelectBox("Read From")
                             .addOption("File Location", "fileLocation")
                             .addOption("Sharepoint", "sharepoint")
                             .addOption("SFTP", "sftp")
                             .bindProperty("pathSelection"))

        excelSection = (
            ColumnsLayout(gap=("1rem"), height=("100%"))
                .addColumn(
                ScrollBox().addElement(
                    StackLayout(height=("100%")).addElement(
                        StackItem(grow=(1)).addElement(
                            FieldPicker(height=("100%"))
                                .addField(
                                TextArea(
                                    "Description",
                                    2,
                                    placeholder="Dataset description...",
                                ).withCopilotEnabledDescribeDataSource(),
                                "description",
                                True,
                            )
                                .addField(Checkbox("Enforce schema"), "useSchema", True)
                                .addField(Checkbox("Header"), "header", True)
                                .addField(
                                TextBox("Data Address").bindPlaceholder("A1"),
                                "dataAddress",
                            )
                                .addField(
                                TextBox("Column Name of Corrupt Record"),
                                "columnNameOfCorruptRecord",
                            )
                                .addField(
                                TextBox("Column Name of Row Number"),
                                "columnNameOfRowNumber",
                            )
                                .addField(TextBox("Date Format"), "dateFormat")
                                .addField(TextBox("Excerpt Size"), "excerptSize")
                                .addField(TextBox("File Extension"), "fileExtension")
                                .addField(
                                TextBox("Ignore after header"), "ignoreAfterHeader"
                            )
                                .addField(
                                Checkbox("Ignore leading whitespace"),
                                "ignoreLeadingWhiteSpace",
                            )
                                .addField(
                                Checkbox("Ignore trailing whitespace"),
                                "ignoreTrailingWhiteSpace",
                            )
                                .addField(Checkbox("Infer Schema"), "inferSchema")
                                .addField(TextBox("Locale"), "locale")
                                .addField(TextBox("NaN Value"), "nanValue")
                                .addField(TextBox("Negative Infinite value"), "negativeInf")
                                .addField(TextBox("Null value"), "nullValue")
                                .addField(
                                SelectBox("Parse Mode")
                                    .addOption("Permissive", "PERMISSIVE")
                                    .addOption("Drop Malformed", "DROPMALFORMED")
                                    .addOption("Fail Fast", "FAILFAST"),
                                "parseMode",
                            )
                                .addField(TextBox("Positive Infinite value"), "positiveInf")
                                .addField(TextBox("Sampling Ratio"), "samplingRatio")
                                .addField(TextBox("Timestamp Format"), "timestampFormat")
                                .addField(
                                Checkbox("Use Null for Error Cells"),
                                "useNullForErrorCells",
                            )
                                .addField(TextBox("Workbook Password"), "workbookPassword")
                                .addField(TextBox("Time Zone ID"), "zoneId")
                                .addField(
                                TextBox("Temporary file threshold"), "tempFileThreshold"
                            )
                                .addField(
                                TextBox("Maximum rows in memory"), "maxRowsInMemory"
                            )
                                .addField(
                                TextBox("Maximum byte array size"), "maxByteArraySize"
                            )
                        )
                    )
                ),
                "400px",
            )
                .addColumn(SchemaTable("").bindProperty("schema"), "5fr")
        )

        pandasSection = (
            ColumnsLayout(gap=("1rem"), height=("100%"))
                .addColumn(
                ScrollBox().addElement(
                    StackLayout(height=("100%")).addElement(
                        StackItem(grow=(1)).addElement(
                            FieldPicker(height=("100%"))
                                .addField(
                                TextArea(
                                    "Description",
                                    2,
                                    placeholder="Dataset description...",
                                ).withCopilotEnabledDescribeDataSource(),
                                "description",
                                True,
                            )
                                .addField(Checkbox("Enforce schema"), "useSchema", True)
                                .addField(Checkbox("Header"), "header", True)
                                .addField(
                                TextBox("Data Address").bindPlaceholder("A:C"),
                                "pandasExcelDataAddress",
                            )
                                .addField(
                                TextBox("Skip Rows").bindPlaceholder("0"), "skipRows"
                            )
                                .addField(
                                TextBox("Sheet Name").bindPlaceholder("Sheet1"),
                                "sheetName",
                                True,
                            )
                                # .addField(SelectBox("True Values", mode="tags"),"trueValues")
                                # .addField(SelectBox("False Values", mode="tags"),"falseValues")
                                .addField(
                                TextBox("Read N Rows From Start").bindPlaceholder("10"),
                                "nRows",
                            )
                                # .addField(SelectBox("NA Values", mode="tags"),"naValues")
                                .addField(
                                Checkbox("Keep Default NA Values"),
                                "keepDefaultNAValues",
                            )
                                .addField(Checkbox("Set Missing Values as NaN"), "naFilter")
                                .addField(
                                TextBox(
                                    "Specific Character For Thousands"
                                ).bindPlaceholder("."),
                                "charForThousands",
                            )
                                .addField(
                                TextBox(
                                    "Specific Character For Decimal"
                                ).bindPlaceholder(","),
                                "charForDecimal",
                            )
                                .addField(
                                TextBox(
                                    "Specific Character For Comment"
                                ).bindPlaceholder("#"),
                                "charForComment",
                            )
                                .addField(
                                TextBox("Skip N Rows From Bottom").bindPlaceholder(
                                    "10"
                                ),
                                "skipFooter",
                            )
                        )
                    )
                ),
                "400px",
            )
                .addColumn(SchemaTable("").bindProperty("schema"), "5fr")
        )

        return (
            DatasetDialog("xlsx")
                .addSection("LOCATION",
                            StackLayout().addElement(locationSelection)
                            .addElement(
                                Condition()
                                    .ifEqual(PropExpr("component.properties.pathSelection"), StringExpr("fileLocation"))
                                    .then(TargetLocation("path"))
                            )
                            .addElement(
                                Condition()
                                    .ifEqual(PropExpr("component.properties.pathSelection"), StringExpr("sharepoint"))
                                    .then(sharepointDialog)
                            )
                            .addElement(
                                Condition()
                                    .ifEqual(PropExpr("component.properties.pathSelection"), StringExpr("sftp"))
                                    .then(sftpDialog)
                            )
                            ) \
                .addSection(
                "PROPERTIES",
                StackLayout(height=("100%"))
                    .addElement(
                    Condition()
                        .ifEqual(PropExpr("component.properties.pathSelection"), StringExpr("fileLocation"))
                        .then(
                        SelectBox("Library Type")
                            .addOption("Spark-Excel v2 - excel", "crealytics")
                            .addOption("Spark-Excel crealytics - com.crealytics.spark.excel", "sparkexcel")
                            .addOption("Pandas", "pandas")
                            .bindProperty("libraryType")
                    )
                )
                    .addElement(
                    Condition()
                        .ifEqual(
                        PropExpr("component.properties.libraryType"),
                        StringExpr("pandas"),
                    )
                        .then(
                        AlertBox(
                            variant="info",
                            _children=[
                                Markdown(
                                    "Use this Gem to read excel files from Databricks **Volumes or DBFS**. Requirements: configure the [pandas](https://pypi.org/project/pandas/), [glob](https://pypi.org/project/glob2/) and [openpyxl](https://pypi.org/project/openpyxl/) PyPi dependencies on the Spark cluster"
                                )
                            ],
                        )
                    )
                        .otherwise(
                        AlertBox(
                            variant="info",
                            _children=[
                                Markdown(
                                    "This Gem has the following requirement(s): Configure the [spark-excel](https://docs.prophecy.io/Spark/gems/source-target/file/xlsx/#source-parameters) Maven dependency on the Spark cluster."
                                )
                            ],
                        )
                    )
                )
                    .addElement(
                    Condition()
                        .ifEqual(
                        PropExpr("component.properties.libraryType"),
                        StringExpr("pandas"),
                    )
                        .then(pandasSection)
                        .otherwise(excelSection)
                ),
            )
                .addSection("PREVIEW", PreviewTable("").bindProperty("schema"))
        )

    def targetDialog(self) -> DatasetDialog:
        locationSelection = (RadioGroup("Write to:")
                             .addOption("File Location", "fileLocation")
                             .addOption("Sharepoint (Coming Soon)", "sharepoint")
                             .addOption("SFTP (Coming Soon)", "sftp")
                             .bindProperty("targetPathSelection"))

        excelSection = (
            ColumnsLayout(gap=("1rem"), height=("100%"))
                .addColumn(
                ScrollBox().addElement(
                    StackLayout(height=("100%")).addElement(
                        StackItem(grow=(1)).addElement(
                            FieldPicker(height=("100%"))
                                .addField(
                                TextArea(
                                    "Description",
                                    2,
                                    placeholder="Dataset description...",
                                ).withCopilotEnabledDescribeDataSource(),
                                "description",
                                True,
                            )
                                .addField(
                                TextBox("Data Address").bindPlaceholder("A1"),
                                "dataAddress",
                            )
                                .addField(
                                TextBox("File Extension").bindPlaceholder("xlsx"),
                                "fileExtension",
                            )
                                .addField(Checkbox("Header"), "header")
                                .addField(TextBox("Locale"), "locale")
                                .addField(TextBox("Date Format"), "dateFormat")
                                .addField(
                                Checkbox("Use Plain Number Format"),
                                "usePlainNumberFormat",
                            )
                                .addField(TextBox("Workbook Password"), "workbookPassword")
                                .addField(
                                SelectBox("Write Mode")
                                    .addOption("error", "error")
                                    .addOption("overwrite", "overwrite")
                                    .addOption("append", "append")
                                    .addOption("ignore", "ignore"),
                                "writeMode",
                                True,
                            )
                                .addField(
                                SchemaColumnsDropdown("Partition Columns")
                                    .withMultipleSelection()
                                    .bindSchema("schema")
                                    .showErrorsFor("partitionColumns"),
                                "partitionColumns",
                            )
                                .addField(
                                Checkbox("Create single named XLSX file"),
                                "createSingleOutputFile",
                            )
                        )
                    )
                ),
                "400px",
            )
                .addColumn(
                SchemaTable("")
                    .isReadOnly()
                    .withoutInferSchema()
                    .bindProperty("schema"),
                "5fr",
            )
        )

        pandasSection = (
            ColumnsLayout(gap=("1rem"), height=("100%"))
                .addColumn(
                ScrollBox().addElement(
                    StackLayout(height=("100%")).addElement(
                        StackItem(grow=(1)).addElement(
                            FieldPicker(height=("100%"))
                                .addField(
                                TextArea(
                                    "Description",
                                    2,
                                    placeholder="Dataset description...",
                                ).withCopilotEnabledDescribeDataSource(),
                                "description",
                                True,
                            )
                                .addField(
                                SelectBox("Write Mode")
                                    .addOption("overwrite", "overwrite")
                                    .addOption("append", "append"),
                                "pandasWriteMode",
                                True,
                            )
                                .addField(
                                TextBox("Sheet Name").bindPlaceholder("Sheet1"),
                                "sheetName",
                            )
                                .addField(
                                TextBox("NA Representation").bindPlaceholder("N/A"),
                                "naRep",
                            )
                                .addField(
                                TextBox("Float Format").bindPlaceholder("%.2f"),
                                "floatFormat",
                            )
                                .addField(Checkbox("Header"), "header")
                                .addField(Checkbox("Index"), "index")
                                .addField(
                                TextBox("Index Label").bindPlaceholder("ColumnName"),
                                "indexLable",
                            )
                                .addField(
                                TextBox("Start Row").bindPlaceholder("0"), "startRow"
                            )
                                .addField(
                                TextBox("Start Column").bindPlaceholder("0"),
                                "startColumn",
                            )
                        )
                    )
                ),
                "400px",
            )
                .addColumn(
                SchemaTable("")
                    .isReadOnly()
                    .withoutInferSchema()
                    .bindProperty("schema"),
                "5fr",
            )
        )

        return (
            DatasetDialog("xlsx")
                .addSection("LOCATION", StackLayout() \
                            .addElement(locationSelection) \
                            .addElement(
                Condition()
                    .ifEqual(PropExpr("component.properties.targetPathSelection"), StringExpr("fileLocation"))
                    .then(TargetLocation("path"))
            )
                            ) \
                .addSection(
                "PROPERTIES",
                StackLayout(height=("100%"))
                    .addElement(
                    SelectBox("Library Type")
                        .addOption("Spark-Excel (Crealytics)", "crealytics")
                        .addOption("Spark-Excel (V2)", "sparkexcel")
                        .addOption("Pandas", "pandas")
                        .bindProperty("libraryType")
                )
                    .addElement(
                    Condition()
                        .ifEqual(
                        PropExpr("component.properties.libraryType"),
                        StringExpr("pandas"),
                    )
                        .then(
                        AlertBox(
                            variant="info",
                            _children=[
                                Markdown(
                                    "Use this Gem to read excel files from Databricks **Volumes or DBFS**. Requirements: configure the [pandas](https://pypi.org/project/pandas/) and [openpyxl](https://pypi.org/project/openpyxl/) PyPi dependencies on the Spark cluster"
                                )
                            ],
                        )
                    )
                        .otherwise(
                        AlertBox(
                            variant="info",
                            _children=[
                                Markdown(
                                    "This Gem has the following requirement(s): Configure the [spark-excel](https://docs.prophecy.io/Spark/gems/source-target/file/xlsx/#source-parameters) Maven dependency on the Spark cluster."
                                )
                            ],
                        )
                    )
                )
                    .addElement(
                    Condition()
                        .ifEqual(
                        PropExpr("component.properties.libraryType"),
                        StringExpr("pandas"),
                    )
                        .then(pandasSection)
                        .otherwise(excelSection)
                ),
            )
        )

    def validate(self, context: WorkflowContext, component: Component) -> list:
        diagnostics = super(xlsx, self).validate(context, component)
        if component.properties.targetPathSelection in ["sharepoint", "sftp"]:
            diagnostics.append(
                Diagnostic("properties.targetPathSelection",
                           f"Write to {component.properties.targetPathSelection} coming soon !!",
                           SeverityLevelEnum.Error))
        else:
            if (
                    component.properties.pathSelection == "fileLocation" or component.properties.targetPathSelection == "fileLocation") and (
                    component.properties.pathSelection not in ["sharepoint", "sftp"]) and len(
                    component.properties.path) == 0:
                diagnostics.append(
                    Diagnostic("properties.path",
                               f"File location can't be empty",
                               SeverityLevelEnum.Error))

        if component.properties.pathSelection == "sharepoint":
            if component.properties.credType == "userPwd":
                if not component.properties.secretUsername.parts:
                    diagnostics.append(Diagnostic("properties.secretUsername", "Username can't be empty",
                                                  SeverityLevelEnum.Error))
                if not component.properties.secretPassword.parts:
                    diagnostics.append(Diagnostic("properties.secretPassword", "Password can't be empty",
                                                  SeverityLevelEnum.Error))

            if component.properties.credType == "clientSecrets":
                if not component.properties.tenantId.parts:
                    diagnostics.append(Diagnostic("properties.tenantId", "Tenant ID can't be empty",
                                                  SeverityLevelEnum.Error))
                if not component.properties.clientId.parts:
                    diagnostics.append(Diagnostic("properties.clientId", "Client ID can't be empty",
                                                  SeverityLevelEnum.Error))
                if not component.properties.clientSecretId.parts:
                    diagnostics.append(Diagnostic("properties.clientSecretId", "Client Secret ID can't be empty",
                                                  SeverityLevelEnum.Error))

            if not component.properties.secretUrl.parts:
                diagnostics.append(
                    Diagnostic("properties.secretUrl", f"Sharepoint URL can't be empty",
                               SeverityLevelEnum.Error))

            if not component.properties.sharepointSourcePath:
                diagnostics.append(
                    Diagnostic("properties.sharepointSourcePath", f"Sharepoint file location can't be empty",
                               SeverityLevelEnum.Error))

        if component.properties.pathSelection == "sftp":
            if not component.properties.sftpSecretUsername.parts:
                diagnostics.append(Diagnostic("properties.sftpSecretUsername", "Username can't be empty",
                                              SeverityLevelEnum.Error))
            if not component.properties.sftpSecretPassword.parts:
                diagnostics.append(Diagnostic("properties.sftpSecretPassword", "Password can't be empty",
                                              SeverityLevelEnum.Error))

            if not component.properties.sftpSecretUrl.parts:
                diagnostics.append(
                    Diagnostic("properties.sftpSecretUrl", f"Host can't be empty",
                               SeverityLevelEnum.Error))

            if not component.properties.sftpSourcePath:
                diagnostics.append(
                    Diagnostic("properties.sftpSourcePath", f"SFTP file location can't be empty",
                               SeverityLevelEnum.Error))

        if (
                component.properties.createSingleOutputFile is not None
                and component.properties.createSingleOutputFile
        ):
            if component.properties.writeMode == "append":
                diagnostics.append(
                    Diagnostic(
                        "properties.writeMode",
                        "Append write mode cannot be used with create single excel file option",
                        SeverityLevelEnum.Error,
                    )
                )

        if (
                component.properties.createSingleOutputFile is not None
                and component.properties.createSingleOutputFile and component.properties.partitionColumns is not None and len(
            component.properties.partitionColumns) != 0
        ):
            diagnostics.append(
                Diagnostic(
                    "properties.createSingleOutputFile",
                    "Creating single excel file and partition columns option cannot be selected together. Please choose one.",
                    SeverityLevelEnum.Error,
                )
            )

        return diagnostics

    def onChange(
            self, context: WorkflowContext, oldState: Component, newState: Component
    ) -> Component:
        return newState

    class XLSXFormatCode(ComponentCode):
        def __init__(self, props):
            self.props: xlsx.XLSXProperties = props

        def sourceApply(self, spark: SparkSession) -> DataFrame:
            finalPath = self.props.path

            if self.props.libraryType == "pandas":
                import pandas as pd
                import numpy as np
                def convert_pandas_columns(pandas_df: pd.DataFrame, schema: StructType = None) -> pd.DataFrame:
                    if schema is None:
                        # Convert all columns to string
                        for col in pandas_df.columns:
                            pandas_df[col] = pandas_df[col].astype(str)
                        return pandas_df

                    for field in schema.fields:
                        col_name = field.name
                        if col_name in pandas_df.columns:
                            spark_type = field.dataType

                            if isinstance(spark_type, StringType):
                                pandas_df[col_name] = pandas_df[col_name].astype(str)

                            elif isinstance(spark_type, IntegerType):
                                pandas_df[col_name] = pd.to_numeric(pandas_df[col_name], errors="coerce").astype(
                                    "Int64")

                            elif isinstance(spark_type, DoubleType):
                                pandas_df[col_name] = pd.to_numeric(pandas_df[col_name], errors="coerce")

                            elif isinstance(spark_type, DateType):
                                pandas_df[col_name] = pd.to_datetime(pandas_df[col_name], errors="coerce").dt.date

                            elif isinstance(spark_type, TimestampType):
                                pandas_df[col_name] = pd.to_datetime(pandas_df[col_name], errors="coerce")

                            elif isinstance(spark_type, BooleanType):
                                pandas_df[col_name] = pandas_df[col_name].map(
                                    lambda x: True if str(x).strip().lower() in ["true", "1", "yes"]
                                    else False if str(x).strip().lower() in ["false", "0", "no"]
                                    else np.nan
                                ).astype("boolean")

                    return pandas_df

            if self.props.pathSelection == "sharepoint":
                if self.props.credType == "userPwd":
                    import os
                    from office365.sharepoint.client_context import ClientContext
                    from office365.runtime.auth.user_credential import UserCredential

                    sharepointUrl = self.props.secretUrl
                    ctx = ClientContext(sharepointUrl).with_credentials(
                        UserCredential(self.props.secretUsername, self.props.secretPassword)
                    )
                    file_url = self.props.sharepointSourcePath
                    download_path: SubstituteDisabled = os.path.join("/tmp", os.path.basename(file_url))
                    with open(download_path, "wb") as local_file:
                        ctx.web.get_file_by_server_relative_url(file_url).download(local_file).execute_query()
                elif self.props.credType == "clientSecrets":
                    import msal
                    from office365.graph_client import GraphClient
                    import os

                    client: SubstituteDisabled = GraphClient(
                        lambda: msal.ConfidentialClientApplication(
                            authority=f"https://login.microsoftonline.com/{self.props.tenantId}",
                            client_id=self.props.clientId,
                            client_credential=self.props.clientSecretId,
                        ).acquire_token_for_client(scopes=["https://graph.microsoft.com/.default"])
                    )
                    site: SubstituteDisabled = client.sites.get_by_url(self.props.secretUrl).execute_query()
                    site_id: SubstituteDisabled = site.id

                    file_url = self.props.sharepointSourcePath

                    file_item: SubstituteDisabled = client.sites[site_id].drive.root.get_by_path(
                        file_url).get().execute_query()
                    download_path: SubstituteDisabled = os.path.join("/tmp", os.path.basename(file_url))

                    with open(download_path, "wb") as local_file:
                        file_item.download(local_file).execute_query()

                import pandas as pd

                kwargs: SubstituteDisabled = {}

                if not self.props.header:
                    kwargs["header"] = None
                if (
                        self.props.pandasExcelDataAddress is not None
                        and self.props.pandasExcelDataAddress != ""
                ):
                    kwargs["usecols"] = self.props.pandasExcelDataAddress
                if self.props.skipRows is not None and self.props.skipRows != "":
                    kwargs["skiprows"] = int(self.props.skipRows)
                if self.props.sheetName is not None and self.props.sheetName != "":
                    kwargs["sheet_name"] = self.props.sheetName
                # if self.props.trueValues:
                #     kwargs["true_values"] = self.props.trueValues
                # if self.props.falseValues:
                #     kwargs["false_values"] = self.props.falseValues
                if self.props.nRows is not None and self.props.nRows != "":
                    kwargs["nrows"] = int(self.props.nRows)
                # if self.props.naValues:
                #     kwargs["na_values"] = self.props.naValues
                if self.props.keepDefaultNAValues is not None:
                    kwargs["keep_default_na"] = self.props.keepDefaultNAValues
                if self.props.naFilter is not None:
                    kwargs["na_filter"] = self.props.naFilter
                if self.props.skipFooter is not None and self.props.skipFooter != "":
                    kwargs["skipfooter"] = int(self.props.skipFooter)
                if (
                        self.props.charForThousands is not None
                        and self.props.charForThousands != ""
                ):
                    kwargs["thousands"] = self.props.charForThousands
                if (
                        self.props.charForDecimal is not None
                        and self.props.charForDecimal != ""
                ):
                    kwargs["decimal"] = self.props.charForDecimal
                if (
                        self.props.charForComment is not None
                        and self.props.charForComment != ""
                ):
                    kwargs["comment"] = self.props.charForComment

                pandasDf: SubstituteDisabled = pd.read_excel(download_path, **kwargs)
                spark.conf.set("spark.sql.execution.arrow.pyspark.enabled", "false")

                if self.props.useSchema and self.props.schema is not None:
                    pandasDf = convert_pandas_columns(pandasDf, self.props.schema)
                    spark_df = spark.createDataFrame(pandasDf, schema=self.props.schema)
                else:
                    pandasDf = convert_pandas_columns(pandasDf, None)
                    spark_df = spark.createDataFrame(pandasDf)

                spark.conf.set("spark.sql.execution.arrow.pyspark.enabled", "true")

                return spark_df

            elif self.props.pathSelection == "sftp":
                import paramiko
                import os

                def download_file_from_sftp(username, password, host, remote_file_path, local_file_path):
                    ssh_client: SubstituteDisabled = paramiko.SSHClient()
                    ssh_client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                    try:
                        ssh_client.connect(host, username=username, password=password)
                        sftp_client = ssh_client.open_sftp()
                        try:
                            sftp_client.get(remote_file_path, local_file_path)
                        finally:
                            sftp_client.close()
                    finally:
                        ssh_client.close()

                download_path: SubstituteDisabled = os.path.join("/tmp", os.path.basename(self.props.sftpSourcePath))

                download_file_from_sftp(username=self.props.sftpSecretUsername, password=self.props.sftpSecretPassword,
                                        host=self.props.sftpSecretUrl, remote_file_path=self.props.sftpSourcePath,
                                        local_file_path=download_path)

                import pandas as pd

                kwargs: SubstituteDisabled = {}

                if not self.props.header:
                    kwargs["header"] = None
                if (
                        self.props.pandasExcelDataAddress is not None
                        and self.props.pandasExcelDataAddress != ""
                ):
                    kwargs["usecols"] = self.props.pandasExcelDataAddress
                if self.props.skipRows is not None and self.props.skipRows != "":
                    kwargs["skiprows"] = int(self.props.skipRows)
                if self.props.sheetName is not None and self.props.sheetName != "":
                    kwargs["sheet_name"] = self.props.sheetName
                # if self.props.trueValues:
                #     kwargs["true_values"] = self.props.trueValues
                # if self.props.falseValues:
                #     kwargs["false_values"] = self.props.falseValues
                if self.props.nRows is not None and self.props.nRows != "":
                    kwargs["nrows"] = int(self.props.nRows)
                # if self.props.naValues:
                #     kwargs["na_values"] = self.props.naValues
                if self.props.keepDefaultNAValues is not None:
                    kwargs["keep_default_na"] = self.props.keepDefaultNAValues
                if self.props.naFilter is not None:
                    kwargs["na_filter"] = self.props.naFilter
                if self.props.skipFooter is not None and self.props.skipFooter != "":
                    kwargs["skipfooter"] = int(self.props.skipFooter)
                if (
                        self.props.charForThousands is not None
                        and self.props.charForThousands != ""
                ):
                    kwargs["thousands"] = self.props.charForThousands
                if (
                        self.props.charForDecimal is not None
                        and self.props.charForDecimal != ""
                ):
                    kwargs["decimal"] = self.props.charForDecimal
                if (
                        self.props.charForComment is not None
                        and self.props.charForComment != ""
                ):
                    kwargs["comment"] = self.props.charForComment

                pandasDf: SubstituteDisabled = pd.read_excel(download_path, **kwargs)
                spark.conf.set("spark.sql.execution.arrow.pyspark.enabled", "false")

                if self.props.useSchema and self.props.schema is not None:
                    pandasDf = convert_pandas_columns(pandasDf, self.props.schema)
                    spark_df = spark.createDataFrame(pandasDf, schema=self.props.schema)
                else:
                    pandasDf = convert_pandas_columns(pandasDf, None)
                    spark_df = spark.createDataFrame(pandasDf)

                spark.conf.set("spark.sql.execution.arrow.pyspark.enabled", "true")

                return spark_df

            elif self.props.pathSelection == "fileLocation":
                if self.props.libraryType == "pandas":
                    import pandas as pd
                    import os
                    import glob

                    kwargs: SubstituteDisabled = {}

                    if not self.props.header:
                        kwargs["header"] = None
                    if (
                            self.props.pandasExcelDataAddress is not None
                            and self.props.pandasExcelDataAddress != ""
                    ):
                        kwargs["usecols"] = self.props.pandasExcelDataAddress
                    if self.props.skipRows is not None and self.props.skipRows != "":
                        kwargs["skiprows"] = int(self.props.skipRows)
                    if self.props.sheetName is not None and self.props.sheetName != "":
                        kwargs["sheet_name"] = self.props.sheetName
                    # if self.props.trueValues:
                    #     kwargs["true_values"] = self.props.trueValues
                    # if self.props.falseValues:
                    #     kwargs["false_values"] = self.props.falseValues
                    if self.props.nRows is not None and self.props.nRows != "":
                        kwargs["nrows"] = int(self.props.nRows)
                    # if self.props.naValues:
                    #     kwargs["na_values"] = self.props.naValues
                    if self.props.keepDefaultNAValues is not None:
                        kwargs["keep_default_na"] = self.props.keepDefaultNAValues
                    if self.props.naFilter is not None:
                        kwargs["na_filter"] = self.props.naFilter
                    if self.props.skipFooter is not None and self.props.skipFooter != "":
                        kwargs["skipfooter"] = int(self.props.skipFooter)
                    if (
                            self.props.charForThousands is not None
                            and self.props.charForThousands != ""
                    ):
                        kwargs["thousands"] = self.props.charForThousands
                    if (
                            self.props.charForDecimal is not None
                            and self.props.charForDecimal != ""
                    ):
                        kwargs["decimal"] = self.props.charForDecimal
                    if (
                            self.props.charForComment is not None
                            and self.props.charForComment != ""
                    ):
                        kwargs["comment"] = self.props.charForComment

                    matching_files: SubstituteDisabled = []

                    targetPath  = self.props.path
                    if targetPath[:5] == "dbfs:":
                        targetPath = targetPath.replace("dbfs:/", "/dbfs/")
                        
                    matching_files: SubstituteDisabled = glob.glob(targetPath, recursive=True)

                    def is_databricks_fuse_mounted(spark: SparkSession) -> bool:
                        return os.path.exists("/dbfs/") or os.path.exists("/Volumes/")

                    if not is_databricks_fuse_mounted(spark):
                        try:
                            from prophecy.utils.databricks_utils import (
                                dbfs_glob,
                                copy_from_dbfs_to_local,
                                is_dbfs_or_volumes_path
                            )
                        except ImportError:
                            raise RuntimeError(
                                "You need to upgrade prophecy-python-libs to >= 2.1.5 to use Xlsx source with Databricks Serverless environment."
                            )
                    
                    if not matching_files and not is_databricks_fuse_mounted(spark) and is_dbfs_or_volumes_path(self.props.path, spark):
                        dbfs_matched_files: SubstituteDisabled = dbfs_glob(self.props.path)
                        matching_files = copy_from_dbfs_to_local(dbfs_matched_files)      
                    
                    if not matching_files:
                        raise ValueError("No file(s) found matching the specified name/pattern")

                    dfs: SubstituteDisabled = []
                    for file_path in matching_files:
                        df = pd.read_excel(file_path, **kwargs)
                        dfs.append(df)

                    pandasDf: SubstituteDisabled = pd.concat(dfs, ignore_index=True)

                    spark.conf.set("spark.sql.execution.arrow.pyspark.enabled", "false")

                    if self.props.useSchema and self.props.schema is not None:
                        pandasDf = convert_pandas_columns(pandasDf, self.props.schema)
                        spark_df = spark.createDataFrame(pandasDf, schema=self.props.schema)
                    else:
                        pandasDf = convert_pandas_columns(pandasDf, None)
                        spark_df = spark.createDataFrame(pandasDf)

                    spark.conf.set("spark.sql.execution.arrow.pyspark.enabled", "true")

                    return spark_df
                elif (self.props.libraryType == "crealytics") or (self.props.libraryType == "sparkexcel") :
                    if self.props.libraryType == "crealytics":
                        reader = spark.read.format("excel").option("header", self.props.header)
                    elif self.props.libraryType == "sparkexcel":
                        reader = spark.read.format("com.crealytics.spark.excel").option("header", self.props.header)

                    if self.props.schema is not None and self.props.useSchema:
                        reader = reader.schema(self.props.schema)
                    if self.props.dataAddress is not None:
                        reader = reader.option("dataAddress", self.props.dataAddress)
                    if self.props.fileExtension is not None:
                        reader = reader.option("fileExtension", self.props.fileExtension)
                    if self.props.ignoreLeadingWhiteSpace is not None:
                        reader = reader.option(
                            "ignoreLeadingWhiteSpace", self.props.ignoreLeadingWhiteSpace
                        )
                    if self.props.ignoreTrailingWhiteSpace is not None:
                        reader = reader.option(
                            "ignoreTrailingWhiteSpace", self.props.ignoreTrailingWhiteSpace
                        )
                    if self.props.inferSchema is not None:
                        reader = reader.option("inferSchema", self.props.inferSchema)
                    if self.props.keepUndefinedRows is not None:
                        reader = reader.option(
                            "keepUndefinedRows", self.props.keepUndefinedRows
                        )
                    if self.props.parseMode is not None:
                        reader = reader.option("parseMode", self.props.parseMode)
                    if self.props.useNullForErrorCells is not None:
                        reader = reader.option(
                            "useNullForErrorCells", self.props.useNullForErrorCells
                        )
                    if self.props.columnNameOfCorruptRecord is not None:
                        reader = reader.option(
                            "columnNameOfCorruptRecord",
                            self.props.columnNameOfCorruptRecord,
                        )
                    if self.props.columnNameOfRowNumber is not None:
                        reader = reader.option(
                            "columnNameOfRowNumber", self.props.columnNameOfRowNumber
                        )
                    if self.props.dateFormat is not None:
                        reader = reader.option("dateFormat", self.props.dateFormat)
                    if self.props.excerptSize is not None:
                        reader = reader.option("excerptSize", self.props.excerptSize)
                    if self.props.ignoreAfterHeader is not None:
                        reader = reader.option(
                            "ignoreAfterHeader", self.props.ignoreAfterHeader
                        )
                    if self.props.locale is not None:
                        reader = reader.option("locale", self.props.locale)
                    if self.props.nanValue is not None:
                        reader = reader.option("nanValue", self.props.nanValue)
                    if self.props.nullValue is not None:
                        reader = reader.option("nullValue", self.props.nullValue)
                    if self.props.positiveInf is not None:
                        reader = reader.option("positiveInf", self.props.positiveInf)
                    if self.props.samplingRatio is not None:
                        reader = reader.option("samplingRatio", self.props.samplingRatio)
                    if self.props.timestampFormat is not None:
                        reader = reader.option(
                            "timestampFormat", self.props.timestampFormat
                        )
                    if self.props.workbookPassword is not None:
                        reader = reader.option(
                            "workbookPassword", self.props.workbookPassword
                        )
                    if self.props.zoneId is not None:
                        reader = reader.option("zoneId", self.props.zoneId)
                    if self.props.tempFileThreshold is not None:
                        reader = reader.option(
                            "tempFileThreshold", self.props.tempFileThreshold
                        )
                    if self.props.maxRowsInMemory is not None:
                        reader = reader.option(
                            "maxRowsInMemory", self.props.maxRowsInMemory
                        )
                    if self.props.maxByteArraySize is not None:
                        reader = reader.option(
                            "maxByteArraySize", self.props.maxByteArraySize
                        )

                    return reader.load(finalPath)

        def targetApply(self, spark: SparkSession, in0: DataFrame):

            if (self.props.libraryType == "crealytics") or (self.props.libraryType == "sparkexcel"):
                xlsx_format = "excel" if self.props.libraryType == "crealytics" else "com.crealytics.spark.excel"
                if (
                        self.props.createSingleOutputFile is not None
                        and self.props.createSingleOutputFile
                ):
                    writer = (
                        in0.coalesce(1)
                            .write.format(xlsx_format)
                            .option("header", self.props.header)
                    )
                else:
                    writer = in0.write.format(xlsx_format).option(
                        "header", self.props.header
                    )

                if self.props.dataAddress is not None:
                    writer = writer.option("dataAddress", self.props.dataAddress)
                if self.props.fileExtension is not None:
                    writer = writer.option("fileExtension", self.props.fileExtension)
                if self.props.locale is not None:
                    writer = writer.option("locale", self.props.locale)
                if self.props.dateFormat is not None:
                    writer = writer.option("dateFormat", self.props.dateFormat)
                if self.props.usePlainNumberFormat is not None:
                    writer = writer.option(
                        "usePlainNumberFormat", self.props.usePlainNumberFormat
                    )
                if self.props.workbookPassword is not None:
                    writer = writer.option(
                        "workbookPassword", self.props.workbookPassword
                    )
                if self.props.writeMode is not None:
                    writer = writer.mode(self.props.writeMode)

                if (
                        self.props.partitionColumns is not None
                        and len(self.props.partitionColumns) > 0
                ):
                    writer = writer.partitionBy(*self.props.partitionColumns)

                if (
                        self.props.createSingleOutputFile is not None
                        and self.props.createSingleOutputFile
                ):
                    writer.save(self.props.path + "_temp")
                else:
                    writer.save(self.props.path)

                if self.props.createSingleOutputFile is not None:
                    if self.props.createSingleOutputFile:
                        from prophecy.utils.gems_utils import concatenateFiles

                        concatenateFiles(
                            spark,
                            ".xlsx",
                            self.props.writeMode,
                            self.props.path + "_temp",
                            self.props.path,
                            True,
                            True,
                        )
            else:
                import pandas as pd
                import os
                import shutil

                kwargs: SubstituteDisabled = {}
                if self.props.sheetName is not None and self.props.sheetName != "":
                    kwargs["sheet_name"] = self.props.sheetName
                if self.props.naRep is not None and self.props.naRep != "":
                    kwargs["na_rep"] = self.props.naRep
                if self.props.floatFormat is not None and self.props.floatFormat != "":
                    kwargs["float_format"] = self.props.floatFormat
                if self.props.header:
                    kwargs["header"] = True
                else:
                    kwargs["header"] = False
                if self.props.index:
                    kwargs["index"] = True
                else:
                    kwargs["index"] = False
                if self.props.indexLable is not None and self.props.indexLable != "":
                    kwargs["index_label"] = self.props.indexLable
                if self.props.startRow is not None and self.props.startRow != "":
                    kwargs["startrow"] = int(self.props.startRow)
                if self.props.startColumn is not None and self.props.startColumn != "":
                    kwargs["startcol"] = int(self.props.startColumn)

                fileName: SubstituteDisabled = self.props.path.split("/")[-1]
                localPath: SubstituteDisabled = "/tmp/" + fileName
                pandas_df: SubstituteDisabled = in0.toPandas()
                writePath = self.props.path
                if writePath[:5] == "dbfs:":
                    writePath = writePath.replace("dbfs:/", "/dbfs/")

                directory_path = os.path.dirname(writePath)
                if not os.path.exists(directory_path):
                    os.makedirs(directory_path)

                if os.path.exists(writePath):
                    shutil.copy(writePath, localPath)
                    if self.props.pandasWriteMode == "append":
                        with pd.ExcelWriter(
                                localPath,
                                engine="openpyxl",
                                mode="a",
                                if_sheet_exists="overlay",
                        ) as writer:
                            try:
                                target_sheet = (
                                    kwargs["sheet_name"]
                                    if "sheet_name" in kwargs.keys()
                                    else "Sheet1"
                                )
                                existing_data_rows = pd.read_excel(
                                    localPath, sheet_name=target_sheet, usecols=[0]
                                ).shape[0]
                                kwargs["index"] = False
                                kwargs["startrow"] = existing_data_rows + 1
                                kwargs["header"] = False
                                pandas_df.to_excel(writer, **kwargs)
                            except ValueError:
                                pandas_df.to_excel(writer, **kwargs)
                    elif self.props.pandasWriteMode == "overwrite":
                        with pd.ExcelWriter(
                                localPath,
                                engine="openpyxl",
                                mode="a",
                                if_sheet_exists="replace",
                        ) as writer:
                            pandas_df.to_excel(writer, **kwargs)
                    os.remove(writePath)
                else:
                    pandas_df.to_excel(localPath, **kwargs)

                shutil.copy(localPath, writePath)

                if os.path.exists(localPath):
                    os.remove(localPath)

    def __init__(self):
        super().__init__()
        self.registerPropertyEvolution(XLSXPropertyMigration())


class XLSXPropertyMigration(PropertyMigrationObj):
    def migrationNumber(self) -> int:
        return 1

    def up(self, old_properties: xlsx.XLSXProperties) -> xlsx.XLSXProperties:
        return dataclasses.replace(old_properties, libraryType="crealytics", pathSelection="fileLocation",
                                   targetPathSelection="fileLocation")

    def down(self, new_properties: xlsx.XLSXProperties) -> xlsx.XLSXProperties:
        raise Exception("Downgrade is not implemented for this XLSX version")
