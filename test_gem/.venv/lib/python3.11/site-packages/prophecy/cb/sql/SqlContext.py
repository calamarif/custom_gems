import enum
from dataclasses import dataclass, field
from typing import *

from prophecy.cb.sql.Component import SqlNodeMetadata


@dataclass
class MacroSQLLineNumber:
    startLine: int
    endLine: int


@enum.unique
class DBTMacroType(enum.Enum):
    Macro = "Macro"
    Materialization = "Materialization"
    Query = "Query"
    Unknown = "Unknown"
    Expression = "Expression"

    def getEnum(value):
        if value == "Macro":
            return DBTMacroType.Macro
        elif value == "Materialization":
            return DBTMacroType.Materialization
        elif value == "Query":
            return DBTMacroType.Query
        elif value == "Unknown":
            return DBTMacroType.Unknown
        else:
            return DBTMacroType.Expression


@enum.unique
class StaleState(enum.Enum):
    Nnone = "None"
    File = "File"
    Graph = "Graph"

    def getEnum(value):
        if value == "None":
            return StaleState.Nnone
        elif value == "File":
            return StaleState.File
        else:
            return StaleState.Graph


@dataclass
class MacroArgumentDef:
    name: str
    kind: str  # TODO make enum ?
    defaultValue: str


@dataclass
class MacroDefFromSqlSource:
    name: str
    macroType: DBTMacroType
    definition: str
    parameters: list[MacroArgumentDef]
    staleState: str
    macroDependencies: list[str]
    description: Optional[str]
    lineNumbers: Optional[MacroSQLLineNumber] = field(default_factory=lambda: MacroSQLLineNumber(0, 0))


@dataclass(frozen=True)
class NodeConnection:
    id: str
    source: str
    sourcePort: str
    target: str
    targetPort: str


@dataclass
class SqlGraph:
    connections: List[NodeConnection]
    nodes: Dict[str, SqlNodeMetadata]


@dataclass
class SqlContext:
    graph: SqlGraph
    projectName: str
    projectMacros: list[MacroDefFromSqlSource]
    dependencyProjectMacros: Dict[str, list[MacroDefFromSqlSource]]
