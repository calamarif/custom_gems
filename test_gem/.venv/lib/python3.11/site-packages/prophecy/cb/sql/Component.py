from abc import ABC
from dataclasses import dataclass, replace, field
from typing import *


@dataclass
class MacroParameter(ABC):
    name: str
    value: Optional[str] = None


@dataclass(frozen=True)
class MacroProperties(ABC):
    pass


@dataclass(frozen=True)
class BasicMacroProperties(MacroProperties):
    macroName: str = ''
    parameters: List[MacroParameter] = field(default_factory=list)
    projectName: str = ''

    def to_dict(self):
        return {
            'macroName': self.macroName,
            'projectName': self.projectName,
            'parameters': [{'name': parameter.name, 'value': parameter.value} for parameter in self.parameters]
        }


PropertiesType = TypeVar("PropertiesType", bound=MacroProperties)


@dataclass(frozen=True)
class NodePort:
    id: str
    slug: str
    schema: Optional[str] = None


@dataclass(frozen=True)
class NodePorts:
    inputs: List[NodePort] = field(default_factory=list)
    outputs: List[NodePort] = field(default_factory=list)
    isCustomOutputSchema: bool = False
    autoUpdateOnRun: bool = False
    lastFetchedTime: Optional[int] = None


@dataclass
class SqlNodeMetadata:
    label: str
    slug: Optional[str] = None,
    x: Optional[float] = None,
    y: Optional[float] = None,
    phase: Optional[int] = 0,
    macroDependencies: Optional[List[str]] = None,
    comment: Optional[str] = None,
    dataExplorerProps: Optional[str] = None


@dataclass(frozen=True)
class Component(Generic[PropertiesType]):
    id: str
    component: str
    metadata: SqlNodeMetadata
    properties: PropertiesType
    ports: NodePorts = NodePorts()
    parent: Optional[str] = None

    def bindProperties(self, propertiesV: PropertiesType):
        return replace(self, properties=propertiesV)

    def bindPorts(self, ports: NodePorts):
        return replace(self, ports=ports)
