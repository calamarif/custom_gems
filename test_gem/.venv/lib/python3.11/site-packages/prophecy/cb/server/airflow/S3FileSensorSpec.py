from dataclasses import dataclass, field
from typing import Callable, List, Optional

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.server.base.WorkflowContext import (
    WorkflowContext,
)
from prophecy.cb.ui.uispec import (
    Checkbox,
    Dialog,
    NumberBox,
    SelectBox,
    StackItem,
    StackLayout,
    TabPane,
    Tabs,
    TextArea,
    TextBox,
)
from prophecy.cb.util.StringUtils import isBlank


class S3FileSensor(ComponentSpec):
    name: str = "S3FileSensor"
    category: str = "Sensor"
    gemDescription: str = """This sensor continues to wait for a specific S3 file during the Job run. 
Finishes if the file is found within the time limit, otherwise raises a timeout exception"""

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%").addElement(
                StackLayout(direction="vertical", gap="20px")
                .addElement(
                    StackLayout(direction="horizontal", gap="12px")
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            TextBox(
                                "* S3 Path(s)", placeholder="path/to/file1.csv, path/to/file2.csv"
                            ).bindProperty("s3Paths")
                        )
                    )
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            SelectBox(
                                titleVar="* Connection name",
                                placeholder="aws_default",
                            )
                            .withSearchEnabled()
                            .withNoContentMessage(
                                "No AWS Connection found in current fabric"
                            )
                            .bindProperty("awsConnectionId")
                            .bindOptionProperty("${$.metadata.connections.aws}")
                        )
                    )
                )
                .addElement(
                    StackLayout(direction="horizontal", gap="12px")
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            TextBox(
                                "Bucket name - Leave this blank if using full S3 path",
                                placeholder="",
                            ).bindProperty("bucketName")
                        )
                    )
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            NumberBox(
                                "Sensor timeout in seconds",
                                minValueVar=0,
                                maxValueVar=604800,  # 7 days in seconds
                                placeholder="600",
                            ).bindProperty("timeout")
                        )
                    )
                )
                .addElement(
                    StackLayout(direction="horizontal", gap="12px")
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            Checkbox("Verify SSL Certificates", "verifySslCertificates")
                        )
                    )
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            Checkbox("Wildcard match", "wildCardMatch")
                        )
                    )
                )
                .addElement(
                    StackItem().addElement(
                        TextArea(
                            "Response check code - lambda",
                            placeholder="lambda files: {f.get('Size', 0) > 1048576 for f in files}",
                            rows=2,
                        ).bindProperty("responseCheck")
                    )
                )
            )
        )

    def dialog(self) -> Dialog:
        return Dialog("S3 File Sensor").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class S3FileSensorProperties(ComponentProperties):
        s3Paths: Optional[str] = None
        bucketName: Optional[str] = None
        responseCheck: Optional[Callable] = None
        wildCardMatch: bool = False
        verifySslCertificates: bool = True
        awsConnectionId: Optional[str] = None
        taskId: Optional[str] = None
        timeout: Optional[int] = 600

    def validate(
        self, context: WorkflowContext, component: Component[S3FileSensorProperties]
    ) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties
        if isBlank(props.awsConnectionId):
            diagnostics.append(
                Diagnostic(
                    "properties.awsConnectionId",
                    "Choose an airflow connection",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.s3Paths):
            diagnostics.append(
                Diagnostic(
                    "properties.s3Paths",
                    "Specify S3 path",
                    SeverityLevelEnum.Error,
                )
            )
        return diagnostics

    def onChange(
        self,
        context: WorkflowContext,
        oldState: Component[S3FileSensorProperties],
        newState: Component[S3FileSensorProperties],
    ) -> Component[S3FileSensorProperties]:
        return newState

    class S3FileSensorCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: S3FileSensor.S3FileSensorProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from airflow.providers.amazon.aws.sensors.s3 import S3KeySensor
            from datetime import timedelta

            if isBlank(self.props.bucketName):
                bucket_name = None
            else:
                bucket_name = self.props.bucketName

            bucket_key = [s.strip() for s in self.props.s3Paths.split(",") if s.strip()]

            return S3KeySensor(
                task_id=self.props.taskId,
                bucket_key=bucket_key,
                bucket_name=bucket_name,
                check_fn=self.props.responseCheck,
                aws_conn_id=self.props.awsConnectionId,
                wildcard_match=self.props.wildCardMatch,
                verify=self.props.verifySslCertificates,
                timeout=self.props.timeout,
                **self.settings,
            )
