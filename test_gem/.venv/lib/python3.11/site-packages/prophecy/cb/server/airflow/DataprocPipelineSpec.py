from dataclasses import dataclass, field
from typing import List, Optional

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.server.base.WorkflowContext import WorkflowContext
from prophecy.cb.ui.uispec import (
    ColumnsLayout,
    Condition,
    Dialog,
    NativeText,
    PipelineConfigurationTable,
    PropExpr,
    SelectBox,
    SelectBoxWithTemplate,
    StackItem,
    StackLayout,
    TabPane,
    Tabs,
    TextBoxTemplate,
    TextBox, StringExpr, IDELinkButton, ButtonSize, ButtonVariant, ProphecyIcon, Text,
)
from prophecy.cb.util.StringUtils import isBlank


class DataprocPipeline(ComponentSpec):
    name: str = "DataprocPipeline"
    category: str = "Data Pipelines"
    gemDescription: str = "Runs a Spark Pipeline on Dataproc"
    altProcessLabel: str = "${component.properties.configurations.selectedInstance.value}"

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%")
            .addElement(
                ColumnsLayout(gap="12px", alignY=None, height=None, _children=None).addColumn(
                    SelectBoxWithTemplate(
                        titleVar="* Pipeline to schedule",
                        placeholder="Please select a pipeline",
                    )
                    .withOptionCTA(
                        IDELinkButton(titleVar="", size=ButtonSize.s,
                                      variant=ButtonVariant.secondaryGrey,
                                      projectId="${component.properties.projectId}",
                                      ide="Workflow", entityType="Pipeline",
                                      entityId="${component.properties.pipelineId.value}",
                                      navigatingTo="${component.properties.pipelineId.value}")
                        .addElement(
                            StackLayout(direction="horizontal", gap="8px",
                                        alignY="center",
                                        align="center")
                            .addElement(ProphecyIcon(type="default",
                                                     iconName="ArrowNarrowUpRightIcon"))
                            .addElement(Text(_children=[NativeText("Open")])))
                    )
                    .withAllowConfig()
                    .withSearchEnabled()
                    .withStyle({"width": "100%"})
                    .withNoContentMessage("No Pipelines Found")
                    .bindProperty("pipelineId")
                    .bindOptionProperty("${$.metadata.projects}")
                    .withIdentifier("record")
                    .withGroupName()
                    .addTemplate(
                        TextBoxTemplate.create_pipeline_template(
                            "title", "pipelines"
                        )
                    ),
                    width="1fr",
                )
                .addColumn(
                    SelectBoxWithTemplate(
                        titleVar="* Fabric & Job size to run this pipeline",
                        placeholder="Please select a Fabric & Job Size",
                    )
                    .withSearchEnabled()
                    .withNoContentMessage("No Dataproc fabric found")
                    .bindProperty("clusterSize")
                    .bindOptionProperty("${$.metadata.dataproc_fabrics}")
                    .withIdentifier("record")
                    .withGroupName()
                    .addTemplate(
                        TextBoxTemplate.create_job_size_template(
                            "title", "job_sizes"
                        )
                    ),
                    width="1fr",
                )
                .addColumn()  # just to add spaces between the two columns
            )
            .addElement(
                ColumnsLayout(gap="1rem")
                .addColumn(
                    SelectBox(
                        titleVar="GCP Connection Id",
                        placeholder="google_cloud_default",
                    )
                    .withSearchEnabled()
                    .withNoContentMessage("No GCP Connection Id found")
                    .bindProperty("gcpConnId")
                    .bindOptionProperty("${$.metadata.connections.gcp}"),
                    width="1fr",
                )
                .addColumn(
                    TextBox(
                        "Dataproc Cluster Id Override",
                        "clusterId",
                        True,
                        placeholder="{{ ti.xcom_pull('DataprocCreateCluster_0') }}",
                    ),
                    width="1fr",
                )
            )
            .addElement(
                StackItem(grow=1).addElement(
                    Condition()
                    .ifEqual(PropExpr("component.properties.pipelineId.type"), StringExpr("literal"))
                    .then(
                        StackLayout(height="100%")
                        .addElement(NativeText("Set Pipeline Configurations"))
                        .addElement(PipelineConfigurationTable())
                    )
                    .otherwise(
                        ColumnsLayout(gap="12px", alignY=None, height=None, _children=None).addColumn(
                            SelectBox(
                                titleVar="Select pipeline configuration instance",
                                placeholder="Please select a pipeline",
                            )
                            .withAllowConfig()
                            .withStyle({"width": "100%"})
                            .withSearchEnabled()
                            .withNoContentMessage("No pipeline configuration found")
                            .bindProperty("configurations.selectedInstance")
                            .addOption("default", "default")
                            .withIdentifier("record")
                        ).addColumn(
                            SelectBox(
                                titleVar="Select override configs",
                                placeholder="Select override configs",
                            )
                            .withSearchEnabled()
                            .withAllowConfig()
                            .withStyle({"width": "100%"})
                            .withNoContentMessage("No Override configs")
                            .bindProperty("configurations.overrides")
                            .withIdentifier("record")
                        ).addColumn()
                    )
                )
            )
        )

    def dialog(self) -> Dialog:
        return Dialog("Pipeline").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class DataprocPipelineProperties(ComponentProperties):
        pipelineId: Optional[dict] = None
        clusterSize: Optional[str] = None
        clusterId: Optional[str] = None
        gcpConnId: Optional[str] = "google_cloud_default"
        job: Optional[dict] = None
        region: Optional[str] = None
        projectId: Optional[str] = None
        taskId: Optional[str] = None

    def validate(self, context: WorkflowContext, component: Component[DataprocPipelineProperties]) -> List[
        Diagnostic]:
        return []

    def onChange(
            self,
            context: WorkflowContext,
            oldState: Component[DataprocPipelineProperties],
            newState: Component[DataprocPipelineProperties],
    ) -> Component[DataprocPipelineProperties]:
        return newState

    class DataprocPipelineCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: DataprocPipeline.DataprocPipelineProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from datetime import timedelta
            from airflow.providers.google.cloud.operators.dataproc import DataprocSubmitJobOperator  # noqa

            return DataprocSubmitJobOperator(
                task_id=self.props.taskId,
                job=self.props.job,
                region=self.props.region,
                project_id=self.props.projectId,
                gcp_conn_id=self.props.gcpConnId
            )
