from dataclasses import dataclass, field
from typing import List, Optional

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.WorkflowContext import WorkflowContext
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.server.base.datatypes import SString
from prophecy.cb.ui.uispec import (
    ColumnsLayout,
    Dialog,
    StackLayout,
    TabPane,
    Tabs,
    Editor,
    SelectBox,
    TextBox,
)
from prophecy.cb.util.StringUtils import isBlank


class SnowflakeSQL(ComponentSpec):
    name: str = "SnowflakeSQL"
    category: str = "Data Pipelines"

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%").addElement(
                StackLayout(align="space-between", direction="vertical", height="100%")
                .addElement(
                    ColumnsLayout(gap="1rem")
                    .addColumn(
                        SelectBox(
                            titleVar="Snowflake Connection Id",
                            placeholder="snowflake_default",
                        )
                        .withSearchEnabled()
                        .withNoContentMessage("No Snowflake Connection Id found")
                        .bindProperty("connId")
                        .bindOptionProperty(
                            "${$.metadata.connections.snowflakedirect}"
                        ),
                        width="1fr",
                    )
                    .addColumn(
                        TextBox(
                            titleVar="Warehouse (Optional)",
                            placeholder="",
                        ).bindProperty("warehouseName"),
                        width="1fr",
                    )
                )
                .addElement(
                    ColumnsLayout(gap="1rem")
                    .addColumn(
                        TextBox(
                            titleVar="Database (Optional)",
                            placeholder="",
                        ).bindProperty("databaseName"),
                        width="1fr",
                    )
                    .addColumn(
                        TextBox(
                            titleVar="Schema (Optional)",
                            placeholder="",
                        ).bindProperty("schemaName"),
                        width="1fr",
                    )
                )
                .addElement(
                    ColumnsLayout(height="100%").addColumn(
                        Editor(height="100%").bindLanguage("sql").bindProperty("code"),
                        "2fr",
                    )
                )
            )
        )

    def dialog(self) -> Dialog:
        return Dialog("Pipeline").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class SnowflakeSQLProperties(ComponentProperties):
        connId: Optional[str] = ""
        language: str = "sql"
        taskId: Optional[str] = None
        code: SString = field(default_factory=lambda: SString(""))
        warehouseName: str = ""
        databaseName: str = ""
        schemaName: str = ""

    def validate(
        self, context: WorkflowContext, component: Component[SnowflakeSQLProperties]
    ) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties
        settings: Optional[dict] = component.settings
        if settings:
            xcom_settings: Optional[bool] = settings.get("do_xcom_push")
        else :
            xcom_settings: Optional[bool] = None
        resolved = props.code.value
        if isBlank(resolved):
            diagnostics.append(
                Diagnostic(
                    "properties.code",
                    "SQL query cannot be empty",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.connId):
            diagnostics.append(
                Diagnostic(
                    "properties.connId",
                    "Select a Snowflake Connection",
                    SeverityLevelEnum.Error,
                )
            )
        if not xcom_settings:
            diagnostics.append(
                Diagnostic(
                    "settings",
                    "Snowflake Xcom outputs can incur significant cost and take time. Disable Xcom if not needed",
                    SeverityLevelEnum.Warning,
                )
            )
        return diagnostics

    def onChange(
        self,
        context: WorkflowContext,
        oldState: Component[SnowflakeSQLProperties],
        newState: Component[SnowflakeSQLProperties],
    ) -> Component[SnowflakeSQLProperties]:
        return newState

    class SnowflakeSQLCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: SnowflakeSQL.SnowflakeSQLProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from airflow.providers.snowflake.operators.snowflake import (
                SnowflakeOperator,
            )  # noqa
            from datetime import timedelta

            return SnowflakeOperator(
                task_id=self.props.taskId,
                sql=self.props.code.value,
                snowflake_conn_id=self.props.connId,
                warehouse=self.props.warehouseName.strip(),
                database=self.props.databaseName.strip(),
                schema=self.props.schemaName.strip(),
                **self.settings
            )
