from prophecy.cb.server.airflow.common.SettingsTab import *
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.server.base.WorkflowContext import (
    WorkflowContext,
)
from prophecy.cb.ui.uispec import *
from prophecy.cb.util.StringUtils import isBlank


class SFTPSensorSpec(ComponentSpec):
    name: str = "SFTPSensor"
    category: str = "Sensor"
    gemDescription: str = """This sensor continues to wait for a file on SFTP path to be available during the Job run. 
    Finishes if the files becomes available within the time limit, otherwise raises a timeout exception"""

    @staticmethod
    def properties_tab():
        return (StackLayout(direction="vertical", width="30%", padding="1em")
        .addElement(
            StackItem(grow=1).addElement(
                StackLayout(direction="vertical", gap="20px", width="100%")
                .addElement(TitleElement("Select and Configure the Sensor:"))
                .addElement(
                    SelectBox(
                        titleVar="*SFTP Connection",
                        placeholder="sftp_default",
                        helpText="The connection added in Prophecy for SFTP auth"
                    ).withHelpText("The connection added in Prophecy for SFTP auth")
                    .withSearchEnabled()
                    .withNoContentMessage(
                        "No Sftp Connection found in current fabric"
                    )
                    .bindProperty("sftpConnectionId")
                    .bindOptionProperty("${$.metadata.connections.sftp}")
                )

                .addElement(
                    RadioGroup(_title="", gap="20px", orientation="vertical")
                    .bindProperty("use_file_pattern")
                    .addOption("Use complete file path", False)
                    .addOption("Use pattern matching", True)
                )
                .addElement(Condition()
                .ifEqual(
                    PropExpr("component.properties.use_file_pattern"),
                    BooleanExpr(True),
                )
                .then(
                    TextBox("*SFTP Path", placeholder="path/to/your/directory",
                            helpText="Remote file or directory path").bindProperty(
                        "file_path"
                    )
                ))
                .addElement(
                    Condition()
                    .ifEqual(
                        PropExpr("component.properties.use_file_pattern"),
                        BooleanExpr(True),
                    )
                    .then(
                        TextBox("File pattern", placeholder="*.csv",
                                helpText="The pattern that will be used to match the file").bindProperty(
                            "file_pattern"
                        )
                    )
                )
                .addElement(
                    Condition()
                    .ifEqual(
                        PropExpr("component.properties.use_file_pattern"),
                        BooleanExpr(False),
                    )
                    .then(
                        TextBox("*SFTP Path", placeholder="path/to/your/file.csv",
                                helpText="Remote file or directory path").bindProperty(
                            "file_path"
                        )
                    )
                )
            ))
        )

    def dialog(self) -> Dialog:
        return Dialog("SFTP Sensor").addElement(
            StackLayout(direction="horizontal").addElement(
                FieldPickerWithTabs("Properties")
                .addTab(
                    PickerTab("Sensor Settings", "SFTPSensorProperties")
                    .addField(NumberBox(
                        "Poke interval (seconds)",
                        minValueVar=0,
                        maxValueVar=604800,  # 7 days in seconds
                        placeholder="60").withHelpText("Interval between job retries"),
                              "pokeInterval", hideDelete=True)
                    .addField(NumberBox(
                        "Sensor timeout (seconds)",
                        minValueVar=0,
                        maxValueVar=604800,  # 7 days in seconds
                        placeholder="600",
                    ).withHelpText("Task timeout duration")
                              , "timeout", hideDelete=True)
                )
                .addTab(
                    PickerTab("Gem Settings", "GemSettings", False, propertyVar="component.settings")
                    .addFields(settings_field_picker().fields)
                )
            )
            .addElement(SFTPSensorSpec.properties_tab())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class SFTPSensorProperties(ComponentProperties):
        file_path: Optional[str] = None
        file_pattern: Optional[str] = None
        use_file_pattern: bool = False
        pokeInterval: int = 60
        timeout: int = 600
        sftpConnectionId: Optional[str] = None
        taskId: Optional[str] = None

    def validate(
            self, context: WorkflowContext, component: Component[SFTPSensorProperties]
    ) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties
        if isBlank(props.sftpConnectionId):
            diagnostics.append(
                Diagnostic(
                    "properties.sftpConnectionId",
                    "Choose an SFTP connection",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.file_path):
            diagnostics.append(
                Diagnostic(
                    "properties.file_path",
                    "Please provide SFTP path",
                    SeverityLevelEnum.Error,
                )
            )
        if props.pokeInterval is None:
            diagnostics.append(
                Diagnostic(
                    "properties.pokeInterval",
                    "Specify poke interval",
                    SeverityLevelEnum.Error,
                )
            )
        if props.timeout is None:  # TODO: this is giving error
            diagnostics.append(
                Diagnostic(
                    "properties.timeout",
                    "Specify Sensor interval",
                    SeverityLevelEnum.Error,
                )
            )
        return diagnostics

    def onChange(
            self,
            context: WorkflowContext,
            oldState: Component[SFTPSensorProperties],
            newState: Component[SFTPSensorProperties],
    ) -> Component[SFTPSensorProperties]:
        return newState

    class SFTPSensorCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: SFTPSensorSpec.SFTPSensorProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from airflow.providers.sftp.sensors.sftp import SFTPSensor
            return SFTPSensor(
                task_id=self.props.taskId,
                path=self.props.file_path,
                file_pattern=self.props.file_pattern,
                sftp_conn_id=self.props.sftpConnectionId,
                poke_interval=self.props.pokeInterval,
                timeout=self.props.timeout,
                **self.settings,
            ) if self.props.use_file_pattern else SFTPSensor(
                task_id=self.props.taskId,
                path=self.props.file_path,
                sftp_conn_id=self.props.sftpConnectionId,
                poke_interval=self.props.pokeInterval,
                timeout=self.props.timeout,
                **self.settings,
            )
