from dataclasses import dataclass, field
from typing import Callable, List, Optional

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.WorkflowContext import (
    WorkflowContext,
    EmptyWorkflowContext,
)
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.ui.uispec import (
    Code,
    Dialog,
    NumberBox,
    SelectBox,
    StackItem,
    StackLayout,
    TabPane,
    Tabs,
    TextArea,
    TextBox,
)
from prophecy.cb.util.StringUtils import isBlank


class HTTPSensor(ComponentSpec):
    name: str = "HTTPSensor"
    category: str = "Sensor"
    gemDescription: str = """This sensor continues to wait for a specific HTTP endpoint to be available during the Job run. 
Finishes if the endpoint becomes available within the time limit, otherwise raises a timeout exception"""

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%").addElement(
                StackLayout(direction="vertical", gap="20px")
                .addElement(
                    StackLayout(direction="horizontal", gap="12px")
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            TextBox("Endpoint", placeholder="/status").bindProperty(
                                "endpoint"
                            )
                        )
                    )
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            SelectBox(
                                titleVar="* Connection name",
                                placeholder="http_default",
                            )
                            .withSearchEnabled()
                            .withNoContentMessage(
                                "No Http Connection found in current fabric"
                            )
                            .bindProperty("httpConnectionId")
                            .bindOptionProperty("${$.metadata.connections.http}")
                        )
                    )
                )
                .addElement(
                    StackLayout(direction="horizontal", gap="12px")
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            TextBox(
                                "Request Params", placeholder="{'param1': 'value1', 'param2': 'value2'}"
                            ).bindProperty("requestParams")
                        )
                    )
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            TextBox(
                                "Request Headers", placeholder="{ 'Content-Type': 'application/json' }"
                            ).bindProperty("requestHeaders")
                        )
                    )
                )
                .addElement(
                    StackLayout(direction="horizontal", gap="12px")
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            NumberBox(
                                "Poke interval in seconds",
                                minValueVar=0,
                                maxValueVar=604800,  # 7 days in seconds
                                placeholder="60",
                            ).bindProperty("pokeInterval")
                        )
                    )
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            NumberBox(
                                "Sensor timeout in seconds",
                                minValueVar=0,
                                maxValueVar=604800,  # 7 days in seconds
                                placeholder="600",
                            ).bindProperty("timeout")
                        )
                    )
                )
                .addElement(
                    StackItem().addElement(
                        TextArea(
                            "Response check code - lambda",
                            placeholder="lambda response: response.status_code == 200",
                            rows=2,
                        ).bindProperty("responseCheck")
                    )
                )
            )
        )

    def dialog(self) -> Dialog:
        return Dialog("HTTP Sensor").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class HTTPSensorProperties(ComponentProperties):
        endpoint: Optional[str] = ""
        requestParams: Optional[dict] = None
        requestHeaders: Optional[dict] = None
        responseCheck: Optional[Callable] = None
        pokeInterval: Optional[int] = 60
        timeout: Optional[int] = 600
        httpConnectionId: Optional[str] = None
        taskId: Optional[str] = None

    def validate(
        self, context: WorkflowContext, component: Component[HTTPSensorProperties]
    ) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties
        if isBlank(props.httpConnectionId):
            diagnostics.append(
                Diagnostic(
                    "properties.httpConnectionId",
                    "Choose an airflow connection",
                    SeverityLevelEnum.Error,
                )
            )
        if props.pokeInterval is None:
            diagnostics.append(
                Diagnostic(
                    "properties.pokeInterval",
                    "Specify poke interval",
                    SeverityLevelEnum.Error,
                )
            )
        return diagnostics

    def onChange(
        self,
        context: WorkflowContext,
        oldState: Component[HTTPSensorProperties],
        newState: Component[HTTPSensorProperties],
    ) -> Component[HTTPSensorProperties]:
        return newState

    class HTTPSensorCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: HTTPSensor.HTTPSensorProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from airflow.providers.http.sensors.http import HttpSensor
            from datetime import timedelta

            # Execution timeout is airflow task level execution timeout
            # Sensor timeout will be different. Should be handled separately

            return HttpSensor(
                task_id=self.props.taskId,
                endpoint=self.props.endpoint,
                request_params=self.props.requestParams,
                headers=self.props.requestHeaders,
                response_check=self.props.responseCheck,
                http_conn_id=self.props.httpConnectionId,
                poke_interval=self.props.pokeInterval,
                timeout=self.props.timeout,
                **self.settings,
            )
