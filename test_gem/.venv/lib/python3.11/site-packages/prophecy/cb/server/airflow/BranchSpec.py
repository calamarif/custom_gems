from typing import Optional, Callable

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.WorkflowContext import WorkflowContext, EmptyWorkflowContext
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.server.base.ComponentBuilderBase import ComponentSpec
from prophecy.cb.server.base.datatypes import SString, SInt
from prophecy.cb.ui.uispec import (
    Editor,
    List,
    StackLayout,
    dataclass,
    TextArea, Text, NativeText,
)
from prophecy.cb.ui.uispec import Dialog, TabPane, Tabs
from prophecy.cb.util.StringUtils import isBlank


class Branch(ComponentSpec):
    name: str = "Branch"
    category: str = "Custom"

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%", width="100%")
            .addElement(
                StackLayout(align="start", gap="1rem", direction="vertical", width="100%")
                .addElement(Text(_children=[NativeText("Must be a Python lambda or function")]))
                .addElement(Editor(height="600px").bindLanguage("python").bindProperty("callback"))
            )
        )


    def dialog(self) -> Dialog:
        return Dialog("Branch").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True


    @dataclass(frozen=True)
    class BranchProperties(ComponentProperties):
        callback: Optional[Callable] = None
        taskId: Optional[str] = None

    def validate(self, context: WorkflowContext, component: Component[BranchProperties]) -> List[Diagnostic]:
        diagnostics = []
        code_absent_msg = "Python callback must be defined"
        if isBlank(component.properties.callback):
            diagnostics.append(
                Diagnostic(
                    "properties.code", code_absent_msg, SeverityLevelEnum.Error
                )
            )
        return diagnostics

    def onChange(
        self,
        context: WorkflowContext,
        oldState: Component[BranchProperties],
        newState: Component[BranchProperties],
    ) -> Component[BranchProperties]:
        return newState

    class BranchCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: Branch.BranchProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from datetime import timedelta
            from airflow.operators.python import BranchPythonOperator

            return BranchPythonOperator(
                task_id=self.props.taskId,
                python_callable=self.props.callback,
                **self.settings
            )
