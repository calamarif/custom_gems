from typing import Optional
from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.server.base.ComponentBuilderBase import ComponentSpec
from prophecy.cb.server.base.WorkflowContext import WorkflowContext
from prophecy.cb.server.base.datatypes import SString
from prophecy.cb.ui.uispec import *
from prophecy.cb.ui.uispec import Dialog, TabPane, Tabs
from prophecy.cb.util.StringUtils import isBlank


class Script(ComponentSpec):
    name: str = "Script"
    category: str = "Custom"

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%")
            .addElement(
                StackLayout(align="start", gap="5rem", direction="horizontal")
                .addElement(Text(_children=[NativeText("Language: Shell")]))

            )
            .addElement(
            Editor(height="600px")
            .bindLanguage("sh")
            .bindProperty("code")  # TODO add bash support

            )
        )

    def dialog(self) -> Dialog:
        return Dialog("Script").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class ScriptProperties(ComponentProperties):
        code: SString = field(default_factory=lambda: SString(""))
        language: SString = field(default_factory=lambda: SString("bash"))
        taskId: Optional[str] = None

    def validate(self, context: WorkflowContext, component: Component[ScriptProperties]) -> List[Diagnostic]:
        diagnostics = []
        code_absent_msg = "Add code in script"
        if (
            component.properties.code.diagnosticMessages is not None
            and len(component.properties.code.diagnosticMessages) > 0
        ):
            for message in component.properties.code.diagnosticMessages:
                diagnostics.append(
                    Diagnostic("properties.code", message, SeverityLevelEnum.Error)
                )
        else:
            resolved = component.properties.code.value
            if isBlank(resolved):
                diagnostics.append(
                    Diagnostic(
                        "properties.code", code_absent_msg, SeverityLevelEnum.Error
                    )
                )
        return diagnostics

    def onChange(
        self,
        context: WorkflowContext,
        oldState: Component[ScriptProperties],
        newState: Component[ScriptProperties],
    ) -> Component[ScriptProperties]:
        return newState

    class ScriptCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: Script.ScriptProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from datetime import timedelta
            if self.props.language.value == "python":
                from airflow.operators.python import PythonOperator

                return PythonOperator(
                    task_id=self.props.taskId,
                    python_callable=lambda *args, **kwargs: exec(self.props.code.value),
                    **self.settings
                )

            else:
                from airflow.operators.bash import BashOperator

                return BashOperator(
                    task_id=self.props.taskId,
                    bash_command=self.props.code.value,
                    **self.settings
                )
