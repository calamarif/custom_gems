from abc import abstractmethod, ABC
from dataclasses import dataclass, field
from typing import Optional, TypeVar, Generic

from pyspark.sql.types import StructType

from prophecy.cb.migration import PropertyMigration, PropertyMigrationObj
from prophecy.cb.server.base.WorkflowContext import WorkflowContext
from prophecy.cb.server.base.ComponentBuilderBase import NodeMetadata, NodePorts, Diagnostic, SeverityLevelEnum
from prophecy.cb.ui.uispec import DatasetDialog
from dataclasses import replace


class DatasetProperties(ABC):
    @property
    @abstractmethod
    def schema(self) -> Optional[StructType]:
        pass


PropertiesType = TypeVar("PropertiesType", bound=DatasetProperties)


@dataclass(frozen=True)
class Component(Generic[PropertiesType]):
    id: str
    component: str
    metadata: NodeMetadata
    properties: PropertiesType
    ports: NodePorts = field(default_factory=NodePorts)
    group: Optional[str] = None

    def bindProperties(self, propertiesV: PropertiesType):
        return replace(self, properties=propertiesV)


class DatasetSpec(ABC):
    @property
    @abstractmethod
    def name(self) -> str:
        pass

    @property
    @abstractmethod
    def datasetType(self) -> str:
        pass

    @property
    def docUrl(self) -> str:
        pass

    mode = "batch"

    def sourceDialog(self) -> DatasetDialog:
        pass

    def targetDialog(self) -> DatasetDialog:
        pass

    def validate(self, context: WorkflowContext, component: Component) -> list:
        diagnostics = list()
        if component.properties.schema is not None:
            fieldNames = set()
            for idx, fieldName in enumerate(component.properties.schema.fieldNames()):
                if len(fieldName) == 0:
                    diagnostics.append(
                        Diagnostic(f"properties.schema.fields[{idx}].name", "Field name cannot be empty [Properties]",
                                   SeverityLevelEnum.Error))
                elif fieldName.lower() in fieldNames:
                    diagnostics.append(
                        Diagnostic(f"properties.schema.fields[{idx}].name", f"Duplicate column name {fieldName}",
                                   SeverityLevelEnum.Error))
                fieldNames.add(fieldName.lower())
        return diagnostics

    @abstractmethod
    def onChange(self, context: WorkflowContext, oldState: Component, newState: Component) -> Component:
        pass

    @abstractmethod
    def optimizeCode(self) -> bool:
        pass

    def __init__(self):
        self._migrations: list[PropertyMigration] = []

    def registerPropertyEvolution(self, *newMigrations):
        for migration in newMigrations:
            self._migrations.append(migration)

    def latestMigrationNumber(self) -> int:
        if len(self._migrations) > 0:
            return max([x.migrationNumber() for x in self._migrations])
        else:
            return 0

    def migrateUp(self, oldComponent: Component, currentMigrationNumber: int) -> Component:
        newProperties = oldComponent.properties
        for idx, migration in enumerate(sorted(self._migrations, key=lambda x: x.migrationNumber())):
            if migration.migrationNumber() <= currentMigrationNumber:
                pass
            else:
                if isinstance(migration, PropertyMigrationObj):
                    newProperties = migration.up(newProperties)
        newComponent = oldComponent.bindProperties(newProperties)
        return newComponent

    def migrateDown(self, newComponent: Component, targetMigrationNumber: int) -> Component:
        oldProperties = newComponent.properties
        for idx, migration in enumerate(sorted(self._migrations, key=lambda x: x.migrationNumber(), reverse=True)):
            if migration.migrationNumber() <= targetMigrationNumber:
                pass
            else:
                if isinstance(migration, PropertyMigrationObj):
                    oldProperties = migration.down(oldProperties)
        oldComponent = newComponent.bindProperties(oldProperties)
        return oldComponent

