from abc import ABC, abstractmethod
from typing import Optional, List, TypeVar, Generic

from prophecy.config import ConfigBase
from pyspark.sql import DataFrame, SparkSession
from dataclasses import dataclass, field, replace
from prophecy.cb.server.base.ComponentBuilderBase import Component, Diagnostic, NodeMetadata, NodePorts
from prophecy.cb.server.base.WorkflowContext import WorkflowContext
from prophecy.cb.ui.uispec import Dialog

class MetaComponentProperties(ABC):
    pass

PropertiesType = TypeVar("PropertiesType", bound=MetaComponentProperties)

@dataclass(frozen=True)
class MetaVisualProperty:
    isInputNodeHidden: bool = False
    isOutputNodeHidden: bool = False

@dataclass(frozen=True)
class MetaComponent(Generic[PropertiesType]):
    id: str
    component: str
    metadata: NodeMetadata
    properties: PropertiesType
    ports: NodePorts = field(default_factory=NodePorts)
    subgraph_ports: NodePorts = field(default_factory=NodePorts)
    # processes will be exposed in future
    # processes: Optional[list] = None
    group: Optional[str] = None
    visualProperty: MetaVisualProperty = field(default_factory=MetaVisualProperty)

    def bindProperties(self, propertiesV: PropertiesType):
        return replace(self, properties=propertiesV)

    def bindPorts(self, ports: NodePorts):
        return replace(self, ports=ports)

class MetaComponentSpec(ABC):
    @property
    @abstractmethod
    def name(self) -> str:
        pass

    @property
    @abstractmethod
    def category(self) -> str:
        pass

    @property
    def docUrl(self) -> Optional[str]:
        return None

    @property
    def interimRowName(self) -> str:
        return "Run Count"

    @property
    def gemDescription(self) -> Optional[str]:
        return None

    @abstractmethod
    def dialog(self) -> Dialog:
        pass

    @abstractmethod
    def validate(self, context: WorkflowContext, component: MetaComponent) -> List[Diagnostic]:
        pass

    @abstractmethod
    def onChange(self, context: WorkflowContext, oldState: MetaComponent, newState: MetaComponent) -> MetaComponent:
        pass

    def optimizeCode(self) -> bool:
        pass

    def allInputsRequired(self) -> bool:
        True

class MetaComponentCode(ABC):
    def __run__(self, spark: SparkSession, config: ConfigBase, *inDFs: DataFrame) -> (List[DataFrame]):
        pass

class ColumnConfigAutoPopulateSpec(ABC):
    @property
    def portNumberToProp(self)-> list:
        return []