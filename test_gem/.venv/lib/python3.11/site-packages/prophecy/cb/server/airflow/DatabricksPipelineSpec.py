from dataclasses import dataclass, field
from typing import List, Optional

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.server.base.WorkflowContext import WorkflowContext
from prophecy.cb.ui.uispec import (
    ColumnsLayout,
    Condition,
    Dialog,
    NativeText,
    PipelineConfigurationTable,
    PropExpr,
    SelectBoxWithTemplate,
    StackItem,
    StackLayout,
    TabPane,
    Tabs,
    TextBoxTemplate, StringExpr, SelectBox, ImagePlaceholder, Gem, IDELinkButton, ButtonSize, ButtonVariant,
    ProphecyIcon, Text
)
from prophecy.cb.util.StringUtils import isBlank


class DatabricksPipeline(ComponentSpec):
    name: str = "DatabricksPipeline"
    category: str = "Data Pipelines"
    gemDescription: str = "Runs a Pipeline on Databricks"
    altProcessLabel: str = "${component.properties.configurations.selectedInstance.value}"

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%")
            .addElement(
                ColumnsLayout(gap="12px", alignY=None, height=None, _children=None).addColumn(
                    SelectBoxWithTemplate(
                        titleVar="Pipeline to schedule",
                        placeholder="Please select a pipeline",
                    )
                    .withOptionCTA(
                        IDELinkButton(titleVar="", size=ButtonSize.s,
                                      variant=ButtonVariant.secondaryGrey,
                                      projectId="${component.properties.projectId}",
                                      ide="Workflow", entityType="Pipeline",
                                      entityId="${component.properties.pipelineId.value}",
                                      navigatingTo="${component.properties.pipelineId.value}")
                        .addElement(
                            StackLayout(direction="horizontal", gap="8px",
                                        alignY="center",
                                        align="center")
                            .addElement(ProphecyIcon(type="default",
                                                     iconName="ArrowNarrowUpRightIcon"))
                            .addElement(Text(_children=[NativeText("Open")])))
                    )
                    .withSearchEnabled()
                    .withAllowConfig()
                    .withStyle({"width": "100%"})
                    .withNoContentMessage("No Pipelines Found")
                    .bindProperty("pipelineId")
                    .bindOptionProperty("${$.metadata.projects}")
                    .withIdentifier("record")
                    .addTemplate(
                        TextBoxTemplate.create_pipeline_template(
                            "title", "pipelines"
                        )
                    )
                ).addColumn(
                    SelectBoxWithTemplate(
                        titleVar="Fabric & Cluster size to run this pipeline",
                        placeholder="Please select a Fabric & Cluster Size",
                    )
                    .withSearchEnabled()
                    .withNoContentMessage("No Databricks fabric found")
                    .bindProperty("clusterSize")
                    .bindOptionProperty("${$.metadata.fabrics}")
                    .withIdentifier("record")
                    .withGroupName()
                    .addTemplate(
                        TextBoxTemplate.create_job_size_template(
                            "title", "job_sizes"
                        )
                    ),
                    width="1fr",
                )
                .addColumn()  # just to add spaces between the two columns
            )
            .addElement(
                StackItem(grow=1).addElement(
                    Condition()
                    .ifEqual(PropExpr("component.properties.pipelineId.type"), StringExpr("literal"))
                    .then(
                        StackLayout(height="100%")
                        .addElement(NativeText("Set Pipeline Configurations"))
                        .addElement(PipelineConfigurationTable())
                    )
                    .otherwise(
                        Condition()
                        .ifExists(PropExpr("component.properties.pipelineId"))
                        .then(
                            ColumnsLayout(gap="12px", alignY=None, height=None, _children=None).addColumn(
                                SelectBox(
                                    titleVar="Select pipeline configuration instance",
                                    placeholder="Please select a pipeline",
                                )
                                .withAllowConfig()
                                .withStyle({"width": "100%"})
                                .withSearchEnabled()
                                .withNoContentMessage("No pipeline configuration found")
                                .bindProperty("configurations.selectedInstance")
                                .addOption("default", "default")
                                .withIdentifier("record")
                            ).addColumn(
                                SelectBox(
                                    titleVar="Select override configs",
                                    placeholder="Select override configs",
                                )
                                .withSearchEnabled()
                                .withAllowConfig()
                                .withStyle({"width": "100%"})
                                .withNoContentMessage("No Override configs")
                                .bindProperty("configurations.overrides")
                                .withIdentifier("record")
                            ).addColumn()
                        )
                    )
                )
            )
        )

    def dialog(self) -> Dialog:
        return Dialog("Pipeline").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class PipelineProperties(ComponentProperties):
        pipelineId: Optional[dict] = None
        clusterSize: Optional[str] = ""
        databricksConnId: Optional[str] = ""
        runJson: Optional[dict] = None
        taskId: Optional[str] = None

    def validate(self, context: WorkflowContext, component: Component[PipelineProperties]) -> List[Diagnostic]:
        return []

    def onChange(
            self,
            context: WorkflowContext,
            oldState: Component[PipelineProperties],
            newState: Component[PipelineProperties],
    ) -> Component[PipelineProperties]:
        return newState

    class PipelineCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: DatabricksPipeline.PipelineProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from datetime import timedelta
            from airflow.providers.databricks.operators.databricks import DatabricksSubmitRunOperator  # noqa

            return DatabricksSubmitRunOperator(  # noqa
                task_id=self.props.taskId,
                json=self.props.runJson,
                databricks_conn_id=self.props.databricksConnId
            )
