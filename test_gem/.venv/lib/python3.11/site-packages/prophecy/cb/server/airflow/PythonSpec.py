import json
from typing import Optional, Callable

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.WorkflowContext import WorkflowContext
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.server.base.ComponentBuilderBase import ComponentSpec
from prophecy.cb.ui.uispec import (
    Editor,
    List,
    StackLayout,
    dataclass,
    TextArea,
    TextBox,
    StackItem,
    FieldPicker,
    Checkbox,
)
from prophecy.cb.ui.uispec import Dialog, TabPane, Tabs
from prophecy.cb.util.StringUtils import isBlank


class Python(ComponentSpec):
    name: str = "Python"
    category: str = "Custom"

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="20px", height="100%", direction="horizontal")
            .addElement(
                StackItem().addElement(
                    FieldPicker()
                    .addField(
                        TextArea(
                            "Op Kwargs (dict)", rows=4, placeholder='{"key":"value"}'
                        ),
                        "opKwargs",
                    )
                    .addField(
                        TextBox("Op Args (list)", placeholder='["abc", 42, 3.14]'),
                        "opArgs",
                    )
                    .addField(
                        TextArea(
                            "Templates Dict (dict)",
                            rows=4,
                            placeholder='{"key":"value"}',
                        ),
                        "templatesDict",
                    )
                    .addField(
                        TextBox(
                            "Templates Exts (list)", placeholder='[".sql", ".hql"]'
                        ),
                        "templatesExts",
                    )
                    .addField(Checkbox("Show Return Value in Logs"), "valueInLogs")
                )
            )
            .addElement(
                StackItem(grow="1").addElement(
                    Editor(height="500px").bindLanguage("python").bindProperty("code")
                )
            )
        )

    def dialog(self) -> Dialog:
        return Dialog("Python").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class PythonProperties(ComponentProperties):
        code: Optional[Callable] = ""
        opKwargs: Optional[str] = None
        opArgs: Optional[str] = None
        templatesDict: Optional[str] = None
        templatesExts: Optional[str] = None
        valueInLogs: Optional[bool] = True
        taskId: Optional[str] = None

    def validateProperties(
        self, propName: str, propValue: any, propType: str, diagnostics: list
    ):
        try:
            kwargs = json.loads(propValue)
            if kwargs.__class__.__name__ != propType:
                diagnostics.append(
                    Diagnostic(
                        f"properties.{propName}",
                        f"{propName} must be a {propType} only",
                        SeverityLevelEnum.Error,
                    )
                )
        except:
            diagnostics.append(
                Diagnostic(
                    f"properties.{propName}", "Invalid Json", SeverityLevelEnum.Error
                )
            )

    def validate(self, context: WorkflowContext, component: Component[PythonProperties]) -> List[Diagnostic]:
        diagnostics = []
        code_absent_msg = "Add code in script"
        props = component.properties
        if isBlank(props.code):
            diagnostics.append(
                Diagnostic("properties.code", code_absent_msg, SeverityLevelEnum.Error)
            )
        if props.opKwargs is not None:
            self.validateProperties("opKwargs", props.opKwargs, "dict", diagnostics)
        if props.templatesDict is not None:
            self.validateProperties(
                "templatesDict", props.templatesDict, "dict", diagnostics
            )
        if props.opArgs is not None:
            self.validateProperties("opArgs", props.opArgs, "list", diagnostics)
        if props.templatesExts is not None:
            self.validateProperties(
                "templatesExts", props.templatesExts, "list", diagnostics
            )

        return diagnostics

    def onChange(
        self,
        context: WorkflowContext,
        oldState: Component[PythonProperties],
        newState: Component[PythonProperties],
    ) -> Component[PythonProperties]:
        return newState

    class PythonCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: Python.PythonProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            import json
            from datetime import timedelta
            from airflow.operators.python import PythonOperator

            options = {}
            if self.props.opArgs is not None:
                options["op_args"] = json.loads(self.props.opArgs)
            if self.props.opKwargs is not None:
                options["op_kwargs"] = json.loads(self.props.opKwargs)
            if self.props.templatesExts is not None:
                options["templates_exts"] = json.loads(self.props.templatesExts)
            if self.props.templatesDict is not None:
                options["templates_dict"] = json.loads(self.props.templatesDict)
            if self.props.valueInLogs is not None:
                options["show_return_value_in_logs"] = self.props.valueInLogs

            return PythonOperator(
                task_id=self.props.taskId,
                python_callable=self.props.code,
                **options,
                **self.settings,
            )
