from typing import Optional, List

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.WorkflowContext import WorkflowContext
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    Diagnostic,
)
from prophecy.cb.server.base.ComponentBuilderBase import ComponentSpec
from prophecy.cb.ui.uispec import (
    List,
    dataclass,
)
from prophecy.cb.ui.uispec import Dialog, TabPane, Tabs


class ForEachLoop(ComponentSpec):
    name: str = "ForEachLoop"
    category: str = "Subgraph"

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Variables", "variables")
        # return TabPane("Variables", "variables").addElement(
        #     StackLayout(gap="20px", height="100%", direction="horizontal")
        #     .addElement(
        #         TextBox("Variable Name", "varName", placeholder="arg1")
        #     )
        #     .addElement(
        #         TextBox("Variable Value", "varValue", placeholder="list or xcom value")
        #     )
        # )

    def dialog(self) -> Dialog:
        return Dialog("ForEachLoop").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class ForEachLoopProperties(ComponentProperties):
        loopVariables: Optional[List[dict]] = None
        taskId: Optional[str] = None

    def validate(
        self, context: WorkflowContext, component: Component[ForEachLoopProperties]
    ) -> List[Diagnostic]:
        diagnostics = []
        # props = component.properties
        # if isBlank(props.varName):
        #     diagnostics.append(
        #         Diagnostic("properties.varName", "Need to define a loop variable name", SeverityLevelEnum.Error)
        #     )
        # if isBlank(props.varName):
        #     diagnostics.append(
        #         Diagnostic("properties.varValue", "Need to define a loop variable value", SeverityLevelEnum.Error)
        #     )

        return diagnostics

    def onChange(
        self,
        context: WorkflowContext,
        oldState: Component[ForEachLoopProperties],
        newState: Component[ForEachLoopProperties],
    ) -> Component[ForEachLoopProperties]:
        return newState

    class ForEachLoopCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: ForEachLoop.ForEachLoopProperties = newProps
            self.settings: dict = newSettings

        # This method won't be used as we'll be going to generate code by prophecy code
        def apply(self):
            from datetime import timedelta
            from airflow.utils.task_group import TaskGroup
            from airflow.operators.empty import EmptyOperator

            with TaskGroup(group_id=self.props.taskId) as tg:
                EmptyOperator(task_id="dummy")
