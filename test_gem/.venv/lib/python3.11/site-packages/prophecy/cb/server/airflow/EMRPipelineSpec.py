from dataclasses import dataclass, field
from typing import List, Optional

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.WorkflowContext import WorkflowContext, EmptyWorkflowContext
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.ui.uispec import (
    ColumnsLayout,
    Condition,
    Dialog,
    Gem,
    ImagePlaceholder,
    NativeText,
    PipelineConfigurationTable,
    PropExpr,
    SelectBox,
    SelectBoxOption,
    SelectBoxWithTemplate,
    StackItem,
    StackLayout,
    TabPane,
    Tabs,
    TextBoxTemplate,
    TextBox, StringExpr, IDELinkButton, ButtonSize, ButtonVariant, ProphecyIcon, Text,
)
from prophecy.cb.util.StringUtils import isBlank


class EMRPipeline(ComponentSpec):
    name: str = "EMRPipeline"
    category: str = "Data Pipelines"
    gemDescription: str = "Runs a Pipeline on EMR"
    altProcessLabel: str = "${component.properties.configurations.selectedInstance.value}"

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%")
            .addElement(
                ColumnsLayout(gap="12px", alignY=None, height=None, _children=None)
                .addColumn(
                    SelectBoxWithTemplate(
                        titleVar="* Pipeline to schedule",
                        placeholder="Please select a pipeline",
                    )
                    .withOptionCTA(
                        IDELinkButton(titleVar="", size=ButtonSize.s,
                                      variant=ButtonVariant.secondaryGrey,
                                      projectId="${component.properties.projectId}",
                                      ide="Workflow", entityType="Pipeline",
                                      entityId="${component.properties.pipelineId.value}",
                                      navigatingTo="${component.properties.pipelineId.value}")
                        .addElement(
                            StackLayout(direction="horizontal", gap="8px",
                                        alignY="center",
                                        align="center")
                            .addElement(ProphecyIcon(type="default",
                                                     iconName="ArrowNarrowUpRightIcon"))
                            .addElement(Text(_children=[NativeText("Open")])))
                    )
                    .withAllowConfig()
                    .withSearchEnabled()
                    .withStyle({"width": "100%"})
                    .withNoContentMessage("No Pipelines Found")
                    .bindProperty("pipelineId")
                    .bindOptionProperty("${$.metadata.projects}")
                    .withIdentifier("record")
                    .addTemplate(
                        TextBoxTemplate.create_pipeline_template(
                            "title", "pipelines"
                        )
                    ),
                    width="1fr",
                )
                .addColumn(
                    SelectBoxWithTemplate(
                        titleVar="* Fabric & Job size to run this pipeline",
                        placeholder="Please select a Fabric & Job Size",
                    )
                    .withSearchEnabled()
                    .withNoContentMessage("No EMR fabric found")
                    .bindProperty("clusterSize")
                    .bindOptionProperty("${$.metadata.emr_fabrics}")
                    .withIdentifier("record")
                    .withGroupName()
                    .addTemplate(
                        TextBoxTemplate.create_job_size_template(
                            "title", "job_sizes"
                        )
                    ),
                    width="1fr",
                )

                )
                .addElement(
                    ColumnsLayout(gap="1rem")
                    .addColumn(
                        SelectBox(
                            titleVar="AWS Connection Id",
                            placeholder="aws_default",
                        )
                        .withSearchEnabled()
                        .withNoContentMessage("No AWS Connection Id found")
                        .bindProperty("awsConnId")
                        .bindOptionProperty("${$.metadata.connections.aws}"),
                        width="1fr",
                    )
                    .addColumn(
                        SelectBox(
                            titleVar="Action on Failure",
                            propertyVar="actionOnFailure",
                            options=[
                                SelectBoxOption("Continue", "CONTINUE"),
                                SelectBoxOption(
                                    "Terminate Cluster", "TERMINATE_CLUSTER"
                                ),
                                SelectBoxOption("Cancel & Wait", "CANCEL_AND_WAIT"),
                            ],
                        ),
                        width="1fr",
                    )
                )
                .addElement(
                    ColumnsLayout(gap="1rem")
                    .addColumn(
                        TextBox(
                            "EMR Cluster Id Override",
                            placeholder="jp-QSDEFTHJIOPKJ",
                        ).withAllowComposite(flag=False)
                        .withRows(1)
                        .withAllowConfig()
                        .bindProperty("jobFlowId"),
                        width="1fr",
                    )
                    .addColumn(NativeText(""), width="1fr")
                )
            .addElement(
                StackItem(grow=1).addElement(
                    Condition()
                    .ifEqual(PropExpr("component.properties.pipelineId.type"), StringExpr("literal"))
                    .then(
                        StackLayout(height="100%")
                        .addElement(NativeText("Set Pipeline Configurations"))
                        .addElement(PipelineConfigurationTable())
                    )
                    .otherwise(
                        ColumnsLayout(gap="12px", alignY=None, height=None, _children=None).addColumn(
                            SelectBox(
                                titleVar="Select pipeline configuration instance",
                                placeholder="Please select a pipeline",
                            )
                            .withAllowConfig()
                            .withStyle({"width": "100%"})
                            .withSearchEnabled()
                            .withNoContentMessage("No pipeline configuration found")
                            .bindProperty("configurations.selectedInstance")
                            .addOption("default", "default")
                            .withIdentifier("record"),
                            width="1fr",
                        ).addColumn(
                            SelectBox(
                                titleVar="Select override configs",
                                placeholder="Select override configs",
                            )
                            .withSearchEnabled()
                            .withAllowConfig()
                            .withStyle({"width": "100%"})
                            .withNoContentMessage("No Override configs")
                            .bindProperty("configurations.overrides")
                            .withIdentifier("record"),
                            width="1fr",
                        )
                    )
                )
            )
        )

    def dialog(self) -> Dialog:
        return Dialog("Pipeline").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class EMRPipelineProperties(ComponentProperties):
        pipelineId: Optional[dict] = None
        clusterSize: Optional[str] = None
        jobFlowId: Optional[dict] = None
        actionOnFailure: str = "CONTINUE"
        awsConnId: Optional[str] = "aws_default"
        steps: Optional[list[dict]] = None
        taskId: Optional[str] = None

    def validate(self, context: WorkflowContext, component: Component[EMRPipelineProperties]) -> List[Diagnostic]:
        return []

    def onChange(
        self,
        context: WorkflowContext,
        oldState: Component[EMRPipelineProperties],
        newState: Component[EMRPipelineProperties],
    ) -> Component[EMRPipelineProperties]:
        return newState

    class EMRPipelineCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: EMRPipeline.EMRPipelineProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from datetime import timedelta
            from airflow.providers.amazon.aws.operators.emr import (
                EmrAddStepsOperator,
            )  # noqa

            return EmrAddStepsOperator(
                task_id=self.props.taskId,
                job_flow_id=self.props.jobFlowId,
                aws_conn_id=self.props.awsConnId,
                steps=self.props.steps
            )
