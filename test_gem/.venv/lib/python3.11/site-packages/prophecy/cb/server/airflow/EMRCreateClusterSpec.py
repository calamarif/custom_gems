from dataclasses import dataclass, field
from typing import List, Optional
import json
from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.WorkflowContext import WorkflowContext
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.ui.uispec import (
    Dialog,
    SelectBox,
    StackItem,
    StackLayout,
    TabPane,
    Tabs,
    TextArea,
)
from prophecy.cb.util.StringUtils import isBlank

class EMRCreateCluster(ComponentSpec):
    name: str = "EMRCreateCluster"
    category: str = "Data Pipelines"
    gemDescription: str = "Creates EMR Clusters (Job flows)"
    altProcessLabel: str = "${component.properties.configurations.selectedInstance}"

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%").addElement(
                StackLayout(direction="vertical", gap="20px")
                .addElement(
                    StackLayout(direction="horizontal", gap="12px")
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            SelectBox(
                                titleVar="* AWS Connection Id",
                                placeholder="aws_default",
                            )
                            .withSearchEnabled()
                            .withNoContentMessage(
                                "No AWS Connection Id found in current fabric"
                            )
                            .bindProperty("awsConnId")
                            .bindOptionProperty("${$.metadata.connections.aws}")
                        )
                    )
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            SelectBox(
                                titleVar="* EMR Connection Id",
                                placeholder="emr_default",
                            )
                            .withSearchEnabled()
                            .withNoContentMessage(
                                "No EMR Connection Id found in current fabric"
                            )
                            .bindProperty("emrConnId")
                            .bindOptionProperty("${$.metadata.connections.emr}")
                        )
                    ).addElement(
                        StackItem(basis="25rem").addElement(
                            TextBox("Region Name", placeholder="us-west-2").bindProperty(
                                "regionName"
                            )
                        )
                    )
                )
                .addElement(
                    StackItem().addElement(
                        TextArea(
                            titleVar="Job Flow Overrides",
                            rows=15,
                            placeholder="""{
    "Name": "PiCalc",
    "ReleaseLabel": "emr-6.7.0",
    "Applications": [{"Name": "Spark"}],
    "Instances": {
        "InstanceGroups": [
            {
                "Name": "Primary node",
                "Market": "ON_DEMAND",
                "InstanceRole": "MASTER",
                "InstanceType": "m5.xlarge",
                "InstanceCount": 1,
            },
        ],
        "KeepJobFlowAliveWhenNoSteps": False,
        "TerminationProtected": False,
    },
    "JobFlowRole": "EMR_EC2_DefaultRole",
    "ServiceRole": "EMR_DefaultRole",

}""",
                        ).bindProperty("jobFlowOverrides")
                    )
                )
            )
        )

    def dialog(self) -> Dialog:
        return Dialog("EMRJobFlow").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class EMRCreateClusterProperties(ComponentProperties):
        awsConnId: Optional[str] = None
        emrConnId: Optional[str] = None
        regionName: Optional[str]  = None
        jobFlowOverrides: Optional[str] = None
        taskId: Optional[str] = None

    def validate(
            self, context: WorkflowContext, component: Component[EMRCreateClusterProperties]
    ) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties
        if isBlank(props.awsConnId):
            diagnostics.append(
                Diagnostic(
                    "properties.awsConnId",
                    "Choose an aws connection",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.emrConnId):
            diagnostics.append(
                Diagnostic(
                    "properties.emrConnId",
                    "Choose an emr connection",
                    SeverityLevelEnum.Information,
                )
            )

        return diagnostics

    def onChange(
            self,
            context: WorkflowContext,
            oldState: Component[EMRCreateClusterProperties],
            newState: Component[EMRCreateClusterProperties],
    ) -> Component[EMRCreateClusterProperties]:
        return newState

    class EMRCreateClusterCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: EMRCreateCluster.EMRCreateClusterProperties = newProps
            self.settings: dict = newSettings


        def apply(self):
            from airflow.providers.amazon.aws.operators.emr import (
                EmrCreateJobFlowOperator,
            )
            from datetime import timedelta

            if isBlank(self.props.jobFlowOverrides):
                return EmrCreateJobFlowOperator(
                    task_id=self.props.taskId,
                    aws_conn_id=self.props.awsConnId,
                    emr_conn_id=self.props.emrConnId,
                    region_name=None if isBlank(self.props.regionName) else self.props.regionName,
                    **self.settings
                )
            else:
                return EmrCreateJobFlowOperator(
                    task_id=self.props.taskId,
                    aws_conn_id=self.props.awsConnId,
                    emr_conn_id=self.props.emrConnId,
                    region_name=None if isBlank(self.props.regionName) else self.props.regionName,
                    job_flow_overrides=json.loads(self.props.jobFlowOverrides),
                    **self.settings
                )
