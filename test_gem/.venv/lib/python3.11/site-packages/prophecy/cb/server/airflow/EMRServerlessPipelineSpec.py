from dataclasses import dataclass
import json
from typing import List, Optional

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.WorkflowContext import WorkflowContext
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
)
from prophecy.cb.ui.uispec import (
    ColumnsLayout,
    Condition,
    Dialog,
    NativeText,
    PipelineConfigurationTable,
    PropExpr,
    SelectBox,
    SelectBoxOption,
    SelectBoxWithTemplate,
    StackItem,
    StackLayout,
    TabPane,
    Tabs,
    TextArea,
    TextBoxTemplate,
    TextBox, StringExpr, IDELinkButton, ButtonSize, ButtonVariant, ProphecyIcon, Text,
)
from prophecy.cb.util.StringUtils import isBlank

# Airflow operators & sensors
try:
    from airflow.providers.amazon.aws.operators.emr import (
        EmrServerlessCreateApplicationOperator,
        EmrServerlessStartJobOperator,
        EmrServerlessStopApplicationOperator,
        EmrServerlessDeleteApplicationOperator,
    )
    from airflow.providers.amazon.aws.sensors.emr import (
        EmrServerlessApplicationSensor,
        EmrServerlessJobSensor,
    )
    from airflow.providers.amazon.aws.hooks.emr import EmrServerlessHook
except Exception as e:  # pragma: no cover
    raise ImportError(
        "This module requires apache-airflow-providers-amazon to be installed. "
        "Try: pip install 'apache-airflow[amazon]'"
    ) from e


class EMRServerlessPipeline(ComponentSpec):
    name: str = "EMRServerlessPipeline"
    category: str = "Data Pipelines"
    gemDescription: str = "Runs a Pipeline on EMR Serverless"
    altProcessLabel: str = "${component.properties.configurations.selectedInstance.value}"

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%")
            .addElement(
                ColumnsLayout(gap="12px", alignY=None, height=None, _children=None)
                .addColumn(
                    SelectBoxWithTemplate(
                        titleVar="* Pipeline to schedule",
                        placeholder="Please select a pipeline",
                    )
                    .withOptionCTA(
                        IDELinkButton(titleVar="", size=ButtonSize.s,
                                      variant=ButtonVariant.secondaryGrey,
                                      projectId="${component.properties.projectId}",
                                      ide="Workflow", entityType="Pipeline",
                                      entityId="${component.properties.pipelineId.value}",
                                      navigatingTo="${component.properties.pipelineId.value}")
                        .addElement(
                            StackLayout(direction="horizontal", gap="8px",
                                        alignY="center",
                                        align="center")
                            .addElement(ProphecyIcon(type="default",
                                                     iconName="ArrowNarrowUpRightIcon"))
                            .addElement(Text(_children=[NativeText("Open")])))
                    )
                    .withAllowConfig()
                    .withSearchEnabled()
                    .withStyle({"width": "100%"})
                    .withNoContentMessage("No Pipelines Found")
                    .bindProperty("pipelineId")
                    .bindOptionProperty("${$.metadata.projects}")
                    .withIdentifier("record")
                    .addTemplate(
                        TextBoxTemplate.create_pipeline_template(
                            "title", "pipelines"
                        )
                    ),
                    width="1fr",
                )
                .addColumn(
                    SelectBoxWithTemplate(
                        titleVar="* Fabric & Job size to run this pipeline",
                        placeholder="Please select a Fabric & Job Size",
                    )
                    .withSearchEnabled()
                    .withNoContentMessage("No EMR Serverless fabric found")
                    .bindProperty("clusterSize")
                    .bindOptionProperty("${$.metadata.emr_serverless_fabrics}")
                    .withIdentifier("record")
                    .withGroupName()
                    .addTemplate(
                        TextBoxTemplate.create_job_size_template(
                            "title", "job_sizes"
                        )
                    ),
                    width="1fr",
                )
                )
                .addElement(
                    ColumnsLayout(gap="1rem")
                    .addColumn(
                        SelectBox(
                            titleVar="AWS Connection Id",
                            placeholder="aws_default",
                        )
                        .withSearchEnabled()
                        .withNoContentMessage("No AWS Connection Id found")
                        .bindProperty("awsConnId")
                        .bindOptionProperty("${$.metadata.connections.aws}"),
                        width="1fr",
                    )
                    .addColumn(
                        TextBox(
                            "EMR Serverless Application Id Override",
                            placeholder="001QSDEFTHJIOPKJ",
                        ).bindProperty("applicationId"),
                        width="1fr",
                    )
                    .addColumn(
                        TextBox(
                            "Execution Role ARN",
                            placeholder="arn::",
                        ).bindProperty("executionRoleArn"),
                        width="1fr",
                    )
                )
                .addElement(
                    ColumnsLayout(gap="1rem").addColumn(
                        TextArea(
                            titleVar="Configuration Overrides",
                            rows=2,
                            placeholder="""{
    "monitoringConfiguration": { "s3MonitoringConfiguration": { "logUri": "s3://my-bucket/logs/" } }
}""",
                        ).bindProperty("configurationOverrides"),
                        width="1fr",
                    )
                )
            .addElement(
                StackItem(grow=1).addElement(
                    Condition()
                    .ifEqual(PropExpr("component.properties.pipelineId.type"), StringExpr("literal"))
                    .then(
                        StackLayout(height="100%")
                        .addElement(NativeText("Set Pipeline Configurations"))
                        .addElement(PipelineConfigurationTable())
                    )
                    .otherwise(
                        ColumnsLayout(gap="12px", alignY=None, height=None, _children=None).addColumn(
                            SelectBox(
                                titleVar="Select pipeline configuration instance",
                                placeholder="Please select a pipeline",
                            )
                            .withAllowConfig()
                            .withStyle({"width": "100%"})
                            .withSearchEnabled()
                            .withNoContentMessage("No pipeline configuration found")
                            .bindProperty("configurations.selectedInstance")
                            .addOption("default", "default")
                            .withIdentifier("record"),
                            width="1fr",
                        ).addColumn(
                            SelectBox(
                                titleVar="Select override configs",
                                placeholder="Select override configs",
                            )
                            .withSearchEnabled()
                            .withAllowConfig()
                            .withStyle({"width": "100%"})
                            .withNoContentMessage("No Override configs")
                            .bindProperty("configurations.overrides")
                            .withIdentifier("record"),
                            width="1fr",
                        )
                    )
                )
            )
        )

    def dialog(self) -> Dialog:
        return Dialog("Pipeline").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class EMRServerlessPipelineProperties(ComponentProperties):
        taskId: Optional[str] = None
        clusterSize: Optional[str] = None
        pipelineId: Optional[dict] = None
        applicationId: Optional[dict] = None
        executionRoleArn: Optional[dict] = None
        jobDriver: Optional[dict] = None
        awsConnId: Optional[str] = "aws_default"
        configurationOverrides: Optional[str] = None

    def validate(self, context: WorkflowContext, component: Component[EMRServerlessPipelineProperties]) -> List[Diagnostic]:
        return []

    def onChange(
        self,
        context: WorkflowContext,
        oldState: Component[EMRServerlessPipelineProperties],
        newState: Component[EMRServerlessPipelineProperties],
    ) -> Component[EMRServerlessPipelineProperties]:
        return newState

    class EMRPipelineCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: EMRServerlessPipeline.EMRServerlessPipelineProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from datetime import timedelta # noqa
            from airflow.providers.amazon.aws.operators.emr import (
                EmrServerlessStartJobOperator,
            )  # noqa

            add_enable_application_ui_links_attr = False

            try:
                from importlib.metadata import version as _metadata_ver
                from packaging.version import parse as _version_parse
                current_version = _version_parse(_metadata_ver("apache-airflow-providers-amazon"))
                min_expected_version = _version_parse("8.18.0")
                add_enable_application_ui_links_attr = current_version >= min_expected_version
            except Exception:
                pass

            attrs_dict = {
                "task_id": self.props.taskId,
                "application_id": self.props.applicationId,
                "execution_role_arn": self.props.executionRoleArn,
                "job_driver": self.props.jobDriver,
                "configuration_overrides": None if isBlank(self.props.configurationOverrides) else json.loads(self.props.configurationOverrides),
                "aws_conn_id": self.props.awsConnId
            }
            if add_enable_application_ui_links_attr:
                attrs_dict["enable_application_ui_links"] = True

            return EmrServerlessStartJobOperator(**attrs_dict)
