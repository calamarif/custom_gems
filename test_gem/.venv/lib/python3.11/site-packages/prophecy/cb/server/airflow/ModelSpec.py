from prophecy.cb.server.airflow.common.SettingsTab import settings_field_picker
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum, SubstituteDisabled,
)
from prophecy.cb.server.base.WorkflowContext import WorkflowContext
from prophecy.cb.ui.uispec import *


class Model(ComponentSpec):
    name: str = "Model"
    category: str = "Data Pipelines"

    def dialog(self) -> Dialog:
        git_model = ColumnsLayout(gap="1rem").addColumn(
            SelectBox("Git Target", "Select")
            .addOption("branch", "branch")
            .addOption("commit", "commit")
            .addOption("Release tag", "tag")
            .bindProperty("gitEntity"),
            width="1fr",
        ).addColumn(
            Condition().ifEqual(PropExpr("component.properties.gitEntity"), StringExpr("branch"))
            .then(SelectBox("Reference Value", "ref")
            .withSearchEnabled()
            .withNoContentMessage("No Branch found")
            .bindProperty("gitEntityValueBranch")
            .bindOptionProperty(
                "${$.metadata.project_to_dbtmetadata[${component.properties.projectId}].branches}")
            ).otherwise(
                Condition().ifEqual(PropExpr("component.properties.gitEntity"), StringExpr("tag"))
                .then(SelectBox("Reference Value", "ref")
                .withSearchEnabled()
                .withNoContentMessage("No Release tag found")
                .bindProperty("gitEntityValueTag")
                .bindOptionProperty(
                    "${$.metadata.project_to_dbtmetadata[${component.properties.projectId}].tags}")
                ).otherwise(
                    Condition().ifEqual(PropExpr("component.properties.gitEntity"),
                                        StringExpr("commit"))
                    .then(TextBox("Git reference value",
                                  placeholder="${$.metadata.project.workingBranch.name}")
                          .withWidth("100%")
                          .bindProperty("gitEntityValueCommit")
                          )
                )
            ),
            width="1fr"
        )

        sql_fabric = (
            SelectBoxWithTemplate(
                titleVar="Fabric",
                placeholder="My SQL Fabric"
            ).withSearchEnabled()
            .withNoContentMessage("Select project to see compatible fabrics.")
            .bindProperty("sqlFabricId")
            .bindOptionProperty(
                "${$.metadata.teams_with_fabric_details[${component.properties.sqlProjectType}].teams_with_fabric_details_grouped_by_fabric_type}"
            )
            .withIdentifier("record")
            .addTemplate(
                TextBoxTemplate.create_fabric_template(
                    "title", "fabrics"
                )
            )
        )

        orchestrator_airflow_connections = (
            SelectBox(
                titleVar="Airflow Connection",
                placeholder="Airflow connection"
            )
            .withSearchEnabled()
            .withNoContentMessage("No Airflow connection found")
            .bindProperty("orchestratorAirflowConnectionId")
            .bindOptionProperty("${$.metadata.orchestrator_connections[${component.properties.sqlProjectType}]}")
            .withLabelKey("label")
            .withValueKey("value")
        )

        picker_tab_for_models = (PickerTab("DBT Properties", "DBTProperties", True) \
            .addField(Checkbox("Run tests").withHint("Run tests on data in deployed models").withIsChecked(True),
                      "runTest", True) \
            .addField(Checkbox("Run seeds").withHint("Load data from csv files").withIsChecked(True), "runSeed", True) \
            .addField(Checkbox("Run all parents of this model"), "runModelWithParents", True) \
            .addField(Checkbox("Run all child model"), "runModelWithChildren", True) \
            .addField(Checkbox("Pull most recent version of dependencies (deps)"), "runDeps") \
            .addField(Checkbox("Allow partial parsing"), "partialParse") \
            .addField(Checkbox("Disallow partial parsing"), "noPartialParse") \
            .addField(Checkbox("Do not send anonymous usage stats"), "noAnonymousUsageStats") \
            .addField(Checkbox("Fail fast"), "failFast") \
            .addField(Checkbox("Fail on warnings"), "warnError") \
            .addField(Checkbox("Recalculate all incremental tables and models"), "fullRefresh") \
            .addField(Checkbox("Skip version matching"), "noVersionCheck") \
            .addField(Checkbox("Defer to state variable for resolving unselected nodes"), "defer") \
            .addField(Checkbox("Disable static parser"), "noStaticParser") \
            .addField(Checkbox("Do not defer to state variable for resolving unselected nodes"), "noDefer") \
            .addField(Checkbox("Do not force defer to state variable"), "noFavorState") \
            .addField(TextBox("Exclude models", placeholder=""), "exclude") \
            .addField(TextBox("Select the nodes to include", placeholder=""), "select") \
            .addField(Checkbox("Force defer to state variable"), "favorState") \
            .addField(TextBox("Log path", placeholder=""), "logPath") \
            .addField(TextBox("Output low level timing stats", placeholder="output.profile", ), "recordTimingInfo") \
            .addField(TextBox("Parallelism (threads)", placeholder="1"), "threads") \
            .addField(Checkbox("Pre cache all db objects"), "noCacheSelectedOnly") \
            .addField(Checkbox("Pre cache db objects of selected resource only"), "cacheSelectedOnly") \
            .addField(
            TextBox("Selector to use (in selectors.yml)", placeholder=""),
            "selector",
        ) \
            .addField(
            Checkbox("Skip writing manifest and result json"), "noWriteJson"
        ) \
            .addField(TextBox("State", placeholder=""), "state") \
            .addField(
            TextBox(
                "Supply variables to project (should be a valid YAML)",
                placeholder="'{my_variable: my_value}'",
            ),
            "vars",
        ) \
            .addField(Checkbox("Supress non-error logging"), "quiet") \
            .addField(Checkbox("Supress print() macro calls"), "noPrint") \
            .addField(TextBox("Target path", placeholder=""), "targetPath") \
            .addField(TextBox("Target to load", placeholder=""), "target") \
            .addField(
            Checkbox("Use experimental parser"), "useExperimentalParser"
        ) \
            .addField(
            TextBox("Width of terminal output", placeholder=""),
            "printerWidth",
        ) \
            .addField(
            TextBox("Indirect Selection", placeholder="eager"),
            "indirectSelection",
        ))

        picker_tab_for_rest = PickerTab("DBT Properties", "DBTProperties", True) \
            .addField(Checkbox("Run tests").withHint("Run tests on data in deployed models").withIsChecked(True),
                      "runTest", True) \
            .addField(Checkbox("Run seeds").withHint("Load data from csv files").withIsChecked(True), "runSeed",
                      True) \
            .addField(Checkbox("Pull most recent version of dependencies (deps)"), "runDeps") \
            .addField(Checkbox("Allow partial parsing"), "partialParse") \
            .addField(Checkbox("Disallow partial parsing"), "noPartialParse") \
            .addField(Checkbox("Do not send anonymous usage stats"), "noAnonymousUsageStats") \
            .addField(Checkbox("Fail fast"), "failFast") \
            .addField(Checkbox("Fail on warnings"), "warnError") \
            .addField(Checkbox("Recalculate all incremental tables and models"), "fullRefresh") \
            .addField(Checkbox("Skip version matching"), "noVersionCheck") \
            .addField(Checkbox("Defer to state variable for resolving unselected nodes"), "defer") \
            .addField(Checkbox("Disable static parser"), "noStaticParser") \
            .addField(Checkbox("Do not defer to state variable for resolving unselected nodes"), "noDefer") \
            .addField(Checkbox("Do not force defer to state variable"), "noFavorState") \
            .addField(TextBox("Exclude models", placeholder=""), "exclude") \
            .addField(TextBox("Select the nodes to include", placeholder=""), "select") \
            .addField(Checkbox("Force defer to state variable"), "favorState") \
            .addField(TextBox("Log path", placeholder=""), "logPath") \
            .addField(TextBox("Output low level timing stats", placeholder="output.profile", ), "recordTimingInfo") \
            .addField(TextBox("Parallelism (threads)", placeholder="1"), "threads") \
            .addField(Checkbox("Pre cache all db objects"), "noCacheSelectedOnly") \
            .addField(Checkbox("Pre cache db objects of selected resource only"), "cacheSelectedOnly", ) \
            .addField(
            TextBox("Selector to use (in selectors.yml)", placeholder=""),
            "selector",
        ) \
            .addField(
            Checkbox("Skip writing manifest and result json"), "noWriteJson"
        ) \
            .addField(TextBox("State", placeholder=""), "state") \
            .addField(
            TextBox(
                "Supply variables to project (should be a valid YAML)",
                placeholder="'{my_variable: my_value}'",
            ),
            "vars",
        ) \
            .addField(Checkbox("Supress non-error logging"), "quiet") \
            .addField(Checkbox("Supress print() macro calls"), "noPrint") \
            .addField(TextBox("Target path", placeholder=""), "targetPath") \
            .addField(TextBox("Target to load", placeholder=""), "target") \
            .addField(
            Checkbox("Use experimental parser"), "useExperimentalParser"
        ) \
            .addField(
            TextBox("Width of terminal output", placeholder=""),
            "printerWidth",
        ) \
            .addField(
            TextBox("Indirect Selection", placeholder="eager"),
            "indirectSelection",
        )

        return Dialog("DBT").addElement(
            StackLayout(direction="horizontal", height="100%").addElement(
                Condition().ifEqual(PropExpr("component.properties.runMode"), StringExpr("model")).then(
                    FieldPickerWithTabs("Properties").addTab(picker_tab_for_models).addTab(
                        PickerTab("Gem Settings", "GemSettings", False, propertyVar="component.settings").addFields(
                            settings_field_picker().fields))).otherwise(
                    FieldPickerWithTabs("Properties").addTab(picker_tab_for_rest).addTab(
                        PickerTab("Gem Settings", "GemSettings", False, propertyVar="component.settings").addFields(
                            settings_field_picker().fields))
                )
            ).addElement(
                StackLayout(direction="horizontal", width="100%", gap="1rem", height="100%")
                .addElement(
                    StackItem(grow=1).addElement(
                        StackLayout(direction="vertical", gap="20px", width="100%")
                        .addElement(TitleElement("Select and configure what you want to run:"))
                        .addElement(
                            RadioGroup("", orientation="vertical")
                            .addOption("Run entire Project", "project")
                            .addOption("Run a SQL Model", "model")
                            .bindProperty("runMode")
                        )
                        .addElement(
                            Condition().ifExists(PropExpr("component.properties.runMode"))
                            .then(
                                StackLayout(direction="vertical", gap="12px", width="80%")
                                .addElement(
                                    ColumnsLayout(gap="1rem")
                                    .addColumn(
                                        StackLayout(direction="vertical", gap="12px", width="100%")
                                        .addElement(
                                            SelectBoxWithTemplate(
                                                titleVar="Project",
                                                placeholder="My SQL Project"
                                            )
                                            .withSearchEnabled()
                                            .withNoContentMessage("No Project found")
                                            .bindProperty("projectId")
                                            .bindOptionProperty("${$.metadata.teams_with_dbt_projects}")
                                            .withIdentifier("record")
                                            .withFilterProp("label")
                                            .addTemplate(
                                                TextBoxTemplate.create_project_template(
                                                    "title", "projects"
                                                )
                                            )
                                        ),
                                        width="1fr",
                                    )
                                    .addElement(Condition().ifEqual(PropExpr("component.properties.runMode"),
                                                                    StringExpr("model")).then(
                                        ColumnLayout("1fr",
                                                     [
                                                         StackLayout(direction="vertical", gap="12px", width="100%")
                                                     .addElement(
                                                             SelectBox(
                                                                 titleVar="Model",
                                                                 placeholder="My SQL Model"
                                                             )
                                                             .withSearchEnabled()
                                                             .withNoContentMessage("No Model found")
                                                             .withOptionCTA(
                                                                 IDELinkButton(titleVar="", size=ButtonSize.s,
                                                                               variant=ButtonVariant.secondaryGrey,
                                                                               projectId="${component.properties.projectId}",
                                                                               ide="sql", entityType="model",
                                                                               entityId="${component.properties.entityName}",
                                                                               navigatingTo="${component.properties.entityName}")
                                                                 .addElement(
                                                                     StackLayout(direction="horizontal", gap="8px",
                                                                                 alignY="center",
                                                                                 align="center")
                                                                     .addElement(ProphecyIcon(type="default",
                                                                                              iconName="ArrowNarrowUpRightIcon"))
                                                                     .addElement(Text(_children=[NativeText("Open")])))
                                                             )
                                                             .bindProperty("entityId")
                                                             .withLabelKey("name")
                                                             .withValueKey("id")
                                                             .bindOptionProperty(
                                                                 "${$.metadata.project_to_dbtmetadata[${component.properties.projectId}].entities}")
                                                             .addFooter(
                                                                 Condition().ifExists(PropExpr("component.properties.projectId"))
                                                                 .then(
                                                                     IDELinkButton(titleVar="Add Model",
                                                                                     variant=ButtonVariant.linkGrey,
                                                                                     projectId="${component.properties.projectId}",
                                                                                     ide="sql", entityType="model",
                                                                                     action="create",
                                                                                     block=True,
                                                                                     style={"backgroundColor": "#F2F4F7"})
                                                                 .withOpenInNewTab(True)
                                                                 .addElement(
                                                                     StackLayout(direction="horizontal", gap="8px",
                                                                                 alignY="center",
                                                                                 align="center")
                                                                     .addElement(ProphecyIcon(type="default",
                                                                                              iconName="PlusIcon"))
                                                                     .addElement(
                                                                         Text(_children=[NativeText("Create Model")])))
                                                                 )
                                                            )
                                                         )
                                                     ]
                                                     )
                                    )).addColumn(
                                        StackLayout(direction="vertical", gap="12px", width="100%")
                                        .addElement(
                                            Condition().ifEqual(PropExpr("$.metadata.orchestrator_airflow_connections_enabled"), BooleanExpr(True))
                                            .then(orchestrator_airflow_connections)
                                            .otherwise(sql_fabric)
                                        ),
                                        width="1fr"
                                    )
                                )
                                .addElement(
                                    StackLayout(direction="vertical", gap="12px", width="66%")
                                    .addElement(Condition()
                                    .ifEqual(PropExpr("component.properties.projectId"),
                                             PropExpr("$.metadata.project.id"))
                                    .then(Switch("Run a custom version", "customVersion").withHint(
                                        "Enable this to run code for branches aside from the current development branch").withChecked(
                                        False))
                                    )
                                    .addElement(
                                        Condition().ifEqual(PropExpr("component.properties.projectId"),
                                                            PropExpr("$.metadata.project.id"))
                                        .then(
                                            Condition().ifEqual(PropExpr("component.properties.customVersion"),
                                                                BooleanExpr(True))
                                            .then(git_model)
                                            .otherwise(StackLayout(direction="horizontal", gap="0px"))
                                        ).otherwise(git_model)
                                    )
                                )
                            )
                        )
                    )
                )
            )
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class DBTProperties(ComponentProperties):
        sqlFabricId: Optional[str] = None
        orchestratorAirflowConnectionId: Optional[str] = None
        runDeps: Optional[bool] = None
        # runSnapshots: Optional[bool] = None
        runSeed: bool = True
        runTest: bool = True
        entityId: Optional[str] = None
        entityKind: Optional[str] = None
        entityName: Optional[str] = None
        projectId: Optional[str] = None
        profile: Optional[str] = None
        gitEntity: str = "branch"
        gitEntityValue: Optional[str] = None
        gitSshUrl: Optional[str] = None
        gitSubPath: Optional[str] = None
        runOnlyModel: bool = False  # Deprecated in favor of runMode
        runMode: Optional[str] = "project"
        loadingModels: bool = False
        loadingSnapshots: bool = False
        currentProjectModels: Optional[List[dict]] = None
        currentProjectSnapshots: Optional[List[dict]] = None
        runModelWithParents: bool = False
        runModelWithChildren: bool = False
        # runSnapshotWithParents: bool = False
        # runSnapshotWithChildren: bool = False
        model: Optional[str] = None
        snapshot: Optional[str] = None
        select: Optional[str] = None
        partialParse: Optional[bool] = None
        noPartialParse: Optional[bool] = None
        noAnonymousUsageStats: Optional[bool] = None
        failFast: Optional[bool] = None
        warnError: Optional[bool] = None
        warnErrorOptions: Optional[str] = None
        fullRefresh: Optional[bool] = None
        noVersionCheck: Optional[bool] = None
        defer: Optional[bool] = None
        noDefer: Optional[bool] = None
        profilesDir: Optional[str] = None
        noStaticParser: Optional[bool] = None
        favorState: Optional[bool] = None
        noFavorState: Optional[bool] = None
        exclude: Optional[str] = None
        logPath: Optional[str] = None
        logFormat: Optional[str] = None
        recordTimingInfo: Optional[str] = None
        threads: Optional[str] = None
        noCacheSelectedOnly: Optional[bool] = None
        cacheSelectedOnly: Optional[bool] = None
        selector: Optional[str] = None
        noWriteJson: Optional[bool] = None
        state: Optional[str] = None
        vars: Optional[str] = None
        quiet: Optional[bool] = None
        noPrint: Optional[bool] = None
        targetPath: Optional[str] = None
        target: Optional[str] = None
        useExperimentalParser: Optional[bool] = None
        printerWidth: Optional[str] = None
        storeFailures: Optional[bool] = None
        indirectSelection: Optional[str] = None
        taskId: Optional[str] = None
        isProphecyManaged: bool = False
        gitTokenSecret: Optional[str] = None
        dbtProfileSecret: Optional[str] = None
        isAdhocRunFromSameProject: Optional[bool] = None
        sqlProjectType: Optional[str] = None

    def validate(
            self, context: WorkflowContext, component: Component[DBTProperties]
    ) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties
        if props.partialParse and props.noPartialParse:
            diagnostics.append(
                Diagnostic(
                    "properties.partialParse",
                    "'Allow partial parsing' and 'Disallow partial parsing' can't be used together",
                    SeverityLevelEnum.Error,
                )
            )
        if props.defer and props.noDefer:
            diagnostics.append(
                Diagnostic(
                    "properties.defer",
                    "'Defer to state variable' and 'Do not defer to state variable' can't be used together",
                    SeverityLevelEnum.Error,
                )
            )
        if props.favorState and props.noFavorState:
            diagnostics.append(
                Diagnostic(
                    "properties.favorState",
                    "'Do not force defer to state variable' and 'Force defer to state variable' can't be used together",
                    SeverityLevelEnum.Error,
                )
            )
        if props.cacheSelectedOnly and props.noCacheSelectedOnly:
            diagnostics.append(
                Diagnostic(
                    "properties.cacheSelectedOnly",
                    "'Pre cache all db objects' and 'Pre cache db objects of selected resource only' can't be used together",
                    SeverityLevelEnum.Error,
                )
            )
        return diagnostics

    def onChange(
            self,
            context: WorkflowContext,
            oldState: Component[DBTProperties],
            newState: Component[DBTProperties],
    ) -> Component[DBTProperties]:
        return newState

    class DBTCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: Model.DBTProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from airflow.operators.python import PythonOperator
            from datetime import timedelta
            import os
            import zipfile
            import tempfile

            envs = {"DBT_DATABRICKS_INVOCATION_ENV": "prophecy"}

            dbt_cli_cmd = "dbt"
            dbt_run_cmd = " run"
            dbt_snapshot_cmd = " snapshot"
            dbt_deps_cmd = " deps"
            dbt_seed_cmd = " seed"
            dbt_test_cmd = " test"
            dbt_props_cmd = ""

            if self.props.isAdhocRunFromSameProject is None:
                is_adhoc_run_from_same_project = self.props.isAdhocRunFromSameProject
            else:
                is_adhoc_run_from_same_project = False

            if self.props.logFormat:
                envs["DBT_LOG_FORMAT"] = self.props.logFormat
            if self.props.noWriteJson:
                envs["DBT_WRITE_JSON"] = "false"
            if self.props.printerWidth:
                envs["DBT_PRINTER_WIDTH"] = self.props.printerWidth
            if self.props.warnError:
                envs["DBT_WARN_ERROR"] = "true"
            if self.props.warnErrorOptions:
                envs["DBT_WARN_ERROR_OPTIONS"] = self.props.warnErrorOptions
            if self.props.noVersionCheck:
                envs["DBT_VERSION_CHECK"] = "false"
            if self.props.partialParse:
                envs["DBT_PARTIAL_PARSE"] = "true"
            if self.props.noPartialParse:
                envs["DBT_PARTIAL_PARSE"] = "false"
            if self.props.useExperimentalParser:
                envs["DBT_USE_EXPERIMENTAL_PARSER"] = "true"
            if self.props.noStaticParser:
                envs["DBT_STATIC_PARSER"] = "false"
            if self.props.profilesDir and not self.props.isProphecyManaged:
                envs["DBT_PROFILES_DIR"] = self.props.profilesDir
            if self.props.noAnonymousUsageStats:
                envs["DBT_SEND_ANONYMOUS_USAGE_STATS"] = "false"
            if self.props.failFast:
                envs["DBT_FAIL_FAST"] = "true"
            if self.props.quiet:
                envs["DBT_QUIET"] = "true"
            if self.props.noPrint:
                envs["DBT_PRINT"] = "false"
            if self.props.cacheSelectedOnly:
                envs["DBT_CACHE_SELECTED_ONLY"] = "true"
            if self.props.noCacheSelectedOnly:
                envs["DBT_CACHE_SELECTED_ONLY"] = "false"
            if self.props.targetPath and not self.props.isProphecyManaged:
                envs["DBT_TARGET_PATH"] = self.props.targetPath
            if self.props.logPath:
                envs["DBT_LOG_PATH"] = self.props.logPath
            if self.props.state:
                envs["DBT_STATE"] = self.props.state
            if self.props.defer:
                envs["DBT_DEFER"] = "true"
            if self.props.noDefer:
                envs["DBT_DEFER"] = "false"
            if self.props.favorState:
                envs["DBT_FAVOR_STATE"] = "true"
            if self.props.noFavorState:
                envs["DBT_FAVOR_STATE"] = "false"
            if self.props.fullRefresh:
                envs["DBT_FULL_REFRESH"] = "true"
            if self.props.storeFailures:
                envs["DBT_STORE_FAILURES"] = "true"
            if self.props.indirectSelection is not None:
                envs["DBT_INDIRECT_SELECTION"] = self.props.indirectSelection

            if self.props.recordTimingInfo:
                dbt_props_cmd = " -r " + self.props.recordTimingInfo

            if self.props.profile or False:
                dbt_props_cmd = " --profile " + self.props.profile

            if self.props.target and not self.props.isProphecyManaged:
                dbt_props_cmd = dbt_props_cmd + " -t " + self.props.target

            if self.props.vars:
                vars_value = self.props.vars.strip()
                if not vars_value.startswith("'"):
                    vars_value = f"'{vars_value}'"
                dbt_props_cmd = dbt_props_cmd + " --vars " + vars_value

            if self.props.selector:
                dbt_props_cmd = dbt_props_cmd + " --selector " + self.props.selector

            runner_args = {
                "is_adhoc_run_from_same_project": is_adhoc_run_from_same_project,
                "is_prophecy_managed": self.props.isProphecyManaged,
                "run_deps": False if self.props.runDeps is None else self.props.runDeps,
                "run_seeds": self.props.runSeed,
                "run_parents": self.props.runModelWithParents,
                "run_children": self.props.runModelWithChildren,
                "run_tests": self.props.runTest,
                "run_mode": self.props.runMode,
                "entity_kind": self.props.entityKind,
                "entity_name": self.props.entityName,
                "project_id": self.props.projectId,
                "git_entity": self.props.gitEntity,
                "git_entity_value": self.props.gitEntityValue,
                "git_ssh_url": self.props.gitSshUrl,
                "git_sub_path": self.props.gitSubPath,
                "select": "" if self.props.select is None else self.props.select,
                "threads": "" if self.props.threads is None else self.props.threads,
                "exclude": "" if self.props.exclude is None else self.props.exclude,
                "run_props": dbt_props_cmd,
                "envs": envs
            }

            if self.props.gitTokenSecret is not None and self.props.isProphecyManaged:
                runner_args["git_token_secret"] = self.props.gitTokenSecret

            if self.props.dbtProfileSecret is not None and self.props.isProphecyManaged:
                runner_args["dbt_profile_secret"] = self.props.dbtProfileSecret

            return PythonOperator(
                task_id=self.props.taskId,
                python_callable=invoke_dbt_runner,
                op_kwargs=runner_args,
                **self.settings,
            )
