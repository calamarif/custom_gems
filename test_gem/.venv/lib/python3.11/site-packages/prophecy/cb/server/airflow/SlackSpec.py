from dataclasses import dataclass, field
from typing import List, Optional

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.WorkflowContext import WorkflowContext, EmptyWorkflowContext
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.ui.uispec import (
    Dialog,
    SelectBox,
    StackItem,
    StackLayout,
    TabPane,
    Tabs,
    TextArea,
    TextBox,
)
from prophecy.cb.util.StringUtils import isBlank


class Slack(ComponentSpec):
    name: str = "Slack"
    category: str = "Trigger/Notify"

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%").addElement(
                StackLayout(direction="vertical", gap="20px")
                .addElement(
                    StackLayout(direction="horizontal", gap="12px")
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            TextBox("*Slack channel", placeholder="").bindProperty(
                                "channel"
                            )
                        )
                    )
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            SelectBox(
                                titleVar="*Connection name",
                                placeholder="",
                            )
                            .withSearchEnabled()
                            .withNoContentMessage(
                                "No Slack Connection found in current fabric"
                            )
                            .bindProperty("slackConnectionId")
                            .bindOptionProperty("${$.metadata.connections.slack}")
                        )
                    )
                )
                .addElement(
                    StackItem().addElement(
                        TextArea(
                            titleVar="*Slack message",
                            rows=4,
                        ).bindProperty("text")
                    )
                )
            )
        )

    def dialog(self) -> Dialog:
        return Dialog("Slack").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class SlackProperties(ComponentProperties):
        text: Optional[str] = ""
        channel: Optional[str] = ""
        token: Optional[str] = None
        slackConnectionId: Optional[str] = None
        taskId: Optional[str] = None

    def validate(self, context: WorkflowContext, component: Component[SlackProperties]) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties
        if isBlank(props.channel):
            diagnostics.append(
                Diagnostic(
                    "properties.channel",
                    "Choose a channel to send this message to",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.text):
            diagnostics.append(
                Diagnostic(
                    "properties.text",
                    "Fill in text",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.slackConnectionId):
            diagnostics.append(
                Diagnostic(
                    "properties.slackConnectionId",
                    "Choose an airflow connection",
                    SeverityLevelEnum.Error,
                )
            )
        return diagnostics

    def onChange(
        self,
        context: WorkflowContext,
        oldState: Component[SlackProperties],
        newState: Component[SlackProperties],
    ) -> Component[SlackProperties]:
        return newState

    class SlackCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: Slack.SlackProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from airflow.providers.slack.operators.slack import SlackAPIPostOperator
            from datetime import timedelta

            return SlackAPIPostOperator(
                task_id=self.props.taskId,
                text=self.props.text,
                channel=self.props.channel,
                slack_conn_id=self.props.slackConnectionId,
                **self.settings
            )
