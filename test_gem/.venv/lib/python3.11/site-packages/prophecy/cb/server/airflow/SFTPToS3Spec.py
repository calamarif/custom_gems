from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.server.base.WorkflowContext import (
    WorkflowContext,
)
from prophecy.cb.ui.uispec import *
from prophecy.cb.util.StringUtils import isBlank


class SftpToS3Spec(ComponentSpec):
    name: str = "SFTPToS3"
    category: str = "Data Transfer"
    gemDescription: str = """This operator Transfer files from an SFTP server to Amazon S3."""

    @staticmethod
    def properties_tab():
        # return (            StackLayout(gap="1rem", height="100%")
        return (StackLayout(direction="vertical", width="30%", padding="1em")
        .addElement(
            StackItem(grow=1).addElement(
                StackLayout(direction="vertical", gap="20px", width="100%")
                .addElement(TitleElement("Source File Configuration"))
                .addElement(
                    SelectBox(
                        titleVar="*SFTP Connection",
                        placeholder="sftp_default",
                        helpText="The connection added in Prophecy for SFTP auth"
                    ).withHelpText("The connection added in Prophecy for SFTP auth")
                    .withSearchEnabled()
                    .withNoContentMessage(
                        "No Sftp Connection found in current fabric"
                    )
                    .bindProperty("sftp_conn_id")
                    .bindOptionProperty("${$.metadata.connections.sftp}")
                )
                .addElement(
                    TextBox("*SFTP Path",
                            placeholder="/sftp_user/customers_data/customer.csv")
                    .withHelpText("This is the file path for downloading the file from the SFTP server")
                    .bindProperty(
                        "sftp_path"
                    )
                )
                .addElement(TitleElement("Target S3 Configuration"))
                .addElement(
                    SelectBox(
                        titleVar="*AWS Connection",
                        placeholder="aws_default",
                    ).withHelpText("The connection added in Prophecy fro AWS auth")
                    .withSearchEnabled()
                    .withNoContentMessage(
                        "No more AWS Connections found in current fabric"
                    )
                    .bindProperty("aws_conn_id")
                    .bindOptionProperty("${$.metadata.connections.aws}")
                )
                .addElement(
                    TextBox("*Bucket name", placeholder="my-aws-bucket")
                    .withHelpText("This is the S3 bucket where the file is uploaded")
                    .bindProperty(
                        "s3_bucket"
                    )
                )
                .addElement(
                    TextBox("*S3 File name", placeholder="path/in/bucket/file.txt")
                    .withHelpText("Designated S3 upload path")
                    .bindProperty(
                        "s3_key"
                    )
                )
            )))


    def dialog(self) -> Dialog:
        return Dialog("SFTP To S3 Operator").addElement(
            StackLayout(direction="horizontal").addElement(
                FieldPickerWithTabs("Properties")
                .addTab(
                    PickerTab("Gem Settings", "GemSettings", False, propertyVar="component.settings")
                    .addFields(SettingsTab.settings_field_picker().fields)
                )
            )
            .addElement(SftpToS3Spec.properties_tab())
        )


    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class SFTPToS3Properties(ComponentProperties):
        taskId: Optional[str] = None
        sftp_conn_id: Optional[str] = None
        sftp_path: Optional[str] = None
        aws_conn_id: Optional[str] = None
        s3_bucket: Optional[str] = None
        s3_key: Optional[str] = None

    def validate(
            self, context: WorkflowContext, component: Component[SFTPToS3Properties]
    ) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties
        if isBlank(props.sftp_conn_id):
            diagnostics.append(
                Diagnostic(
                    "properties.sftp_conn_id",
                    "Choose an airflow connection",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.aws_conn_id):
            diagnostics.append(
                Diagnostic(
                    "properties.aws_conn_id",
                    "Choose an AWS connection",
                    SeverityLevelEnum.Error,
                )
            )

        if isBlank(props.s3_key):
            diagnostics.append(
                Diagnostic(
                    "properties.s3_key",
                    "Please provide S3 Key",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.s3_bucket):
            diagnostics.append(
                Diagnostic(
                    "properties.s3_bucket",
                    "Please provide S3 Bucket",
                    SeverityLevelEnum.Error,
                )
            )

        if isBlank(props.sftp_path):
            diagnostics.append(
                Diagnostic(
                    "properties.sftp_path",
                    "Please provide SFTP source path",
                    SeverityLevelEnum.Error,
                )
            )
        return diagnostics

    def onChange(
            self,
            context: WorkflowContext,
            oldState: Component[SFTPToS3Properties],
            newState: Component[SFTPToS3Properties],
    ) -> Component[SFTPToS3Properties]:
        return newState

    class SftpToS3Code(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: SftpToS3Spec.SFTPToS3Properties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from airflow.providers.amazon.aws.transfers.sftp_to_s3 import SFTPToS3Operator

            return SFTPToS3Operator(
                task_id=self.props.taskId,
                sftp_conn_id=self.props.sftp_conn_id,
                sftp_path=self.props.sftp_path,
                s3_key=self.props.s3_key,
                s3_bucket=self.props.s3_bucket,
                s3_conn_id=self.props.aws_conn_id,
                use_temp_file=True,
                **self.settings,
            )
