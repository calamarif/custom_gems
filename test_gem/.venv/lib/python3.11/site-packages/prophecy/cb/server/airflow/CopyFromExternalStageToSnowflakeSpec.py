from dataclasses import dataclass
from typing import List, Optional

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.server.base.WorkflowContext import (
    WorkflowContext,
)
from prophecy.cb.ui.uispec import (
    Dialog,
    StackItem,
    StackLayout,
    TabPane,
    TextBox, SelectBox, ColumnsLayout,
)
from prophecy.cb.util.StringUtils import isBlank

###NOTE- lets not put this in SAAS for now.
class CopyFromExternalStageToSnowflakeSpec(ComponentSpec):
    name: str = "CopyFromExternalStageToSnowflake"
    category: str = "Data Transfer"
    gemDescription: str = """This operator Copies file from Stage to Snowflake table"""

    @staticmethod
    def properties_tab():
        return (StackLayout(direction="vertical", width="30%", padding="1em")
        .addElement(
            StackItem(grow=1).addElement(
                StackLayout(direction="vertical", gap="20px", width="100%")
                .addElement(TitleElement("Snowflake Configuration"))
                .addElement(
                    SelectBox(
                        titleVar="*Snowflake Connection name",
                        placeholder="snowflake_default",
                    )
                    .withSearchEnabled()
                    .withNoContentMessage(
                        "No more Snowflake Connections found in current fabric"
                    )
                    .bindProperty("snowflake_conn_id")
                    .bindOptionProperty("${$.metadata.connections.snowflakedirect}")
                )
                .addElement(
                    TextBox("*Snowflake Stage", placeholder="MY_STAGE").bindProperty(
                        "snowflake_stage"
                    )
                )
                .addElement(
                    TextBox("*Snowflake Table", placeholder="MY_TABLE").bindProperty(
                        "snowflake_table"
                    )
                )
                .addElement(
                    SelectBox("Copy Option (ON ERROR)")
                    .addOption("CONTINUE", "CONTINUE")
                    .addOption("SKIP_FILE", "SKIP_FILE")
                    .bindProperty("copy_options_on_error")
                )
                .addElement(
                    TextBox("*File path/key in Snowflake Stage",
                            placeholder="path/in/bucket/file.txt").bindProperty(
                        "file_key"
                    )
                )
                # TODO: make the format as drop down and add options
                .addElement(
                    TextBox("*File Formats", placeholder="(type = 'CSV',field_delimiter = ';')").bindProperty(
                        "file_format"
                    )
                )
            )))

    def dialog(self) -> Dialog:
        return Dialog("Stage to Snowflake Operator").addElement(
            StackLayout(direction="horizontal").addElement(
                FieldPickerWithTabs("Properties")
                .addTab(
                    PickerTab("Gem Settings", "GemSettings", False, propertyVar="component.settings")
                    .addFields(SettingsTab.settings_field_picker().fields)
                )
            )
            .addElement(CopyFromExternalStageToSnowflakeOperatorSpec.properties_tab())
        )


    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class S3ToSnowflakeProperties(ComponentProperties):
        taskId: Optional[str] = None
        file_key: Optional[str] = None
        file_format: Optional[str] = None
        snowflake_conn_id: Optional[str] = None
        snowflake_table: Optional[str] = None
        snowflake_stage: Optional[str] = None
        copy_options_on_error: Optional[str] = "CONTINUE"

    def validate(
            self, context: WorkflowContext, component: Component[S3ToSnowflakeProperties]
    ) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties
        if isBlank(props.file_key):
            diagnostics.append(
                Diagnostic(
                    "properties.file_key",
                    "Please provide File path",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.file_format):
            diagnostics.append(
                Diagnostic(
                    "properties.file_format",
                    "Please provide File Format",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.snowflake_conn_id):
            diagnostics.append(
                Diagnostic(
                    "properties.snowflake_conn_id",
                    "Please provide Snowflake Connection Name",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.snowflake_stage):
            diagnostics.append(
                Diagnostic(
                    "properties.snowflake_stage",
                    "Please provide Snowflake Stage Name",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.snowflake_table):
            diagnostics.append(
                Diagnostic(
                    "properties.snowflake_table",
                    "Please provide Snowflake Table Name",
                    SeverityLevelEnum.Error,
                )
            )
        return diagnostics

    def onChange(
            self,
            context: WorkflowContext,
            oldState: Component[S3ToSnowflakeProperties],
            newState: Component[S3ToSnowflakeProperties],
    ) -> Component[S3ToSnowflakeProperties]:
        return newState

    class CopyFromExternalStageToSnowflakeCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: CopyFromExternalStageToSnowflakeOperatorSpec.S3ToSnowflakeProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            # S3ToSnowflakeOperator is deprecated in provider 5.0.0
            from airflow.providers.snowflake.transfers.copy_into_snowflake import \
                CopyFromExternalStageToSnowflakeOperator
            return CopyFromExternalStageToSnowflakeOperator(
                task_id=self.props.taskId,
                files=[self.props.file_key],  # TODO: make the key a list as well
                file_format=self.props.file_format,

                snowflake_conn_id=self.props.snowflake_conn_id,
                table=self.props.snowflake_table,
                stage=self.props.snowflake_stage,
                copy_options=f"ON_ERROR = '{self.props.copy_options_on_error}'"
            )
