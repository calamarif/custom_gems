import json

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.server.base.WorkflowContext import WorkflowContext
from prophecy.cb.ui.uispec import *
from prophecy.cb.util.StringUtils import isBlank


class TriggerDag(ComponentSpec):
    name: str = "TriggerDag"
    category: str = "Trigger/Notify"

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%").addElement(
                StackLayout(direction="horizontal", gap="20px", width="100%")
                .addElement(
                    StackItem().addElement(
                        FieldPicker()
                        .addField(Checkbox("Reset Dag Run"), "resetDagRun", True)
                        .addField(
                            Checkbox("Wait For Completion"), "waitForCompletion", True
                        )
                        .addField(
                            NumberBox(
                                "Poke interval (sec)",
                                minValueVar=0,
                                maxValueVar=604800,  # 7 days in seconds
                                placeholder="60",
                            ),
                            "pokeInterval",
                        )
                        .addField(
                            TextBox("Run Id", placeholder="my_custom_run_id"), "runId"
                        )
                        .addField(
                            TextBox(
                                "Execution Date", placeholder="2023-01-01 00:00:00"
                            ),
                            "executionDate",
                        )
                    )
                )
                .addElement(
                    StackItem(basis="50rem").addElement(
                        StackLayout(direction="vertical", gap="12px", width="100%")
                        .addElement(
                            StackLayout(direction="horizontal", gap="12px")
                            .addElement(Text(_children=[NativeText("Selection Type:")]))
                            .addElement(
                                RadioGroup("", orientation="horizontal")
                                .addOption("Select a Job", "job")
                                .addOption("Mention a DAG Id", "dag")
                                .bindProperty("selectionType"),
                            )
                        )
                        .addElement(
                            Condition()
                            .ifEqual(
                                PropExpr("component.properties.selectionType"),
                                StringExpr("job"),
                            )
                            .then(
                                SelectBox(
                                    titleVar="* Job",
                                    placeholder="Please select a Job",
                                )
                                .withSearchEnabled()
                                .withNoContentMessage("No Jobs found")
                                .bindProperty("jobId")
                                .bindOptionProperty("${$.metadata.airflow_jobs}")
                            )
                        )
                        .addElement(
                            Condition()
                            .ifEqual(
                                PropExpr("component.properties.selectionType"),
                                StringExpr("dag"),
                            )
                            .then(
                                TextBox("* Dag Id", placeholder="").bindProperty(
                                    "dagId"
                                ).withAllowConfig().withAllowComposite(flag=False)
                            )
                        )
                        .addElement(
                            TextBox(
                                "Configuration", placeholder='{"key":"value"}'
                            ).bindProperty("conf").withAllowConfig().withAllowComposite(flag=False).withRows(4)
                        )
                    )
                )
            )
        )

    def dialog(self) -> Dialog:
        return Dialog("Trigger Dag").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class TriggerDagProperties(ComponentProperties):
        selectionType: str = "job"
        jobId: Optional[str] = None
        dagId: Optional[dict] = None
        runId: Optional[str] = None
        executionDate: Optional[str] = None
        conf: Optional[dict] = None
        resetDagRun: bool = False
        waitForCompletion: bool = False
        pokeInterval: Optional[int] = None
        taskId: Optional[str] = None

    def validate(self, context: WorkflowContext, component: Component[TriggerDagProperties]) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties
        if props.selectionType == "dag" and not props.dagId:
            diagnostics.append(
                Diagnostic(
                    "properties.dagId",
                    "Please mention a Dag Id",
                    SeverityLevelEnum.Error,
                )
            )
        return diagnostics

    def onChange(
            self,
            context: WorkflowContext,
            oldState: Component[TriggerDagProperties],
            newState: Component[TriggerDagProperties],
    ) -> Component[TriggerDagProperties]:
        return newState

    class TriggerDagCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: TriggerDag.TriggerDagProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from airflow.operators.trigger_dagrun import TriggerDagRunOperator
            from datetime import timedelta

            options = {}
            conf = self.props.conf

            if self.props.runId is not None:
                options["trigger_run_id"] = self.props.runId
            if self.props.executionDate is not None:
                options["execution_date"] = self.props.executionDate
            if self.props.resetDagRun is not None:
                options["reset_dag_run"] = self.props.resetDagRun
            if self.props.waitForCompletion is not None:
                options["wait_for_completion"] = self.props.waitForCompletion
            if self.props.pokeInterval is not None:
                options["poke_interval"] = self.props.pokeInterval

            return TriggerDagRunOperator(
                task_id=self.props.taskId,
                trigger_dag_id=self.props.dagId,
                conf=conf,
                **options
            )
