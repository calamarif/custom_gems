from dataclasses import dataclass, field
from typing import List, Optional

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.WorkflowContext import WorkflowContext, EmptyWorkflowContext
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.ui.uispec import (
    Dialog,
    SelectBox,
    StackItem,
    StackLayout,
    TabPane,
    Tabs,
    TextArea, TextBox,
)
from prophecy.cb.util.StringUtils import isBlank


class Email(ComponentSpec):
    name: str = "Email"
    category: str = "Trigger/Notify"

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%").addElement(
                StackLayout(direction="vertical", gap="20px")
                .addElement(
                    StackLayout(direction="horizontal", gap="12px")
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            TextBox(
                                "*To", placeholder="john.doe@example.com"
                            ).bindProperty("emailTo")
                        )
                    )
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            StackItem(basis="25rem").addElement(
                                SelectBox(
                                    titleVar="*Connection name",
                                    placeholder="email_default",
                                )
                                .withSearchEnabled()
                                .withNoContentMessage(
                                    "No Email Connection found in current fabric"
                                )
                                .bindProperty("emailConnectionId")
                                .bindOptionProperty("${$.metadata.connections.email}")
                            )
                        )
                    )
                )
                .addElement(
                    StackLayout(direction="horizontal", gap="12px")
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            TextBox("cc", placeholder="").bindProperty("emailCC")
                        )
                    )
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            TextBox("bcc", placeholder="").bindProperty("emailBCC")
                        )
                    )
                )
                .addElement(
                    StackItem().addElement(
                        TextBox("*Subject", placeholder="").bindProperty("subject")
                    )
                )
                .addElement(
                    StackItem(basis="25rem").addElement(
                        TextArea(
                            titleVar="*Email content",
                            rows=4,
                        )
                        .bindProperty("htmlContent")
                    )
                )
            )
        )

    def dialog(self) -> Dialog:
        return Dialog("Email").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class EmailProperties(ComponentProperties):
        emailTo: Optional[str] = ""
        subject: Optional[str] = ""
        htmlContent: Optional[str] = ""
        emailCC: Optional[str] = None
        emailBCC: Optional[str] = None
        emailConnectionId: Optional[str] = None
        taskId: Optional[str] = None

    def validate(self, context: WorkflowContext, component: Component[EmailProperties]) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties
        if isBlank(props.emailTo):
            diagnostics.append(
                Diagnostic(
                    "properties.emailTo",
                    "Choose whom to send this email",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.subject):
            diagnostics.append(
                Diagnostic(
                    "properties.subject",
                    "Enter a subject for this email",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.htmlContent):
            diagnostics.append(
                Diagnostic(
                    "properties.htmlContent",
                    "Add content to this email",
                    SeverityLevelEnum.Error,
                )
            )
        if isBlank(props.emailConnectionId):
            diagnostics.append(
                Diagnostic(
                    "properties.emailConnectionId",
                    "Choose an airflow connection to send this email",
                    SeverityLevelEnum.Error,
                )
            )
        return diagnostics

    def onChange(
            self,
            context: WorkflowContext,
            oldState: Component[EmailProperties],
            newState: Component[EmailProperties],
    ) -> Component[EmailProperties]:
        return newState

    class EmailCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: Email.EmailProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from airflow.operators.email import EmailOperator
            from datetime import timedelta

            return EmailOperator(
                task_id=self.props.taskId,
                to=self.props.emailTo,
                subject=self.props.subject,
                html_content=self.props.htmlContent,
                cc=self.props.emailCC,
                bcc=self.props.emailBCC,
                mime_subtype="mixed",
                mime_charset="utf-8",
                conn_id=self.props.emailConnectionId,
                **self.settings
            )
