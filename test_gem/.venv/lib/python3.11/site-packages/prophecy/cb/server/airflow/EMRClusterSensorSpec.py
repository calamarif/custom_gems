from dataclasses import dataclass, field
from typing import List, Optional

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.WorkflowContext import WorkflowContext
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.ui.uispec import (
    Dialog,
    NumberBox,
    SelectBox,
    StackItem,
    StackLayout,
    TabPane,
    Tabs,
    TextBox,
)
from prophecy.cb.util.StringUtils import isBlank


class EMRClusterSensor(ComponentSpec):
    name: str = "EMRClusterSensor"
    category: str = "Sensor"
    gemDescription: str = """This sensor continues to wait for a specific EMR cluster state during the Job run. 
Finishes if the state is reached within the time limit, otherwise raises a timeout exception"""

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%").addElement(
                StackLayout(direction="vertical", gap="20px")
                .addElement(
                    StackLayout(direction="horizontal", gap="12px")
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            TextBox(
                                "EMR Cluster Id",
                                "jobFlowId",
                                True,
                                placeholder="{{ ti.xcom_pull('EMRCreateCluster_0') }}",
                            )
                        )
                    )
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            SelectBox(
                                titleVar="AWS Connection Id",
                                placeholder="aws_default",
                            )
                            .withSearchEnabled()
                            .withNoContentMessage("No AWS Connection Id found")
                            .bindProperty("awsConnId")
                            .bindOptionProperty("${$.metadata.connections.aws}")
                        )
                    )
                )
                .addElement(
                    StackLayout(direction="horizontal", gap="12px")
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            SelectBox("Target States", mode="multiple")
                            .addOption("Starting", "STARTING")
                            .addOption("Bootstrapping", "BOOTSTRAPPING")
                            .addOption("Running", "RUNNING")
                            .addOption("Waiting", "WAITING")
                            .addOption("Terminating", "TERMINATING")
                            .addOption("Terminated", "TERMINATED")
                            .addOption(
                                "Terminated With Errors", "TERMINATED_WITH_ERRORS"
                            )
                            .bindProperty("targetStates")
                        )
                    )
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            StackItem(basis="25rem").addElement(
                                SelectBox("Failed States", mode="multiple")
                                .addOption("Starting", "STARTING")
                                .addOption("Bootstrapping", "BOOTSTRAPPING")
                                .addOption("Running", "RUNNING")
                                .addOption("Waiting", "WAITING")
                                .addOption("Terminating", "TERMINATING")
                                .addOption("Terminated", "TERMINATED")
                                .addOption(
                                    "Terminated With Errors", "TERMINATED_WITH_ERRORS"
                                )
                                .bindProperty("failedStates")
                            )
                        )
                    )
                )
                .addElement(
                    StackLayout(direction="horizontal", gap="12px")
                    # .addElement(
                    #     StackItem(basis="25rem").addElement(
                    #         NumberBox(
                    #             "Maximum number of tries",
                    #             minValueVar=1,
                    #             maxValueVar=3600,  # Per second polling for an hour
                    #             placeholder="60",
                    #         ).bindProperty("maxAttempts")
                    #     )
                    # )
                    .addElement(
                        StackItem(basis="25rem").addElement(
                            NumberBox(
                                "Sensor timeout in seconds",
                                minValueVar=0,
                                maxValueVar=604800,  # 7 days in seconds
                                placeholder="600",
                            ).bindProperty("timeout")
                        )
                    )
                )
            )
        )

    def dialog(self) -> Dialog:
        return Dialog("EMR Create Cluster Sensor").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class EMRClusterSensorProperties(ComponentProperties):
        jobFlowId: Optional[str] = None
        awsConnId: Optional[str] = "aws_default"
        targetStates: Optional[list[str]] = field(default_factory=list)
        failedStates: Optional[list[str]] = field(default_factory=list)
        taskId: Optional[str] = None
        maxAttempts: Optional[int] = 60
        timeout: Optional[int] = 600

    def validate(
        self, context: WorkflowContext, component: Component[EMRClusterSensorProperties]
    ) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties
        if isBlank(props.jobFlowId):
            diagnostics.append(
                Diagnostic(
                    "properties.fabricId",
                    "Please mention a Job Flow selector",
                    SeverityLevelEnum.Error,
                )
            )
        return diagnostics

    def onChange(
        self,
        context: WorkflowContext,
        oldState: Component[EMRClusterSensorProperties],
        newState: Component[EMRClusterSensorProperties],
    ) -> Component[EMRClusterSensorProperties]:
        return newState

    class EEMRCreateClusterSensorCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: EMRClusterSensor.EMRClusterSensorProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from airflow.providers.amazon.aws.sensors.emr import (
                EmrJobFlowSensor,
            )  # noqa
            from datetime import timedelta

            return EmrJobFlowSensor(
                task_id=self.props.taskId,
                job_flow_id=self.props.jobFlowId,
                aws_conn_id=self.props.awsConnId,
                target_states=self.props.targetStates,
                failed_states=self.props.failedStates,
                # max_attempts=self.props.maxAttempts, Only supported in Airflow 2.7.0+
                timeout=self.props.timeout,
                **self.settings,
            )
