from dataclasses import dataclass, field
from typing import List, Optional

from prophecy.cb.server.airflow.common import SettingsTab
from prophecy.cb.server.base.ComponentBuilderBase import (
    Component,
    ComponentCode,
    ComponentProperties,
    ComponentSpec,
    Diagnostic,
    SeverityLevelEnum,
)
from prophecy.cb.server.base.WorkflowContext import (
    WorkflowContext,
)
from prophecy.cb.ui.uispec import (
    ColumnsLayout,
    Condition,
    Dialog,
    Gem,
    ImagePlaceholder,
    NativeText,
    PipelineConfigurationTable,
    PropExpr,
    SelectBox,
    SelectBoxOption,
    SelectBoxWithTemplate,
    StackItem,
    StackLayout,
    TabPane,
    Tabs,
    TextBox,
    TextBoxTemplate, StringExpr, IDELinkButton, ButtonVariant, ProphecyIcon, Text, ButtonSize,
)
from prophecy.cb.util.StringUtils import isBlank


class OnPremPipeline(ComponentSpec):
    name: str = "OnPremPipeline"
    # displayName: str = "On Premise Pipeline - Spark Submit"
    category: str = "Data Pipelines"
    gemDescription: str = "Runs a Pipeline via Spark Submit on Hadoop cluster"
    altProcessLabel: str = "${component.properties.configurations.selectedInstance}"

    @staticmethod
    def properties_tab() -> TabPane:
        return TabPane("Property", "property").addElement(
            StackLayout(gap="1rem", height="100%")
            .addElement(
                ColumnsLayout(gap="12px", alignY=None, height=None, _children=None).addColumn(
                    SelectBoxWithTemplate(
                        titleVar="* Pipeline to schedule",
                        placeholder="Please select a pipeline",
                    )
                    .withOptionCTA(
                        IDELinkButton(titleVar="", size=ButtonSize.s,
                                      variant=ButtonVariant.secondaryGrey,
                                      projectId="${component.properties.projectId}",
                                      ide="Workflow", entityType="Pipeline",
                                      entityId="${component.properties.pipelineId.value}",
                                      navigatingTo="${component.properties.pipelineId.value}")
                        .addElement(
                            StackLayout(direction="horizontal", gap="8px",
                                        alignY="center",
                                        align="center")
                            .addElement(ProphecyIcon(type="default",
                                                     iconName="ArrowNarrowUpRightIcon"))
                            .addElement(Text(_children=[NativeText("Open")])))
                    )
                    .withAllowConfig()
                    .withSearchEnabled()
                    .withStyle({"width": "100%"})
                    .withNoContentMessage("No Pipelines Found")
                    .bindProperty("pipelineId")
                    .bindOptionProperty("${$.metadata.projects}")
                    .withIdentifier("record")
                    .addTemplate(
                        TextBoxTemplate.create_pipeline_template(
                            "title", "pipelines"
                        )
                    ),
                    width="1fr",
                ).addColumn(
                        SelectBoxWithTemplate(
                            titleVar="* Fabric & Job size to run this pipeline",
                            placeholder="Please select a Fabric & Job Size",
                        )
                        .withSearchEnabled()
                        .withNoContentMessage("No Open Source fabric found")
                        .bindProperty("clusterSize")
                        .bindOptionProperty(
                            "${$.metadata.livy_fabrics}"
                        )  # Move to all_fabrics
                        .withIdentifier("record")
                        .withGroupName()
                        .addTemplate(
                            TextBoxTemplate.create_job_size_template(
                                "title", "job_sizes"
                            )
                        ),
                        width="1fr",
                    )
                .addColumn()  # just to add spaces between the two columns
                )
                .addElement(
                    ColumnsLayout(gap="1rem")
                    .addColumn(
                        TextBox(
                            "Keytab File",
                            "keytab",
                            True,
                            placeholder="",
                        ),
                        width="1fr",
                    )
                    .addColumn(
                        TextBox(
                            "Kerberos Principal",
                            "principal",
                            True,
                            placeholder="",
                        ),
                        width="1fr",
                    )
                )
                .addElement(
                    ColumnsLayout(gap="1rem")
                    .addColumn(
                        SelectBox(
                            titleVar="Deploy Mode",
                            propertyVar="deployMode",
                            options=[
                                SelectBoxOption("Cluster", "cluster"),
                                SelectBoxOption("Client", "client"),
                            ],
                        ),
                        width="1fr",
                    )
                    .addColumn(
                        TextBox(
                            "Configuration File",
                            "configFile",
                            True,
                            placeholder=""
                        ),
                        width="1fr",
                    )
                )
                .addElement(
                    ColumnsLayout(gap="1rem").addColumn(
                        TextBox(
                            "Job name",
                            "jobName",
                            True,
                            placeholder="Prophecy Interactive Run",
                        ),
                        width="1fr",
                    )
                )

            .addElement(
                StackItem(grow=1).addElement(
                    Condition()
                    .ifEqual(PropExpr("component.properties.pipelineId.type"), StringExpr("literal"))
                    .then(
                        StackLayout(height="100%")
                        .addElement(NativeText("Set Pipeline Configurations"))
                        .addElement(PipelineConfigurationTable())
                    )
                    .otherwise(
                        ColumnsLayout(gap="12px", alignY=None, height=None, _children=None).addColumn(
                            SelectBox(
                                titleVar="Select pipeline configuration instance",
                                placeholder="Please select a pipeline",
                            )
                            .withAllowConfig()
                            .withStyle({"width": "100%"})
                            .withSearchEnabled()
                            .withNoContentMessage("No pipeline configuration found")
                            .bindProperty("configurations.selectedInstance")
                            .addOption("default", "default")
                            .withIdentifier("record")
                        ).addColumn(
                            SelectBox(
                                titleVar="Select override configs",
                                placeholder="Select override configs",
                            )
                            .withSearchEnabled()
                            .withAllowConfig()
                            .withStyle({"width": "100%"})
                            .withNoContentMessage("No Override configs")
                            .bindProperty("configurations.overrides")
                            .withIdentifier("record")
                        ).addColumn()
                    )
                )
            )
        )

    def dialog(self) -> Dialog:
        return Dialog("Pipeline").addElement(
            Tabs().addTabPane(self.properties_tab()).addTabPane(SettingsTab.tab_spec())
        )

    def optimizeCode(self) -> bool:
        return True

    @dataclass(frozen=True)
    class OnPremPipelineProperties(ComponentProperties):
        pipelineId: Optional[dict] = None
        clusterSize: Optional[str] = None
        actionOnFailure: str = "CONTINUE"
        taskId: Optional[str] = None
        application: Optional[str] = None
        application_args: Optional[list[str]] = field(default_factory=list)
        proxyUser: Optional[str] = None
        conf: Optional[dict] = None
        files: Optional[str] = None  # Configuration files
        archives: Optional[str] = None  # Project configuration files
        pyFiles: Optional[
            dict
        ] = None  # Prophecy libs and pipeline wheel plus python pipeline dependencies
        jars: Optional[dict] = None  # Prophecy libs plus java pipeline dependencies
        packages: Optional[
            str
        ] = None  # Maven coordinates of java pipeline dependencies
        javaClass: Optional[str] = None
        driverMemory: Optional[str] = None
        executorMemory: Optional[str] = None
        executorCores: Optional[int] = None
        numExecutors: Optional[int] = None
        jobName: Optional[str] = None
        keytab: Optional[str] = None
        principal: Optional[str] = None
        deployMode: Optional[str] = "cluster"

    def validate(
        self, context: WorkflowContext, component: Component[OnPremPipelineProperties]
    ) -> List[Diagnostic]:
        diagnostics = []
        props = component.properties

        if isBlank(props.keytab) and not isBlank(props.principal):
            diagnostics.append(
                Diagnostic(
                    "properties.keytab",
                    "Provide full path to the file that contains the keytab",
                    SeverityLevelEnum.Error,
                )
            )

        if isBlank(props.principal) and not isBlank(props.keytab):
            diagnostics.append(
                Diagnostic(
                    "properties.principal",
                    "Provide the name of the kerberos principal used for keytab",
                    SeverityLevelEnum.Error,
                )
            )

        return diagnostics

    def onChange(
        self,
        context: WorkflowContext,
        oldState: Component[OnPremPipelineProperties],
        newState: Component[OnPremPipelineProperties],
    ) -> Component[OnPremPipelineProperties]:
        return newState

    class OnPremPipelineCode(ComponentCode):
        def __init__(self, newProps, newSettings):
            self.props: OnPremPipeline.OnPremPipelineProperties = newProps
            self.settings: dict = newSettings

        def apply(self):
            from airflow.providers.apache.spark.operators.spark_submit import (
                SparkSubmitOperator,
            )  # noqa
            from datetime import timedelta

            keytab = None if (isBlank(self.props.keytab)) else self.props.keytab
            principal = (
                None if (isBlank(self.props.principal)) else self.props.principal
            )

            return SparkSubmitOperator(
                task_id=self.props.taskId,
                application=self.props.application,
                application_args=self.props.application_args,
                conf=self.props.conf,
                files=self.props.files,
                archives=self.props.archives,
                py_files=self.props.pyFiles,
                jars=self.props.jars,
                java_class=self.props.javaClass,
                packages=self.props.packages,
                executor_cores=self.props.executorCores,
                executor_memory=self.props.executorMemory,
                num_executors=self.props.numExecutors,
                driver_memory=self.props.driverMemory,
                name=self.props.jobName,
                proxy_user=self.props.proxyUser,
                keytab=keytab,
                principal=principal
            )
