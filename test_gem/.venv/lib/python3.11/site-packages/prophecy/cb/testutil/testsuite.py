import json
import unittest

from prophecy.cb.server.base.ComponentBuilderBase import *
from prophecy.cb.server.base.DatasetBuilderBase import DatasetProperties
from prophecy.cb.ui.uispec import *
import os, pathlib, inspect, datetime
from typing import Type, Union
from functools import cached_property, reduce


class GemTestCase(unittest.TestCase):
    """Base Test Class for writing unit tests for Gems."""
    sparkPackages = [
        "com.crealytics:spark-excel_2.12:3.2.2_0.18.0"
    ]

    repo_root = pathlib.Path(__file__).parent.parent.parent.absolute()

    resources_path = repo_root / "test" / "resources"

    test_class = None

    def setUp(self):
        from pyspark.sql import SparkSession
        from pyspark.sql.types import DateType, IntegerType, StringType, DoubleType, LongType, StructType, StructField
        self.spark = SparkSession.builder.master("local[*]").appName("init") \
            .config("spark.jars.packages", ",".join(self.sparkPackages)) \
            .config("spark.sql.legacy.allowUntypedScalaUDF", "true") \
            .getOrCreate()

        sample_data = [
            [2022, 6,  3, datetime.date(2022, 6,  3),  0, 'd', 'good widget',  654.9, 8810],
            [2022, 1, 25, datetime.date(2022, 1, 25),  1, 'b', 'okay widget', 278.52,   78],
            [2022, 2, 12, datetime.date(2022, 2, 12),  2, 'd', 'good widget', 657.68, 2994],
            [2022, 2,  6, datetime.date(2022, 2,  6),  3, 'd', 'good widget',   53.8, 3436],
            [2022, 3, 31, datetime.date(2022, 3, 31),  4, 'a', 'okay widget', 435.31, 9709],
            [2022, 2, 13, datetime.date(2022, 2, 13),  5, 'b', 'good widget', 974.51, 5389],
            [2022, 4, 15, datetime.date(2022, 4, 15),  6, 'b', 'good widget',  945.8, 6257],
            [2022, 1,  5, datetime.date(2022, 1,  5),  7, 'b', 'okay widget', 874.56, 8414],
            [2022, 3, 20, datetime.date(2022, 3, 20),  8, 'd', 'bad widget',  226.39, 9542],
            [2022, 1, 14, datetime.date(2022, 1, 14),  9, 'd', 'good widget', 324.57, 8296],
            [2022, 4, 10, datetime.date(2022, 4, 10), 10, 'a', 'good widget', 974.35, 1856],
            [2022, 4, 18, datetime.date(2022, 4, 18), 11, 'c', 'okay widget',  19.46, 5276],
            [2022, 2,  4, datetime.date(2022, 2,  4), 12, 'b', 'okay widget', 862.18, 6984],
            [2022, 2,  7, datetime.date(2022, 2,  7), 13, 'd', 'bad widget',   457.2, 7230],
            [2022, 3, 29, datetime.date(2022, 3, 29), 14, 'c', 'okay widget',  762.8, 8912]
        ]
        self.sample_df = self.spark.createDataFrame(
            data=sample_data,
            schema=StructType(
                [
                    StructField("year", IntegerType(), True),
                    StructField("month", IntegerType(), True),
                    StructField("day", IntegerType(), True),
                    StructField("ts", DateType(), True),
                    StructField("order_id", IntegerType(), True),
                    StructField("user", StringType(), True),
                    StructField("product", StringType(), True),
                    StructField("cost", DoubleType(), True),
                    StructField("quantity", LongType(), True)
                ]
            )
        )

        # import os, runpy
        # from os import listdir
        # for idx, package in enumerate(["instruction", "dataset", "airflow"]):
        #     path = os.path.abspath(os.path.join(os.path.dirname(__file__), "../../prophecy/cb/server/" + package))
        #     for f in listdir(path):
        #         if not f.endswith('__init__.py') and f.endswith('.py'):
        #             f = f.strip(".py")
        #             runpy._run_module_as_main(f"prophecy.gemlib.server.{package}.{f}")
        #print("setup completed")

    def get_sample_dataframe(self):
        return self.sample_df

    @cached_property
    def props_class(self) -> Union[Type[ComponentProperties], Type[DatasetProperties]]:
        assert self.test_class is not None, "test_class not defined"
        fields = map(lambda x: getattr(self.test_class, x), dir(self.test_class))
        class_fields = list(filter(lambda x: inspect.isclass(x), fields))
        properties_classes = list(filter(lambda c: ComponentProperties in inspect.getmro(c) or DatasetProperties in inspect.getmro(c), class_fields))
        assert len(properties_classes) == 1, f"Could not find ComponentProperties or DatasetProperties subclass in {self.test_class}"
        return properties_classes[0]

    @cached_property
    def code_class(self) -> Type[ComponentCode]:
        assert self.test_class is not None, "test_class not defined"
        fields = map(lambda x: getattr(self.test_class, x), dir(self.test_class))
        class_fields = list(filter(lambda x: inspect.isclass(x), fields))
        code_classes = list(filter(lambda c: ComponentCode in inspect.getmro(c), class_fields))
        assert len(code_classes) == 1, f"Could not find ComponentCode subclass in {self.test_class}"
        return code_classes[0]

    def get_component_from_element_if_applicable(self, element, portId: str, column: str, elementId: str, actionName: str,
                                                 component: Component) -> list:
        result = []
        if isinstance(element, Atom):
            if isinstance(element, PortSchema):
                print(f"{element} with id {element.id}")
            if isinstance(element, PortSchema) and elementId == element.id and actionName == "onColumnClick":
                if element.onColumnClicked is not None:
                    print(f"{element} with id {element.id}")
                    result.append(element.onColumnClicked(portId, column, component))
            if isinstance(element, PortSchema) and elementId == element.id and actionName == "onSelectAllColumns":
                if element.onAllColumnsClicked is not None:
                    print(f"{element} with id {element.id}")
                    result.append(element.onAllColumnsClicked(portId, component))
        elif isinstance(element, Container):
            for child in element.children():
                res = self.get_component_from_element_if_applicable(child, portId, column, elementId, actionName, component)
                if res is not None:
                    result.extend(res)
                if isinstance(element, Button):
                    print(f"{element} with id {element.id}")
                if isinstance(element, Button) and elementId == element.id and actionName == "onButtonClick":
                    if element.onClick is not None:
                        print(f"{element} with id {element.id}")
                        result.insert(0, element.onClick(component))
        return result

    def get_resource_path(self, *parts):
        final_path = reduce(lambda a, b: a / b, parts, self.resources_path)
        return str(final_path)


def get_schema(schemapath: str) -> StructType:
    import os
    from pathlib import Path
    # get current script's directory
    thisDir = Path(__file__).resolve().parent
    resolvedFilePath = Path(os.path.join(thisDir, schemapath)).resolve()

    with open(resolvedFilePath) as f:
        d = json.load(f)
    return StructType.fromJson(d)


sampleCustomerSchema = get_schema("../testutil/resources/schemaJsons/customerSchema.json")
defaultInputPort = NodePort(id="in0", slug="input", schema=sampleCustomerSchema)
defaultOutputPort = NodePort(id="out0", slug="output")
defaultNodeports = NodePorts(inputs=[defaultInputPort], outputs=[defaultOutputPort], selectedInputFields=[])


def get_component(props: ComponentProperties, ports=defaultNodeports):
    return Component(id="_id", component="",
                     metadata=NodeMetadata(label="label", slug="slug", x=0, y=0, language="python"),
                     properties=props,
                     ports=ports)


def get_component_from_element_if_applicable(element, portId: str, column: str, elementId: str, actionName: str,
                                             component: Component) -> list:
    result = []
    if isinstance(element, Atom):
        if isinstance(element, PortSchema):
            print(f"{element} with id {element.id}")
        if isinstance(element, PortSchema) and elementId == element.id and actionName == "onColumnClick":
            if element.onColumnClicked is not None:
                print(f"{element} with id {element.id}")
                result.append(element.onColumnClicked(portId, column, component))
        if isinstance(element, PortSchema) and elementId == element.id and actionName == "onSelectAllColumns":
            if element.onAllColumnsClicked is not None:
                print(f"{element} with id {element.id}")
                result.append(element.onAllColumnsClicked(portId, component))
    elif isinstance(element, Container):
        for child in element.children():
            res = get_component_from_element_if_applicable(child, portId, column, elementId, actionName, component)
            if res is not None:
                result.extend(res)
            if isinstance(element, Button):
                print(f"{element} with id {element.id}")
            if isinstance(element, Button) and elementId == element.id and actionName == "onButtonClick":
                if element.onClick is not None:
                    print(f"{element} with id {element.id}")
                    result.insert(0, element.onClick(component))
    return result


if __name__ == "__main__":
    unittest.main()
