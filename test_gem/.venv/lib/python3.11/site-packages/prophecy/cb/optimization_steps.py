from prophecy.cb.server.base.ComponentBuilderBase import *
from pyspark.sql import *
from pyspark.sql.functions import *
from dataclasses import dataclass, field, replace
from prophecy.cb.ui.uispec import *
from prophecy.cb.server.base.WorkflowContext import WorkflowContext, EmptyWorkflowContext


# original unoptimized apply method for reformat with while loop
def reformat(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
    @dataclass(frozen=True)
    class ReformatProperties(ComponentProperties):
        columnsSelector: List[str] = field(default_factory=list)
        expressions: List[SColumnExpression] = field(default_factory=list)

    props = ReformatProperties(expressions=[SColumnExpression(target="c5", expression=col("c5"), description=""),
                                            SColumnExpression(target="c6", expression=col("c6"), description="")])
    selectColumns = []
    i = 0
    while i < len(props.expressions):
        selectColumns.append(props.expressions[i].column())
        i += 1
    return _in.select(*selectColumns)


# original unoptimized apply method for reformat
def reformat(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
    @dataclass(frozen=True)
    class ReformatProperties(ComponentProperties):
        columnsSelector: List[str] = field(default_factory=list)
        expressions: List[SColumnExpression] = field(default_factory=list)

    props = ReformatProperties(expressions=[SColumnExpression(target="c5", expression=col("c5"), description=""),
                                            SColumnExpression(target="c6", expression=col("c6"), description="")])
    selectColumns = []
    for expression in props.expressions:
        selectColumns.append(expression.column())
    return _in.select(*selectColumns)


# variable substitution (props)
def reformat(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
    @dataclass(frozen=True)
    class ReformatProperties(ComponentProperties):
        columnsSelector: List[str] = field(default_factory=list)
        expressions: List[SColumnExpression] = field(default_factory=list)

    selectColumns = []
    for expression in ReformatProperties(
            expressions=[SColumnExpression(target="c5", expression=col("c5"), description=""),
                         SColumnExpression(target="c6", expression=col("c6"), description="")]).expressions:
        selectColumns.append(expression.column())
    return _in.select(*selectColumns)


# object attribute call evaluation
def reformat(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
    selectColumns = []
    for expression in [SColumnExpression(target="c5", expression=col("c5"), description=""),
                       SColumnExpression(target="c6", expression=col("c6"), description="")]:
        selectColumns.append(expression.column())
    return _in.select(*selectColumns)

# for loop unrolling
def reformat(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
    selectColumns = []
    expression = SColumnExpression(target="c5", expression=col("c5"), description="")
    selectColumns.append(expression.column())
    expression = SColumnExpression(target="c6", expression=col("c6"), description="")
    selectColumns.append(expression.column())
    return _in.select(*selectColumns)

# variable substitution
def reformat(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
    selectColumns = []
    selectColumns.append(SColumnExpression(target="c5", expression=col("c5"), description="").column())
    selectColumns.append(SColumnExpression(target="c6", expression=col("c6"), description="").column())
    return _in.select(*selectColumns)

# list evaluation to final list expression
def reformat(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
    selectColumns = [SColumnExpression(target="c5", expression=col("c5"), description="").column(), SColumnExpression(target="c6", expression=col("c6"), description="").column()]
    return _in.select(*selectColumns)

# variable substitution
def reformat(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
    return _in.select(*[SColumnExpression(target="c5", expression=col("c5"), description="").column(), SColumnExpression(target="c6", expression=col("c6"), description="").column()])

# column expression method replacement with expression
def reformat(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
    return _in.select(*[col("c5").alias("c5"), col("c5").alias("c5")])

# replacement list with var arg params
def reformat(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
    return _in.select(col("c5").alias("c5"), col("c5").alias("c5"))

def Aggregate(spark: SparkSession, _in: DataFrame) -> DataFrame:
    @dataclass(frozen=True)
    class AggregateProperties(ComponentProperties):
        activeTab: str = "group_by"
        columnsSelector: List[str] = field(default_factory=list)
        groupBy: List[SColumnExpression] = field(default_factory=list)
        aggregate: List[SColumnExpression] = field(default_factory=list)
        doPivot: bool = False
        pivotColumn: Column = col("c1")
        pivotValues: List[str] = field(default_factory=list)

    props = AggregateProperties(
        activeTab="Aggregate",
        columnsSelector=["c3", "c4"],
        groupBy=[SColumnExpression(target="groupbyCol", expression=col("c1"), description=""),
                 SColumnExpression(target="groupByCol_2", expression=col("c2"), description="")],
        aggregate=[SColumnExpression(target="target_code", expression=col("c5"), description=""),
                   SColumnExpression(target="target_column_2", expression=col("c6"), description="")],
        doPivot=False,
        pivotColumn=col("c2"),
        pivotValues=["cc", "ff"]
    )

    groupedColumns = []
    for expression in props.groupBy:
        groupedColumns.append(expression.column())
    grouped = _in.groupBy(*groupedColumns)
    if props.doPivot:
        if props.pivotValues and props.pivotColumn is not None:
            pivoted = grouped.pivot(props.pivotColumn, props.pivotValues)
        elif not props.pivotValues and props.pivotColumn is not None:
            pivoted = grouped.pivot(props.pivotColumn)
        else:
            pivoted = grouped
    else:
        pivoted = grouped
    return pivoted.agg(*SColumnExpression.getColumnsFromColumnExpressionList(props.aggregate))

# variable substitution
def Aggregate(spark: SparkSession, _in: DataFrame) -> DataFrame:
    @dataclass(frozen=True)
    class AggregateProperties(ComponentProperties):
        activeTab: str = "group_by"
        columnsSelector: List[str] = field(default_factory=list)
        groupBy: List[SColumnExpression] = field(default_factory=list)
        aggregate: List[SColumnExpression] = field(default_factory=list)
        doPivot: bool = False
        pivotColumn: Column = col("c1")
        pivotValues: List[str] = field(default_factory=list)

    groupedColumns = []
    for expression in AggregateProperties(
            activeTab="Aggregate",
            columnsSelector=["c3", "c4"],
            groupBy=[SColumnExpression(target="groupbyCol", expression=col("c1"), description=""),
                     SColumnExpression(target="groupByCol_2", expression=col("c2"), description="")],
            aggregate=[SColumnExpression(target="target_code", expression=col("c5"), description=""),
                       SColumnExpression(target="target_column_2", expression=col("c6"), description="")],
            doPivot=False,
            pivotColumn=col("c2"),
            pivotValues=["cc", "ff"]
    ).groupBy:
        groupedColumns.append(expression.column())
    grouped = _in.groupBy(*groupedColumns)
    if AggregateProperties(
            activeTab="Aggregate",
            columnsSelector=["c3", "c4"],
            groupBy=[SColumnExpression(target="groupbyCol", expression=col("c1"), description=""),
                     SColumnExpression(target="groupByCol_2", expression=col("c2"), description="")],
            aggregate=[SColumnExpression(target="target_code", expression=col("c5"), description=""),
                       SColumnExpression(target="target_column_2", expression=col("c6"), description="")],
            doPivot=False,
            pivotColumn=col("c2"),
            pivotValues=["cc", "ff"]
    ).doPivot:
        if AggregateProperties(
                activeTab="Aggregate",
                columnsSelector=["c3", "c4"],
                groupBy=[SColumnExpression(target="groupbyCol", expression=col("c1"), description=""),
                         SColumnExpression(target="groupByCol_2", expression=col("c2"), description="")],
                aggregate=[SColumnExpression(target="target_code", expression=col("c5"), description=""),
                           SColumnExpression(target="target_column_2", expression=col("c6"), description="")],
                doPivot=False,
                pivotColumn=col("c2"),
                pivotValues=["cc", "ff"]
        ).pivotValues and AggregateProperties(
            activeTab="Aggregate",
            columnsSelector=["c3", "c4"],
            groupBy=[SColumnExpression(target="groupbyCol", expression=col("c1"), description=""),
                     SColumnExpression(target="groupByCol_2", expression=col("c2"), description="")],
            aggregate=[SColumnExpression(target="target_code", expression=col("c5"), description=""),
                       SColumnExpression(target="target_column_2", expression=col("c6"), description="")],
            doPivot=False,
            pivotColumn=col("c2"),
            pivotValues=["cc", "ff"]
        ).pivotColumn is not None:
            pivoted = grouped.pivot(AggregateProperties(
                activeTab="Aggregate",
                columnsSelector=["c3", "c4"],
                groupBy=[SColumnExpression(target="groupbyCol", expression=col("c1"), description=""),
                         SColumnExpression(target="groupByCol_2", expression=col("c2"), description="")],
                aggregate=[SColumnExpression(target="target_code", expression=col("c5"), description=""),
                           SColumnExpression(target="target_column_2", expression=col("c6"), description="")],
                doPivot=False,
                pivotColumn=col("c2"),
                pivotValues=["cc", "ff"]
            ).pivotColumn, AggregateProperties(
                activeTab="Aggregate",
                columnsSelector=["c3", "c4"],
                groupBy=[SColumnExpression(target="groupbyCol", expression=col("c1"), description=""),
                         SColumnExpression(target="groupByCol_2", expression=col("c2"), description="")],
                aggregate=[SColumnExpression(target="target_code", expression=col("c5"), description=""),
                           SColumnExpression(target="target_column_2", expression=col("c6"), description="")],
                doPivot=False,
                pivotColumn=col("c2"),
                pivotValues=["cc", "ff"]
            ).pivotValues)
        elif not AggregateProperties(
                activeTab="Aggregate",
                columnsSelector=["c3", "c4"],
                groupBy=[SColumnExpression(target="groupbyCol", expression=col("c1"), description=""),
                         SColumnExpression(target="groupByCol_2", expression=col("c2"), description="")],
                aggregate=[SColumnExpression(target="target_code", expression=col("c5"), description=""),
                           SColumnExpression(target="target_column_2", expression=col("c6"), description="")],
                doPivot=False,
                pivotColumn=col("c2"),
                pivotValues=["cc", "ff"]
        ).pivotValues and AggregateProperties(
            activeTab="Aggregate",
            columnsSelector=["c3", "c4"],
            groupBy=[SColumnExpression(target="groupbyCol", expression=col("c1"), description=""),
                     SColumnExpression(target="groupByCol_2", expression=col("c2"), description="")],
            aggregate=[SColumnExpression(target="target_code", expression=col("c5"), description=""),
                       SColumnExpression(target="target_column_2", expression=col("c6"), description="")],
            doPivot=False,
            pivotColumn=col("c2"),
            pivotValues=["cc", "ff"]
        ).pivotColumn is not None:
            pivoted = grouped.pivot(AggregateProperties(
                activeTab="Aggregate",
                columnsSelector=["c3", "c4"],
                groupBy=[SColumnExpression(target="groupbyCol", expression=col("c1"), description=""),
                         SColumnExpression(target="groupByCol_2", expression=col("c2"), description="")],
                aggregate=[SColumnExpression(target="target_code", expression=col("c5"), description=""),
                           SColumnExpression(target="target_column_2", expression=col("c6"), description="")],
                doPivot=False,
                pivotColumn=col("c2"),
                pivotValues=["cc", "ff"]
            ).pivotColumn)
        else:
            pivoted = grouped
    else:
        pivoted = grouped
    return pivoted.agg(*SColumnExpression.getColumnsFromColumnExpressionList(AggregateProperties(
        activeTab="Aggregate",
        columnsSelector=["c3", "c4"],
        groupBy=[SColumnExpression(target="groupbyCol", expression=col("c1"), description=""),
                 SColumnExpression(target="groupByCol_2", expression=col("c2"), description="")],
        aggregate=[SColumnExpression(target="target_code", expression=col("c5"), description=""),
                   SColumnExpression(target="target_column_2", expression=col("c6"), description="")],
        doPivot=False,
        pivotColumn=col("c2"),
        pivotValues=["cc", "ff"]
    ).aggregate))


# object attribute call evaluation
def Aggregate(spark: SparkSession, _in: DataFrame) -> DataFrame:
    groupedColumns = []
    for expression in [SColumnExpression(target="groupbyCol", expression=col("c1"), description=""),
                       SColumnExpression(target="groupByCol_2", expression=col("c2"), description="")]:
        groupedColumns.append(expression.column())
    grouped = _in.groupBy(*groupedColumns)
    if True:
        if ["cc", "ff"] and col("c2") is not None:
            pivoted = grouped.pivot(col("c2"), ["cc", "ff"])
        elif not ["cc", "ff"] and col("c2") is not None:
            pivoted = grouped.pivot(col("c2"))
        else:
            pivoted = grouped
    else:
        pivoted = grouped
    return pivoted.agg(*SColumnExpression.getColumnsFromColumnExpressionList(
        [SColumnExpression(target="target_code", expression=col("c5"), description=""),
         SColumnExpression(target="target_column_2", expression=col("c6"), description="")]))


# For Loop Unrolling
def Aggregate(spark: SparkSession, _in: DataFrame) -> DataFrame:
    groupedColumns = []
    expression = SColumnExpression(target="groupbyCol", expression=col("c1"), description="")
    groupedColumns.append(expression.column())
    expression = SColumnExpression(target="groupByCol_2", expression=col("c2"), description="")
    groupedColumns.append(expression.column())
    grouped = _in.groupBy(*groupedColumns)
    if True:
        if ["cc", "ff"] and col("c2") is not None:
            pivoted = grouped.pivot(col("c2"), ["cc", "ff"])
        elif not ["cc", "ff"] and col("c2") is not None:
            pivoted = grouped.pivot(col("c2"))
        else:
            pivoted = grouped
    else:
        pivoted = grouped
    return pivoted.agg(*SColumnExpression.getColumnsFromColumnExpressionList(
        [SColumnExpression(target="target_code", expression=col("c5"), description=""),
         SColumnExpression(target="target_column_2", expression=col("c6"), description="")]))


# if else condition evaluation
def Aggregate(spark: SparkSession, _in: DataFrame) -> DataFrame:
    groupedColumns = []
    expression = SColumnExpression(target="groupbyCol", expression=col("c1"), description="")
    groupedColumns.append(expression.column())
    expression = SColumnExpression(target="groupByCol_2", expression=col("c2"), description="")
    groupedColumns.append(expression.column())
    grouped = _in.groupBy(*groupedColumns)
    pivoted = grouped.pivot(col("c2"), ["cc", "ff"])
    return pivoted.agg(*SColumnExpression.getColumnsFromColumnExpressionList(
        [SColumnExpression(target="target_code", expression=col("c5"), description=""),
         SColumnExpression(target="target_column_2", expression=col("c6"), description="")]))


# variable substitution
def Aggregate(spark: SparkSession, _in: DataFrame) -> DataFrame:
    groupedColumns = []
    groupedColumns.append(SColumnExpression(target="groupbyCol", expression=col("c1"), description="").column())
    groupedColumns.append(SColumnExpression(target="groupByCol_2", expression=col("c2"), description="").column())
    return _in.groupBy(*groupedColumns).pivot(col("c2"), ["cc", "ff"]).agg(
        *SColumnExpression.getColumnsFromColumnExpressionList(
            [SColumnExpression(target="target_code", expression=col("c5"), description=""),
             SColumnExpression(target="target_column_2", expression=col("c6"), description="")]))


# list evaluation to final list expression
def Aggregate(spark: SparkSession, _in: DataFrame) -> DataFrame:
    groupedColumns = [SColumnExpression(target="groupbyCol", expression=col("c1"), description="").column(),
                      SColumnExpression(target="groupByCol_2", expression=col("c2"), description="").column()]
    return _in.groupBy(*groupedColumns).pivot(col("c2"), ["cc", "ff"]).agg(
        *SColumnExpression.getColumnsFromColumnExpressionList(
            [SColumnExpression(target="target_code", expression=col("c5"), description=""),
             SColumnExpression(target="target_column_2", expression=col("c6"), description="")]))


# evaluation of ColumnExpression class function calls and replacement with result
def Aggregate(spark: SparkSession, _in: DataFrame) -> DataFrame:
    groupedColumns = [col("c1").alias("groupbyCol"), col("c2").alias("groupByCol_2")]
    return _in.groupBy(*groupedColumns).pivot(col("c2"), ["cc", "ff"]).agg(*[col("c5"), col("c6")])


# variable substitution
def Aggregate(spark: SparkSession, _in: DataFrame) -> DataFrame:
    return _in.groupBy(*[col("c1").alias("groupbyCol"), col("c2").alias("groupByCol_2")]).pivot(col("c2"),
                                                                                                ["cc", "ff"]).agg(
        *[col("c5"), col("c6")])


# replacement of *list with var arg params
def Aggregate(spark: SparkSession, _in: DataFrame) -> DataFrame:
    return _in.groupBy(col("c1").alias("groupbyCol"), col("c2").alias("groupByCol_2")).pivot(col("c2"),
                                                                                             ["cc", "ff"]).agg(
        col("c5"), col("c6"))


class Transformation(ABC):
    pass


@singleton
class SchemaTransform(ComponentSpec):
    name: str = "SchemaTransformer"
    category: str = "Transform"

    def optimizeCode(self) -> bool:
        return False

    @dataclass(frozen=True)
    class AddReplaceColumn(Transformation):
        sourceColumn: str = "column"
        expression: Column = col("expression")

    @dataclass(frozen=True)
    class RenameColumn(Transformation):
        sourceColumn: str = ""
        targetColumn: str = ""

    @dataclass(frozen=True)
    class DropColumn(Transformation):
        sourceColumn: str = ""

    @dataclass(frozen=True)
    class SchemaTransformerProperties(ComponentProperties):
        transformations: List[Transformation] = field(default_factory=list)

    def onClickFunc(self, state: Component[SchemaTransformerProperties]):
        state.properties.transformations.append(SchemaTransform.AddReplaceColumn("new_col", col("new_col")))
        return replace(state, properties=replace(state.properties, transformations=state.properties.transformations))

    def dialog(self) -> Dialog:
        addReplaceColumn = Condition("EQUAL", PropExpr("record.kind"), StringExpr("AddReplaceColumn")).addElement(
            ColumnsLayout("1rem").addElement(
                ColumnLayout().addElement(
                    SelectBox("Operation").addOption("Add/Replace Column", "AddReplaceColumn")
                        .addOption("Drop Column", "DropColumn")
                        .addOption("Rename Column", "RenameColumn").bindProperty("record.kind")
                )
            ).addElement(ColumnLayout().addElement(
                TextBox("New Column").bindProperty("record.AddReplaceColumn.expression.expression")))
                .addElement(ColumnLayout("content").addElement(ListItemDelete("delete")))
        )
        dropColumn = Condition("EQUAL", PropExpr("record.kind"), StringExpr("DropColumn")).addElement(
            ColumnsLayout("1rem").addElement(ColumnLayout().addElement(
                SelectBox("Operation").addOption("Add/Replace Column", "AddReplaceColumn")
                    .addOption("Drop Column", "DropColumn").addOption("Rename Column", "RenameColumn").bindProperty(
                    "record.kind")
            )).addElement(
                ColumnLayout().addElement(TextBox("Drop Column").bindProperty("record.DropColumn.sourceColumn")))
                .addElement(ColumnLayout("content").addElement(ListItemDelete("delete")))
        )
        renameColumn = Condition("EQUAL", PropExpr("record.kind"), StringExpr("RenameColumn")).addElement(
            ColumnsLayout("1rem").addElement(ColumnLayout().addElement(
                SelectBox("Operation").addOption("Add/Replace Column", "AddReplaceColumn").addOption("Drop Column",
                                                                                                     "DropColumn")
                    .addOption("Rename Column", "RenameColumn").bindProperty("record.kind"))).addElement(
                ColumnLayout().addElement(TextBox("Source Column").bindProperty("record.RenameColumn.sourceColumn"))
                    .addElement(ColumnLayout().addElement(
                    TextBox("Target Column").bindProperty("record.RenameColumn.targetColumn")))
                    .addElement(ColumnLayout("content").addElement(ListItemDelete("delete")))
            )
        )
        return Dialog("Schema Transformer").addElement(
            ColumnsLayout().addElement(ColumnLayout("2fr").addElement(
                Tabs().addTabPane(TabPane("Input", "Input").addElement(PortSchema().asInput()))
                    .addTabPane(TabPane("Output", "Output").addElement(PortSchema().asOutput()))
            )).addElement(
                ColumnLayout("4fr").addElement(StackLayout("1rem").addElement(
                    OrderedList("Transformations").bindProperty("transformations")
                        .addElement(addReplaceColumn)
                        .addElement(dropColumn)
                        .addElement(renameColumn)
                ).addElement(
                    StackLayout(alignY="start").addElement(
                        Button("Add Transformation").bindOnClick(self.onClickFunc).addElement(
                            NativeText("Add Transformation")))
                )
                )
            )
        )

    def validate(self, context: WorkflowContext, component: Component[SchemaTransformerProperties]) -> List[Diagnostic]:
        return []

    def onChange(self, context: WorkflowContext, oldState: Component[SchemaTransformerProperties],
                 newState: Component[SchemaTransformerProperties]) -> Component[
        SchemaTransformerProperties]:
        return newState

    class SchemaTransformerCode(ComponentCode):
        def __init__(self, newProps):
            self.props: SchemaTransform.SchemaTransformerProperties = newProps

        # Unoptimized version of apply method
        def apply(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
            props = SchemaTransform().SchemaTransformerProperties(
                transformations=[SchemaTransform().DropColumn(sourceColumn="d"),
                                 SchemaTransform().RenameColumn(sourceColumn="d", targetColumn="e"),
                                 SchemaTransform().AddReplaceColumn(sourceColumn="d", expression=col("expression2"))]
            )
            curDF = _in
            for curProp in props.transformations:
                if isinstance(curProp, SchemaTransform().AddReplaceColumn):
                    curDF = curDF.withColumn(curProp.sourceColumn, curProp.expression)
                elif isinstance(curProp, SchemaTransform().RenameColumn):
                    curDF = curDF.withColumnRenamed(curProp.sourceColumn, curProp.targetColumn)
                else:
                    curDF = curDF.drop(curProp.sourceColumn)
            return curDF

        # variable substitution (props)
        def apply(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
            curDF = _in
            for curProp in SchemaTransform().SchemaTransformerProperties(
                    transformations=[SchemaTransform().DropColumn(sourceColumn="d"),
                                     SchemaTransform().RenameColumn(sourceColumn="d", targetColumn="e"),
                                     SchemaTransform().AddReplaceColumn(sourceColumn="d",
                                                                        expression=col("expression2"))]
            ).transformations:
                if isinstance(curProp, SchemaTransform().AddReplaceColumn):
                    curDF = curDF.withColumn(curProp.sourceColumn, curProp.expression)
                elif isinstance(curProp, SchemaTransform().RenameColumn):
                    curDF = curDF.withColumnRenamed(curProp.sourceColumn, curProp.targetColumn)
                else:
                    curDF = curDF.drop(curProp.sourceColumn)
            return curDF

        # object attribute call evaluation
        def apply(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
            curDF = _in
            for curProp in [SchemaTransform().DropColumn(sourceColumn="d"),
                            SchemaTransform().RenameColumn(sourceColumn="d", targetColumn="e"),
                            SchemaTransform().AddReplaceColumn(sourceColumn="d",
                                                               expression=col("expression2"))]:
                if isinstance(curProp, SchemaTransform().AddReplaceColumn):
                    curDF = curDF.withColumn(curProp.sourceColumn, curProp.expression)
                elif isinstance(curProp, SchemaTransform().RenameColumn):
                    curDF = curDF.withColumnRenamed(curProp.sourceColumn, curProp.targetColumn)
                else:
                    curDF = curDF.drop(curProp.sourceColumn)
            return curDF

        # For Loop Unrolling
        def apply(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
            curDF = _in
            curProp = SchemaTransform().DropColumn(sourceColumn="d")
            if isinstance(curProp, SchemaTransform().AddReplaceColumn):
                curDF = curDF.withColumn(curProp.sourceColumn, curProp.expression)
            elif isinstance(curProp, SchemaTransform().RenameColumn):
                curDF = curDF.withColumnRenamed(curProp.sourceColumn, curProp.targetColumn)
            else:
                curDF = curDF.drop(curProp.sourceColumn)
            curProp = SchemaTransform().RenameColumn(sourceColumn="d", targetColumn="e")
            if isinstance(curProp, SchemaTransform().AddReplaceColumn):
                curDF = curDF.withColumn(curProp.sourceColumn, curProp.expression)
            elif isinstance(curProp, SchemaTransform().RenameColumn):
                curDF = curDF.withColumnRenamed(curProp.sourceColumn, curProp.targetColumn)
            else:
                curDF = curDF.drop(curProp.sourceColumn)
            curProp = SchemaTransform().AddReplaceColumn(sourceColumn="d", expression=col("expression2"))
            if isinstance(curProp, SchemaTransform().AddReplaceColumn):
                curDF = curDF.withColumn(curProp.sourceColumn, curProp.expression)
            elif isinstance(curProp, SchemaTransform().RenameColumn):
                curDF = curDF.withColumnRenamed(curProp.sourceColumn, curProp.targetColumn)
            else:
                curDF = curDF.drop(curProp.sourceColumn)
            return curDF

        # variable substitution (curProp)
        def apply(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
            curDF = _in
            if isinstance(SchemaTransform().DropColumn(sourceColumn="d"), SchemaTransform().AddReplaceColumn):
                curDF = curDF.withColumn(SchemaTransform().DropColumn(sourceColumn="d").sourceColumn,
                                         SchemaTransform().DropColumn(sourceColumn="d").expression)
            elif isinstance(SchemaTransform().DropColumn(sourceColumn="d"), SchemaTransform().RenameColumn):
                curDF = curDF.withColumnRenamed(SchemaTransform().DropColumn(sourceColumn="d").sourceColumn,
                                                SchemaTransform().DropColumn(sourceColumn="d").targetColumn)
            else:
                curDF = curDF.drop(SchemaTransform().DropColumn(sourceColumn="d").sourceColumn)
            if isinstance(SchemaTransform().RenameColumn(sourceColumn="d", targetColumn="e"),
                          SchemaTransform().AddReplaceColumn):
                curDF = curDF.withColumn(
                    SchemaTransform().RenameColumn(sourceColumn="d", targetColumn="e").sourceColumn,
                    SchemaTransform().RenameColumn(sourceColumn="d", targetColumn="e").expression)
            elif isinstance(SchemaTransform().RenameColumn(sourceColumn="d", targetColumn="e"),
                            SchemaTransform().RenameColumn):
                curDF = curDF.withColumnRenamed(
                    SchemaTransform().RenameColumn(sourceColumn="d", targetColumn="e").sourceColumn,
                    SchemaTransform().RenameColumn(sourceColumn="d", targetColumn="e").targetColumn)
            else:
                curDF = curDF.drop(SchemaTransform().RenameColumn(sourceColumn="d", targetColumn="e").sourceColumn)
            if isinstance(SchemaTransform().AddReplaceColumn(sourceColumn="d", expression=col("expression2")),
                          SchemaTransform().AddReplaceColumn):
                curDF = curDF.withColumn(
                    SchemaTransform().AddReplaceColumn(sourceColumn="d", expression=col("expression2")).sourceColumn,
                    SchemaTransform().AddReplaceColumn(sourceColumn="d", expression=col("expression2")).expression)
            elif isinstance(SchemaTransform().AddReplaceColumn(sourceColumn="d", expression=col("expression2")),
                            SchemaTransform().RenameColumn):
                curDF = curDF.withColumnRenamed(
                    SchemaTransform().AddReplaceColumn(sourceColumn="d", expression=col("expression2")).sourceColumn,
                    SchemaTransform().AddReplaceColumn(sourceColumn="d", expression=col("expression2")).targetColumn)
            else:
                curDF = curDF.drop(
                    SchemaTransform().AddReplaceColumn(sourceColumn="d", expression=col("expression2")).sourceColumn)
            return curDF

            # if else condition evaluation  and dead code removal
            def apply(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
                curDF = _in
                curDF = curDF.drop(SchemaTransform().DropColumn(sourceColumn="d").sourceColumn)
                curDF = curDF.withColumnRenamed(
                    SchemaTransform().RenameColumn(sourceColumn="d", targetColumn="e").sourceColumn,
                    SchemaTransform().RenameColumn(sourceColumn="d", targetColumn="e").targetColumn)
                curDF = curDF.withColumn(
                    SchemaTransform().AddReplaceColumn(sourceColumn="d", expression=col("expression2")).sourceColumn,
                    SchemaTransform().AddReplaceColumn(sourceColumn="d", expression=col("expression2")).expression)
                return curDF

        # object attribute call evaluation
        def apply(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
            curDF = _in
            curDF = curDF.drop("d")
            curDF = curDF.withColumnRenamed("d", "e")
            curDF = curDF.withColumn("d", col("expression2"))
            return curDF

        # variable substitution
        def apply(self, spark: SparkSession, _in: DataFrame) -> DataFrame:
            return _in.drop("d").withColumnRenamed("d", "e").withColumn("d", col("expression2"))
