from typing import List
import pyparsing as pp
from pyparsing import CharsNotIn, \
    QuotedString, \
    OneOrMore, \
    delimited_list, \
    ParseException, \
    Combine, \
    White, \
    Word
from pyparsing.exceptions import ParseException as CSVParseException

def get_import_parser(delim=',', multiline_escape="``", field_min=None, field_max=None):
    #pp.enable_diag(pp.Diagnostics.enable_debug_on_named_expressions)
    pp.ParserElement.set_default_whitespace_chars("")
    csv_field =  QuotedString(quote_char=multiline_escape, esc_char="\\", multiline=True).set_name("Quoted String") | \
        Combine(OneOrMore( 
            Word(pp.printables, exclude_chars=',') | \
            White(ws=" \t")
        )).set_name("Unquoted field")
    csv_field = csv_field.set_name("CSV Field")
    field_list = delimited_list(csv_field, delim=delim, allow_trailing_delim=True, min=field_min, max=field_max).set_name("CSV Field list")
    csv_line = pp.Group(field_list)
    return delimited_list(csv_line, delim=pp.LineEnd(), allow_trailing_delim=True)


def parse_escaped_csv(input, delimiter=',', multiline_escape="``", field_min=None, field_max=None) -> List[List[str]]:
    """
        Special escaped CSV parser. Supports multiline escaping using ``
    """
    input = input.replace("\r", "")
    res = get_import_parser(delimiter, multiline_escape, field_min=field_min, field_max=field_max).parse_string(input, parse_all=True).as_list()
    if len(res):
        if not isinstance(res[0], list):
            res = [res]

    return res
        

def unparse_escaped_csv(rows: List[List[str]], multiline_escape="``", multiline_triggers=[",", "\n"]) -> str:
    output = ""
    for row in rows:
        output_cols = []
        for col in row:
            col = col.strip()
            if any(map(lambda t: t in col, multiline_triggers)) and not col.startswith(multiline_escape):
                output_cols.append(f"{multiline_escape}{col}{multiline_escape}")
            else:
                output_cols.append(col)
        output += ",".join(output_cols) + "\n"
    output = output.replace("\r", "")
    return output.strip()
